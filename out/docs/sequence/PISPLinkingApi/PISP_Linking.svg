<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="9003px" preserveAspectRatio="none" style="width:3517px;height:9003px;" version="1.1" viewBox="0 0 3517 9003" width="3517px" zoomAndPan="magnify"><defs><filter height="300%" id="f12un5mu44osrr" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="140" x="1685.25" y="28.708">PISP Pre-linking</text><rect fill="#DDDDDD" height="8956.4688" style="stroke:#A80036;stroke-width:1.0;" width="1008.5" x="502.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="916.75" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="8956.4688" style="stroke:#A80036;stroke-width:1.0;" width="73" x="1825" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="1828" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="8956.4688" style="stroke:#A80036;stroke-width:1.0;" width="564" x="2136" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="2325" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="1782.1641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="61.5" y="169.6484"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="370.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="61.5" y="2024.0781"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="1674.5" style="stroke:#A80036;stroke-width:1.0;" width="10" x="61.5" y="2499.9375"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="2277.9453" style="stroke:#A80036;stroke-width:1.0;" width="10" x="61.5" y="4279.8359"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="2277.9453" style="stroke:#A80036;stroke-width:1.0;" width="10" x="61.5" y="6663.1797"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="1782.1641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="568.5" y="169.6484"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="370.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="568.5" y="2024.0781"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="1674.5" style="stroke:#A80036;stroke-width:1.0;" width="10" x="568.5" y="2499.9375"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="2277.9453" style="stroke:#A80036;stroke-width:1.0;" width="10" x="568.5" y="4279.8359"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="2277.9453" style="stroke:#A80036;stroke-width:1.0;" width="10" x="568.5" y="6663.1797"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="190.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="349.3125"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="146.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="775.4375"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="213.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="1216.6953"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="213.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="1709.4844"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="194.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="2170.6094"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="196.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="2571.2031"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="3493.1172"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="4083.0391"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="408.7891" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="4550.6953"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="5622.2031"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="6437.25"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="408.7891" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="6934.0391"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="8005.5469"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="8820.5938"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="235.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="540.1094"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="265.5938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="951.1016"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="250.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="1459.0234"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="3434.8516"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="4024.7734"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="5563.9375"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="6378.9844"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="7947.2813"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="8762.3281"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="235.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="510.9766"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="236.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="951.1016"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="221.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="1459.0234"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="150.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="2675.6016"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="3376.5859"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="3966.5078"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="362.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="4655.0938"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="361.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="5260.6797"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="452.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="5984.9297"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="362.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="7038.4375"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="361.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="7644.0234"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="452.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="8368.2734"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="178.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2196.5" y="2797.2656"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="272.0625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2196.5" y="4988.6172"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="242.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2196.5" y="5742.7344"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="272.0625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2196.5" y="7371.9609"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="242.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2196.5" y="8126.0781"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="429.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="2976.1953"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="411.125" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="3584.5156"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="509.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="5054.8828"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="499.4531" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="5879.5313"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="509.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="7438.2266"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="499.4531" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="8262.875"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="105.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3128.5" y="5126.1484"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="105.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3128.5" y="7509.4922"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="66" x2="66" y1="95.3828" y2="8959.125"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="573.5" x2="573.5" y1="95.3828" y2="8959.125"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="986.5" x2="986.5" y1="95.3828" y2="8959.125"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1445" x2="1445" y1="95.3828" y2="8959.125"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1861" x2="1861" y1="95.3828" y2="8959.125"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2201" x2="2201" y1="95.3828" y2="8959.125"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2623" x2="2623" y1="95.3828" y2="8959.125"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3133" x2="3133" y1="95.3828" y2="8959.125"/><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="10" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="17" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="10" y="8958.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="17" y="8978.1201">PISP Backend</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="506.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="513.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="506.5" y="8958.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="513.5" y="8978.1201">outbound-server</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="917.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="924.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="917.5" y="8958.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="924.5" y="8978.1201">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1384" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1391" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1384" y="8958.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1391" y="8978.1201">inbound-server</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="1830" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="1837" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="1830" y="8958.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="1837" y="8978.1201">Switch</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="2140" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2147" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="2140" y="8958.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2147" y="8978.1201">inbound-server</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="2551" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="2558" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="2551" y="8958.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="2558" y="8978.1201">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="3041" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="3048" y="80.0811">DFSPAuthorizeSimulator</text><rect fill="#FEFECE" filter="url(#f12un5mu44osrr)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="3041" y="8958.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="3048" y="8978.1201">DFSPAuthorizeSimulator</text><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="1782.1641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="61.5" y="169.6484"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="370.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="61.5" y="2024.0781"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="1674.5" style="stroke:#A80036;stroke-width:1.0;" width="10" x="61.5" y="2499.9375"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="2277.9453" style="stroke:#A80036;stroke-width:1.0;" width="10" x="61.5" y="4279.8359"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="2277.9453" style="stroke:#A80036;stroke-width:1.0;" width="10" x="61.5" y="6663.1797"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="1782.1641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="568.5" y="169.6484"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="370.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="568.5" y="2024.0781"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="1674.5" style="stroke:#A80036;stroke-width:1.0;" width="10" x="568.5" y="2499.9375"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="2277.9453" style="stroke:#A80036;stroke-width:1.0;" width="10" x="568.5" y="4279.8359"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="2277.9453" style="stroke:#A80036;stroke-width:1.0;" width="10" x="568.5" y="6663.1797"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="190.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="349.3125"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="146.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="775.4375"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="213.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="1216.6953"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="213.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="1709.4844"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="194.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="2170.6094"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="196.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="2571.2031"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="3493.1172"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="4083.0391"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="408.7891" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="4550.6953"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="5622.2031"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="6437.25"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="408.7891" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="6934.0391"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="8005.5469"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="981.5" y="8820.5938"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="235.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="540.1094"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="265.5938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="951.1016"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="250.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="1459.0234"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="3434.8516"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="4024.7734"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="5563.9375"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="6378.9844"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="7947.2813"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1440.5" y="8762.3281"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="235.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="510.9766"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="236.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="951.1016"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="221.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="1459.0234"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="150.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="2675.6016"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="3376.5859"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="3966.5078"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="362.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="4655.0938"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="361.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="5260.6797"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="452.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="5984.9297"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="362.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="7038.4375"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="361.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="7644.0234"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="452.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1856.5" y="8368.2734"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="178.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2196.5" y="2797.2656"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="272.0625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2196.5" y="4988.6172"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="242.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2196.5" y="5742.7344"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="272.0625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2196.5" y="7371.9609"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="242.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2196.5" y="8126.0781"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="429.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="2976.1953"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="411.125" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="3584.5156"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="509.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="5054.8828"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="499.4531" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="5879.5313"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="509.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="7438.2266"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="499.4531" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2618.5" y="8262.875"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="105.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3128.5" y="5126.1484"/><rect fill="#FFFFFF" filter="url(#f12un5mu44osrr)" height="105.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3128.5" y="7509.4922"/><rect fill="#EEEEEE" filter="url(#f12un5mu44osrr)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="3510.5" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3510.5" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3510.5" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#f12un5mu44osrr)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="102" x="1704.25" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="83" x="1710.25" y="131.4497">Pre-Linking</text><polygon fill="#A80036" points="556.5,165.6484,566.5,169.6484,556.5,173.6484,560.5,169.6484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="71.5" x2="562.5" y1="169.6484" y2="169.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="78.5" y="164.5825">PRELINKING-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="184.5" y="164.5825">GET /linking/get-dfsps</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="405" x="583" y="182.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="397" x="587" y="198.7153">We will need a uuid from the start of the model to link all steps</text><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="620.5" y1="231.9141" y2="231.9141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="620.5" x2="620.5" y1="231.9141" y2="244.9141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="579.5" x2="620.5" y1="244.9141" y2="244.9141"/><polygon fill="#A80036" points="589.5,240.9141,579.5,244.9141,589.5,248.9141,585.5,244.9141" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="585.5" y="226.8481">PRELINKING-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="691.5" y="226.8481">const uuid = uuidv4() ex: 6789</text><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="620.5" y1="274.0469" y2="274.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="620.5" x2="620.5" y1="274.0469" y2="287.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="579.5" x2="620.5" y1="287.0469" y2="287.0469"/><polygon fill="#A80036" points="589.5,283.0469,579.5,287.0469,589.5,291.0469,585.5,287.0469" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="585.5" y="268.981">PRELINKING-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="691.5" y="268.981">const model = await create()</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="583" y="300.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="587" y="316.1138">state: start</text><polygon fill="#A80036" points="969.5,345.3125,979.5,349.3125,969.5,353.3125,973.5,349.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="975.5" y1="349.3125" y2="349.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="585.5" y="344.2466">PRELINKING-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="691.5" y="344.2466">model.getThirdpartyEnabledDFSPs()</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="229" x="996" y="362.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="1000" y="378.3794">state: requestEnabledDFSPLookup</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="426.7109" y2="426.7109"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="426.7109" y2="439.7109"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="439.7109" y2="439.7109"/><polygon fill="#A80036" points="1002.5,435.7109,992.5,439.7109,1002.5,443.7109,998.5,439.7109" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="998.5" y="414.0786">PRELINKING-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="1104.5" y="406.5122">Check cache.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="1104.5" y="421.645">DFSPs not stored in cache or cache is stale.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="468.8438" y2="468.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="468.8438" y2="481.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="481.8438" y2="481.8438"/><polygon fill="#A80036" points="1002.5,477.8438,992.5,481.8438,1002.5,485.8438,998.5,481.8438" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="998.5" y="463.7778">PRELINKING-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="1104.5" y="463.7778">ThirdpartyRequests.getServicesById()</text><polygon fill="#A80036" points="1844.5,506.9766,1854.5,510.9766,1844.5,514.9766,1848.5,510.9766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1850.5" y1="510.9766" y2="510.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="998.5" y="505.9106">PRELINKING-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="1104.5" y="505.9106">GET /services/THIRD_PARTY_DFSP</text><polygon fill="#A80036" points="997.5,536.1094,987.5,540.1094,997.5,544.1094,993.5,540.1094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="991.5" x2="1855.5" y1="540.1094" y2="540.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="1003.5" y="535.0435">PRELINKING-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1109.5" y="535.0435">202 Accepted</text><path d="M25,553.1094 L25,578.1094 L1903,578.1094 L1903,563.1094 L1893,553.1094 L25,553.1094 " fill="#FBFB77" filter="url(#f12un5mu44osrr)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1893,553.1094 L1893,563.1094 L1903,563.1094 L1893,553.1094 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="322" x="796.5" y="570.1763">HAPPY_SCENARIO: Switch returns a non-empty list</text><polygon fill="#A80036" points="1461.5,604.375,1451.5,608.375,1461.5,612.375,1457.5,608.375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1455.5" x2="1855.5" y1="608.375" y2="608.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="1467.5" y="603.3091">PRELINKING-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="1573.5" y="603.3091">PUT /services/THIRD_PARTY_DFSP</text><rect fill="#ADD8E6" filter="url(#f12un5mu44osrr)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="222" x="1629" y="621.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="1633" y="637.4419">PUT /services/THIRD_PARTY_DFSP</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1633" y="652.5747">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="1641" y="667.7075">serviceProviders: [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="1649" y="682.8403">"dfspa", "dfspb"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="5" x="1641" y="697.9731">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1633" y="713.106">}</text><polygon fill="#A80036" points="1849.5,742.3047,1859.5,746.3047,1849.5,750.3047,1853.5,746.3047" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1450.5" x2="1855.5" y1="746.3047" y2="746.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="1457.5" y="741.2388">PRELINKING-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1572.5" y="741.2388">200 OK</text><polygon fill="#A80036" points="1002.5,771.4375,992.5,775.4375,1002.5,779.4375,998.5,775.4375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="996.5" x2="1444.5" y1="775.4375" y2="775.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="1008.5" y="770.3716">PRELINKING-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="1123.5" y="770.3716">Services request recieved</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="804.5703" y2="804.5703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="804.5703" y2="817.5703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="817.5703" y2="817.5703"/><polygon fill="#A80036" points="1002.5,813.5703,992.5,817.5703,1002.5,821.5703,998.5,817.5703" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="998.5" y="799.5044">PRELINKING-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="1113.5" y="799.5044">Store DFSPs in cache</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="846.7031" y2="846.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="846.7031" y2="859.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="859.7031" y2="859.7031"/><polygon fill="#A80036" points="1002.5,855.7031,992.5,859.7031,1002.5,863.7031,998.5,859.7031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="998.5" y="841.6372">PRELINKING-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="1113.5" y="841.6372">Store DFSPs in model data</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="233" x="996" y="872.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="1000" y="888.77">state: enabledDFSPLookupSuccess</text><polygon fill="#A80036" points="589.5,917.9688,579.5,921.9688,589.5,925.9688,585.5,921.9688" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="985.5" y1="921.9688" y2="921.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="595.5" y="916.9028">PRELINKING-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="710.5" y="916.9028">return TPEnabledDFSPs</text><polygon fill="#A80036" points="82.5,947.1016,72.5,951.1016,82.5,955.1016,78.5,951.1016" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="76.5" x2="567.5" y1="951.1016" y2="951.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="88.5" y="946.0356">PRELINKING-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="203.5" y="946.0356">200 OK TPEnabledDFSPs</text><path d="M25,964.1016 L25,1004.1016 L1903,1004.1016 L1903,974.1016 L1893,964.1016 L25,964.1016 " fill="#FBFB77" filter="url(#f12un5mu44osrr)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1893,964.1016 L1893,974.1016 L1903,974.1016 L1893,964.1016 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296" x="790.5" y="981.1685">ERROR_SCENARIO: Switch receives 7201 error.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="790.5" y="996.3013">NOTE: What microservice is handling service lookup?</text><polygon fill="#A80036" points="1461.5,1030.5,1451.5,1034.5,1461.5,1038.5,1457.5,1034.5" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1455.5" x2="1855.5" y1="1034.5" y2="1034.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="1467.5" y="1029.4341">PRELINKING-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="1582.5" y="1029.4341">PUT /services/THIRD_PARTY_DFSP/error</text><rect fill="#F08080" filter="url(#f12un5mu44osrr)" height="113" style="stroke:#A80036;stroke-width:1.0;" width="348" x="1503" y="1047.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="1507" y="1063.5669">PUT /services/THIRD_PARTY_DFSP/error</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1507" y="1078.6997">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="1515" y="1093.8325">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1523" y="1108.9653">errorCode: '7201',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="324" x="1523" y="1124.0981">errorDescription: 'No thirdparty enabled FSP found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1515" y="1139.231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1507" y="1154.3638">}</text><polygon fill="#A80036" points="1849.5,1183.5625,1859.5,1187.5625,1849.5,1191.5625,1853.5,1187.5625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1450.5" x2="1855.5" y1="1187.5625" y2="1187.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="1457.5" y="1182.4966">PRELINKING-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1572.5" y="1182.4966">200 OK</text><polygon fill="#A80036" points="1002.5,1212.6953,992.5,1216.6953,1002.5,1220.6953,998.5,1216.6953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="996.5" x2="1444.5" y1="1216.6953" y2="1216.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="1008.5" y="1211.6294">PRELINKING-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="1123.5" y="1211.6294">ErrorInformationObject recieved</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="1245.8281" y2="1245.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="1245.8281" y2="1258.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="1258.8281" y2="1258.8281"/><polygon fill="#A80036" points="1002.5,1254.8281,992.5,1258.8281,1002.5,1262.8281,998.5,1258.8281" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="998.5" y="1240.7622">PRELINKING-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="1113.5" y="1240.7622">throw same error</text><rect fill="#F08080" filter="url(#f12un5mu44osrr)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="348" x="996" y="1271.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1000" y="1287.895">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="1008" y="1303.0278">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1016" y="1318.1606">errorCode: '7201',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="324" x="1016" y="1333.2935">errorDescription: 'No thirdparty enabled FSP found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1008" y="1348.4263">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1000" y="1363.5591">}</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="996" y="1380.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1000" y="1396.6919">state: errored</text><polygon fill="#A80036" points="589.5,1425.8906,579.5,1429.8906,589.5,1433.8906,585.5,1429.8906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="985.5" y1="1429.8906" y2="1429.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="595.5" y="1424.8247">PRELINKING-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="710.5" y="1424.8247">catch MojaloopFSPIOPError</text><polygon fill="#A80036" points="82.5,1455.0234,72.5,1459.0234,82.5,1463.0234,78.5,1459.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="76.5" x2="567.5" y1="1459.0234" y2="1459.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="88.5" y="1453.9575">PRELINKING-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="203.5" y="1453.9575">500 Internal Server Error ErrorInformationObject</text><path d="M25,1472.0234 L25,1497.0234 L1903,1497.0234 L1903,1482.0234 L1893,1472.0234 L25,1472.0234 " fill="#FBFB77" filter="url(#f12un5mu44osrr)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1893,1472.0234 L1893,1482.0234 L1903,1482.0234 L1893,1472.0234 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="344" x="785.5" y="1489.0903">ERROR_SCENARIO: Switch sends back any other error.</text><polygon fill="#A80036" points="1461.5,1523.2891,1451.5,1527.2891,1461.5,1531.2891,1457.5,1527.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1455.5" x2="1855.5" y1="1527.2891" y2="1527.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="1467.5" y="1522.2231">PRELINKING-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="1582.5" y="1522.2231">PUT /services/THIRD_PARTY_DFSP/error</text><rect fill="#F08080" filter="url(#f12un5mu44osrr)" height="113" style="stroke:#A80036;stroke-width:1.0;" width="268" x="1583" y="1540.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="1587" y="1556.356">PUT /services/THIRD_PARTY_DFSP/error</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1587" y="1571.4888">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="1595" y="1586.6216">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1603" y="1601.7544">errorCode: '2001',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244" x="1603" y="1616.8872">errorDescription: 'Internal server error'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1595" y="1632.02">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1587" y="1647.1528">}</text><polygon fill="#A80036" points="1849.5,1676.3516,1859.5,1680.3516,1849.5,1684.3516,1853.5,1680.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1450.5" x2="1855.5" y1="1680.3516" y2="1680.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="1457.5" y="1675.2856">PRELINKING-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1572.5" y="1675.2856">200 OK</text><polygon fill="#A80036" points="1002.5,1705.4844,992.5,1709.4844,1002.5,1713.4844,998.5,1709.4844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="996.5" x2="1444.5" y1="1709.4844" y2="1709.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="1008.5" y="1704.4185">PRELINKING-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="1123.5" y="1704.4185">Services request recieved</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="1738.6172" y2="1738.6172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="1738.6172" y2="1751.6172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="1751.6172" y2="1751.6172"/><polygon fill="#A80036" points="1002.5,1747.6172,992.5,1751.6172,1002.5,1755.6172,998.5,1751.6172" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="998.5" y="1733.5513">PRELINKING-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1113.5" y="1733.5513">throw account linking generic error</text><rect fill="#F08080" filter="url(#f12un5mu44osrr)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="392" x="996" y="1764.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1000" y="1780.6841">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="1008" y="1795.8169">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1016" y="1810.9497">errorCode: '7200',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="368" x="1016" y="1826.0825">errorDescription: 'Generic Thirdparty account linking error'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1008" y="1841.2153">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1000" y="1856.3481">}</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="996" y="1873.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1000" y="1889.481">state: errored</text><polygon fill="#A80036" points="589.5,1918.6797,579.5,1922.6797,589.5,1926.6797,585.5,1922.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="985.5" y1="1922.6797" y2="1922.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="595.5" y="1917.6138">PRELINKING-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="710.5" y="1917.6138">catch MojaloopFSPIOPError</text><polygon fill="#A80036" points="77.5,1947.8125,67.5,1951.8125,77.5,1955.8125,73.5,1951.8125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="71.5" x2="572.5" y1="1951.8125" y2="1951.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="83.5" y="1946.7466">PRELINKING-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="198.5" y="1946.7466">500 Internal Server Error ErrorInformationObject</text><rect fill="#EEEEEE" filter="url(#f12un5mu44osrr)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="3510.5" x="0" y="1980.3789"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3510.5" y1="1980.3789" y2="1980.3789"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3510.5" y1="1983.3789" y2="1983.3789"/><rect fill="#EEEEEE" filter="url(#f12un5mu44osrr)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="172" x="1669.25" y="1969.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="153" x="1675.25" y="1985.8794">Pre-Linking - Cached</text><polygon fill="#A80036" points="556.5,2020.0781,566.5,2024.0781,556.5,2028.0781,560.5,2024.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="71.5" x2="562.5" y1="2024.0781" y2="2024.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="78.5" y="2019.0122">PRELINKING-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="184.5" y="2019.0122">GET /linking/get-dfsps</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="405" x="583" y="2037.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="397" x="587" y="2053.145">We will need a uuid from the start of the model to link all steps</text><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="620.5" y1="2086.3438" y2="2086.3438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="620.5" x2="620.5" y1="2086.3438" y2="2099.3438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="579.5" x2="620.5" y1="2099.3438" y2="2099.3438"/><polygon fill="#A80036" points="589.5,2095.3438,579.5,2099.3438,589.5,2103.3438,585.5,2099.3438" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="585.5" y="2081.2778">PRELINKING-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="691.5" y="2081.2778">const uuid = uuidv4()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="620.5" y1="2128.4766" y2="2128.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="620.5" x2="620.5" y1="2128.4766" y2="2141.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="579.5" x2="620.5" y1="2141.4766" y2="2141.4766"/><polygon fill="#A80036" points="589.5,2137.4766,579.5,2141.4766,589.5,2145.4766,585.5,2141.4766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="585.5" y="2123.4106">PRELINKING-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="691.5" y="2123.4106">const model = await create()</text><polygon fill="#A80036" points="969.5,2166.6094,979.5,2170.6094,969.5,2174.6094,973.5,2170.6094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="975.5" y1="2170.6094" y2="2170.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="585.5" y="2165.5435">PRELINKING-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="691.5" y="2165.5435">model.getThirdpartyEnabledDFSPs()</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="205" x="996" y="2183.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1000" y="2199.6763">state: requestTPEnabledDFSPs</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="2248.0078" y2="2248.0078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="2248.0078" y2="2261.0078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="2261.0078" y2="2261.0078"/><polygon fill="#A80036" points="1002.5,2257.0078,992.5,2261.0078,1002.5,2265.0078,998.5,2261.0078" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="998.5" y="2235.3755">PRELINKING-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="1104.5" y="2227.8091">Check cache.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="161" x="1104.5" y="2242.9419">DFSPs is stored in cache.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="2290.1406" y2="2290.1406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="2290.1406" y2="2303.1406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="2303.1406" y2="2303.1406"/><polygon fill="#A80036" points="1002.5,2299.1406,992.5,2303.1406,1002.5,2307.1406,998.5,2303.1406" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="998.5" y="2285.0747">PRELINKING-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="1104.5" y="2285.0747">Retrieve from cache</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="233" x="996" y="2316.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="1000" y="2332.2075">state: enabledDFSPLookupSuccess</text><polygon fill="#A80036" points="589.5,2361.4063,579.5,2365.4063,589.5,2369.4063,585.5,2365.4063" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="985.5" y1="2365.4063" y2="2365.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="595.5" y="2360.3403">PRELINKING-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="701.5" y="2360.3403">return TPEnabledDFSPs</text><polygon fill="#A80036" points="77.5,2390.5391,67.5,2394.5391,77.5,2398.5391,73.5,2394.5391" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="71.5" x2="572.5" y1="2394.5391" y2="2394.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="102" x="83.5" y="2389.4731">PRELINKING-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="189.5" y="2389.4731">200 OK TPEnabledDFSPs</text><rect fill="#EEEEEE" filter="url(#f12un5mu44osrr)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="3510.5" x="0" y="2423.1055"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3510.5" y1="2423.1055" y2="2423.1055"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3510.5" y1="2426.1055" y2="2426.1055"/><rect fill="#EEEEEE" filter="url(#f12un5mu44osrr)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="90" x="1710.25" y="2412.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="71" x="1716.25" y="2428.606">Discovery</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="714" x="71" y="2450.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="706" x="75" y="2466.7388">PISP presents DFSPs to user. User selects a dfpsa and provides a generic ID to search for associated accounts</text><polygon fill="#A80036" points="556.5,2495.9375,566.5,2499.9375,556.5,2503.9375,560.5,2499.9375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="71.5" x2="562.5" y1="2499.9375" y2="2499.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="78.5" y="2494.8716">DISCOVERY-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="275" x="180.5" y="2494.8716">GET /linking/accounts/dfspa/username1234</text><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="620.5" y1="2529.0703" y2="2529.0703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="620.5" x2="620.5" y1="2529.0703" y2="2542.0703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="579.5" x2="620.5" y1="2542.0703" y2="2542.0703"/><polygon fill="#A80036" points="589.5,2538.0703,579.5,2542.0703,589.5,2546.0703,585.5,2542.0703" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="585.5" y="2524.0044">DISCOVERY-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="687.5" y="2524.0044">const model = await loadFromKVS()</text><polygon fill="#A80036" points="969.5,2567.2031,979.5,2571.2031,969.5,2575.2031,973.5,2571.2031" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="975.5" y1="2571.2031" y2="2571.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="585.5" y="2566.1372">DISCOVERY-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="687.5" y="2566.1372">model.getAccounts()</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="157" x="996" y="2584.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="1000" y="2600.27">state: requestAccounts</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="2633.4688" y2="2633.4688"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="2633.4688" y2="2646.4688"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="2646.4688" y2="2646.4688"/><polygon fill="#A80036" points="1002.5,2642.4688,992.5,2646.4688,1002.5,2650.4688,998.5,2646.4688" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="998.5" y="2628.4028">DISCOVERY-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="1100.5" y="2628.4028">ThirdpartyRequests.getAccounts()</text><polygon fill="#A80036" points="1844.5,2671.6016,1854.5,2675.6016,1844.5,2679.6016,1848.5,2675.6016" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1850.5" y1="2675.6016" y2="2675.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="998.5" y="2670.5356">DISCOVERY-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="1100.5" y="2670.5356">GET /accounts/username1234</text><rect fill="#ADD8E6" filter="url(#f12un5mu44osrr)" height="53" style="stroke:#A80036;stroke-width:1.0;" width="200" x="996" y="2688.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="1000" y="2704.6685">GET /accounts/username1234</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1000" y="2719.8013">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1000" y="2734.9341">FSIOP-Destination: dfspa</text><polygon fill="#A80036" points="997.5,2764.1328,987.5,2768.1328,997.5,2772.1328,993.5,2768.1328" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="991.5" x2="1855.5" y1="2768.1328" y2="2768.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="1003.5" y="2763.0669">DISCOVERY-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1105.5" y="2763.0669">202 Accepted</text><polygon fill="#A80036" points="2184.5,2793.2656,2194.5,2797.2656,2184.5,2801.2656,2188.5,2797.2656" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1866.5" x2="2190.5" y1="2797.2656" y2="2797.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="1873.5" y="2792.1997">DISCOVERY-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="1975.5" y="2792.1997">GET /accounts/username1234</text><polygon fill="#A80036" points="1872.5,2822.3984,1862.5,2826.3984,1872.5,2830.3984,1868.5,2826.3984" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1866.5" x2="2195.5" y1="2826.3984" y2="2826.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="1878.5" y="2821.3325">DISCOVERY-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1980.5" y="2821.3325">202 Accepted</text><rect fill="#ADD8E6" filter="url(#f12un5mu44osrr)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="487" x="2211" y="2839.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="402" x="2215" y="2855.4653">NOTE: What identifier do we use that this state machine can be</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="413" x="2239" y="2870.5981">pulled from cache so that we can have one giant state machine?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="455" x="2239" y="2885.731">Do we pass the DFSP the uuid made in PRELINKING-2 so it can use that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60" x="2239" y="2900.8638">as a key?</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2206.5" x2="2248.5" y1="2934.0625" y2="2934.0625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2248.5" x2="2248.5" y1="2934.0625" y2="2947.0625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2207.5" x2="2248.5" y1="2947.0625" y2="2947.0625"/><polygon fill="#A80036" points="2217.5,2943.0625,2207.5,2947.0625,2217.5,2951.0625,2213.5,2947.0625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="2213.5" y="2928.9966">DISCOVERY-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="2315.5" y="2928.9966">const model = await create()</text><polygon fill="#A80036" points="2606.5,2972.1953,2616.5,2976.1953,2606.5,2980.1953,2610.5,2976.1953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2201.5" x2="2612.5" y1="2976.1953" y2="2976.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="2208.5" y="2971.1294">DISCOVERY-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="2319.5" y="2971.1294">model.retrieveAccounts()</text><path d="M5,2989.1953 L5,3014.1953 L2686,3014.1953 L2686,2999.1953 L2676,2989.1953 L5,2989.1953 " fill="#FBFB77" filter="url(#f12un5mu44osrr)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2676,2989.1953 L2676,2999.1953 L2686,2999.1953 L2676,2989.1953 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="311" x="1183.5" y="3006.2622">HAPPY_SCENARIO: DFSP returns list of accounts.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="2670.5" y1="3044.4609" y2="3044.4609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2670.5" x2="2670.5" y1="3044.4609" y2="3057.4609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2629.5" x2="2670.5" y1="3057.4609" y2="3057.4609"/><polygon fill="#A80036" points="2639.5,3053.4609,2629.5,3057.4609,2639.5,3061.4609,2635.5,3057.4609" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="2635.5" y="3039.395">DISCOVERY-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="375" x="2746.5" y="3039.395">DFSPBackendRequests.getUserAccounts('username1234')</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="2670.5" y1="3086.5938" y2="3086.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2670.5" x2="2670.5" y1="3086.5938" y2="3099.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2629.5" x2="2670.5" y1="3099.5938" y2="3099.5938"/><polygon fill="#A80036" points="2639.5,3095.5938,2629.5,3099.5938,2639.5,3103.5938,2635.5,3099.5938" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="2635.5" y="3081.5278">DISCOVERY-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="2746.5" y="3081.5278">Accounts returned.</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="167" x="2633" y="3112.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="2637" y="3128.6606">state: accountsRetrieved</text><rect fill="#ADD8E6" filter="url(#f12un5mu44osrr)" height="204" style="stroke:#A80036;stroke-width:1.0;" width="570" x="2043" y="3145.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="354" x="2047" y="3161.7935">NOTE: This deviates from the original design document.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318" x="2071" y="3176.9263">Which has the response as a top-level array which</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="222" x="2071" y="3192.0591">is a security and expandability risk.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="2071" y="3207.1919">Fixing that here.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="2047" y="3222.3247">PUT /accounts/username1234</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="2047" y="3237.4575">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="2047" y="3252.5903">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2047" y="3267.7231">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="2055" y="3282.856">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="2063" y="3297.9888">{ accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="546" x="2063" y="3313.1216">{ accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="5" x="2055" y="3328.2544">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2047" y="3343.3872">}</text><polygon fill="#A80036" points="1877.5,3372.5859,1867.5,3376.5859,1877.5,3380.5859,1873.5,3376.5859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1871.5" x2="2617.5" y1="3376.5859" y2="3376.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1883.5" y="3371.52">DISCOVERY-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="1994.5" y="3371.52">PUT /accounts/username1234</text><polygon fill="#A80036" points="2611.5,3401.7188,2621.5,3405.7188,2611.5,3409.7188,2615.5,3405.7188" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1866.5" x2="2617.5" y1="3405.7188" y2="3405.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1873.5" y="3400.6528">DISCOVERY-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1984.5" y="3400.6528">200 OK</text><polygon fill="#A80036" points="1461.5,3430.8516,1451.5,3434.8516,1461.5,3438.8516,1457.5,3434.8516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1455.5" x2="1855.5" y1="3434.8516" y2="3434.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1467.5" y="3429.7856">DISCOVERY-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="1578.5" y="3429.7856">PUT /accounts/username1234</text><polygon fill="#A80036" points="1849.5,3459.9844,1859.5,3463.9844,1849.5,3467.9844,1853.5,3463.9844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1450.5" x2="1855.5" y1="3463.9844" y2="3463.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1457.5" y="3458.9185">DISCOVERY-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1568.5" y="3458.9185">200 OK</text><polygon fill="#A80036" points="1002.5,3489.1172,992.5,3493.1172,1002.5,3497.1172,998.5,3493.1172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="996.5" x2="1444.5" y1="3493.1172" y2="3493.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1008.5" y="3488.0513">DISCOVERY-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="1119.5" y="3488.0513">Accounts response recieved</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="199" x="996" y="3506.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="1000" y="3522.1841">state: accountLookupSuccess</text><polygon fill="#A80036" points="589.5,3551.3828,579.5,3555.3828,589.5,3559.3828,585.5,3555.3828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="985.5" y1="3555.3828" y2="3555.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="595.5" y="3550.3169">DISCOVERY-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="706.5" y="3550.3169">return Accounts</text><polygon fill="#A80036" points="82.5,3580.5156,72.5,3584.5156,82.5,3588.5156,78.5,3584.5156" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="76.5" x2="567.5" y1="3584.5156" y2="3584.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="88.5" y="3579.4497">DISCOVERY-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="199.5" y="3579.4497">200 OK Accounts</text><path d="M5,3597.5156 L5,3622.5156 L2686,3622.5156 L2686,3607.5156 L2676,3597.5156 L5,3597.5156 " fill="#FBFB77" filter="url(#f12un5mu44osrr)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2676,3597.5156 L2676,3607.5156 L2686,3607.5156 L2676,3597.5156 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="509" x="1084.5" y="3614.5825">ERROR_SCENARIO: Switch receives 7202 No accounts found for generic ID error.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="2670.5" y1="3652.7813" y2="3652.7813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2670.5" x2="2670.5" y1="3652.7813" y2="3665.7813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2629.5" x2="2670.5" y1="3665.7813" y2="3665.7813"/><polygon fill="#A80036" points="2639.5,3661.7813,2629.5,3665.7813,2639.5,3669.7813,2635.5,3665.7813" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="2635.5" y="3647.7153">DISCOVERY-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="375" x="2746.5" y="3647.7153">DFSPBackendRequests.getUserAccounts('username1234')</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="2670.5" y1="3694.9141" y2="3694.9141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2670.5" x2="2670.5" y1="3694.9141" y2="3707.9141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2629.5" x2="2670.5" y1="3707.9141" y2="3707.9141"/><polygon fill="#A80036" points="2639.5,3703.9141,2629.5,3707.9141,2639.5,3711.9141,2635.5,3707.9141" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="2635.5" y="3689.8481">DISCOVERY-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="2746.5" y="3689.8481">No accounts returned.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="2670.5" y1="3737.0469" y2="3737.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2670.5" x2="2670.5" y1="3737.0469" y2="3750.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2629.5" x2="2670.5" y1="3750.0469" y2="3750.0469"/><polygon fill="#A80036" points="2639.5,3746.0469,2629.5,3750.0469,2639.5,3754.0469,2635.5,3750.0469" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="2635.5" y="3731.981">DISCOVERY-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="2746.5" y="3731.981">throw MojaloopFSPIOPError</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="2633" y="3763.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2637" y="3779.1138">state: errored</text><rect fill="#F08080" filter="url(#f12un5mu44osrr)" height="144" style="stroke:#A80036;stroke-width:1.0;" width="350" x="2263" y="3796.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="2267" y="3812.2466">PUT /accounts/username1234/error</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="2267" y="3827.3794">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="2267" y="3842.5122">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2267" y="3857.645">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2275" y="3872.7778">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2283" y="3887.9106">errorCode: '7202',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="326" x="2283" y="3903.0435">errorDescription: 'No accounts found for generic ID'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2275" y="3918.1763">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2267" y="3933.3091">}</text><polygon fill="#A80036" points="1877.5,3962.5078,1867.5,3966.5078,1877.5,3970.5078,1873.5,3966.5078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1871.5" x2="2617.5" y1="3966.5078" y2="3966.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1883.5" y="3961.4419">DISCOVERY-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="1994.5" y="3961.4419">PUT /accounts/username1234/error</text><polygon fill="#A80036" points="2611.5,3991.6406,2621.5,3995.6406,2611.5,3999.6406,2615.5,3995.6406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1866.5" x2="2617.5" y1="3995.6406" y2="3995.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1873.5" y="3990.5747">DISCOVERY-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1984.5" y="3990.5747">200 OK</text><polygon fill="#A80036" points="1461.5,4020.7734,1451.5,4024.7734,1461.5,4028.7734,1457.5,4024.7734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1455.5" x2="1855.5" y1="4024.7734" y2="4024.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1467.5" y="4019.7075">DISCOVERY-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="1578.5" y="4019.7075">PUT /accounts/username1234/error</text><polygon fill="#A80036" points="1849.5,4049.9063,1859.5,4053.9063,1849.5,4057.9063,1853.5,4053.9063" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1450.5" x2="1855.5" y1="4053.9063" y2="4053.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1457.5" y="4048.8403">DISCOVERY-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1568.5" y="4048.8403">200 OK</text><polygon fill="#A80036" points="1002.5,4079.0391,992.5,4083.0391,1002.5,4087.0391,998.5,4083.0391" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="996.5" x2="1444.5" y1="4083.0391" y2="4083.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1008.5" y="4077.9731">DISCOVERY-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="1119.5" y="4077.9731">MojaloopFSPIOPError response recieved</text><polygon fill="#A80036" points="589.5,4108.1719,579.5,4112.1719,589.5,4116.1719,585.5,4112.1719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="985.5" y1="4112.1719" y2="4112.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="595.5" y="4107.106">DISCOVERY-28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="706.5" y="4107.106">return MojaloopFSPIOPError</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="991" y="4125.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="995" y="4141.2388">state: errored</text><polygon fill="#A80036" points="77.5,4170.4375,67.5,4174.4375,77.5,4178.4375,73.5,4174.4375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="71.5" x2="572.5" y1="4174.4375" y2="4174.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="83.5" y="4169.3716">DISCOVERY-29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="194.5" y="4169.3716">500 Internal Server Error ErrorInformationObject</text><rect fill="#EEEEEE" filter="url(#f12un5mu44osrr)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="3510.5" x="0" y="4203.0039"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3510.5" y1="4203.0039" y2="4203.0039"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3510.5" y1="4206.0039" y2="4206.0039"/><rect fill="#EEEEEE" filter="url(#f12un5mu44osrr)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="193" x="1658.75" y="4192.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="174" x="1664.75" y="4208.5044">Request Consent - Web</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="485" x="71" y="4230.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="75" y="4246.6372">PISP presents accounts to user. User selects one or more accounts to link.</text><polygon fill="#A80036" points="556.5,4275.8359,566.5,4279.8359,556.5,4283.8359,560.5,4279.8359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="71.5" x2="562.5" y1="4279.8359" y2="4279.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="78.5" y="4274.77">REQUEST-CONSENT-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="236.5" y="4274.77">POST /linking/request-consent</text><rect fill="#ADD8E6" filter="url(#f12un5mu44osrr)" height="189" style="stroke:#A80036;stroke-width:1.0;" width="244" x="76" y="4292.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="80" y="4308.9028">POST /linking/request-consent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="80" y="4324.0356">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="88" y="4339.1685">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="96" y="4354.3013">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="96" y="4369.4341">actions: [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="96" y="4384.5669">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="96" y="4399.6997">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="96" y="4414.8325">actions: [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="5" x="96" y="4429.9653">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="88" y="4445.0981">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="88" y="4460.231">callbackURI: 'pisp-app://callback'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="80" y="4475.3638">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="620.5" y1="4508.5625" y2="4508.5625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="620.5" x2="620.5" y1="4508.5625" y2="4521.5625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="579.5" x2="620.5" y1="4521.5625" y2="4521.5625"/><polygon fill="#A80036" points="589.5,4517.5625,579.5,4521.5625,589.5,4525.5625,585.5,4521.5625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="585.5" y="4503.4966">REQUEST-CONSENT-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="743.5" y="4503.4966">const model = await loadFromKVS()</text><polygon fill="#A80036" points="969.5,4546.6953,979.5,4550.6953,969.5,4554.6953,973.5,4550.6953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="975.5" y1="4550.6953" y2="4550.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="585.5" y="4545.6294">REQUEST-CONSENT-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="743.5" y="4545.6294">model.requestConsent()</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="151" x="996" y="4563.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="1000" y="4579.7622">state: requestConsent</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="4612.9609" y2="4612.9609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="4612.9609" y2="4625.9609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="4625.9609" y2="4625.9609"/><polygon fill="#A80036" points="1002.5,4621.9609,992.5,4625.9609,1002.5,4629.9609,998.5,4625.9609" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="998.5" y="4607.895">REQUEST-CONSENT-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1156.5" y="4607.895">ThirdpartyRequests.postConsentRequests()</text><polygon fill="#A80036" points="1844.5,4651.0938,1854.5,4655.0938,1844.5,4659.0938,1848.5,4655.0938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1850.5" y1="4655.0938" y2="4655.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="998.5" y="4650.0278">REQUEST-CONSENT-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1156.5" y="4650.0278">POST /consentRequests</text><rect fill="#ADD8E6" filter="url(#f12un5mu44osrr)" height="265" style="stroke:#A80036;stroke-width:1.0;" width="358" x="996" y="4668.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1000" y="4684.1606">POST /consentRequests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1000" y="4699.2935">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1000" y="4714.4263">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1000" y="4729.5591">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1008" y="4744.6919">// consentRequestId will be the uuid created</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1008" y="4759.8247">// at the PRELINKING-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1008" y="4774.9575">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1008" y="4790.0903">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1016" y="4805.2231">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1016" y="4820.356">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1016" y="4835.4888">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1016" y="4850.6216">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1008" y="4865.7544">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1008" y="4880.8872">// model will add `authChannels`</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="1008" y="4896.02">authChannels: ["WEB", "OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216" x="1008" y="4911.1528">callbackURI: 'pisp-app://callback...'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1000" y="4926.2856">}</text><polygon fill="#A80036" points="997.5,4955.4844,987.5,4959.4844,997.5,4963.4844,993.5,4959.4844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="991.5" x2="1855.5" y1="4959.4844" y2="4959.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1003.5" y="4954.4185">REQUEST-CONSENT-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1161.5" y="4954.4185">202 Accepted</text><polygon fill="#A80036" points="2184.5,4984.6172,2194.5,4988.6172,2184.5,4992.6172,2188.5,4988.6172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1866.5" x2="2190.5" y1="4988.6172" y2="4988.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1873.5" y="4983.5513">REQUEST-CONSENT-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="2031.5" y="4983.5513">POST /consentRequests</text><polygon fill="#A80036" points="1872.5,5013.75,1862.5,5017.75,1872.5,5021.75,1868.5,5017.75" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1866.5" x2="2195.5" y1="5017.75" y2="5017.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1878.5" y="5012.6841">REQUEST-CONSENT-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2036.5" y="5012.6841">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2206.5" x2="2253.5" y1="5041.8828" y2="5041.8828"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2253.5" x2="2253.5" y1="5041.8828" y2="5054.8828"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2212.5" x2="2253.5" y1="5054.8828" y2="5054.8828"/><polygon fill="#A80036" points="2222.5,5050.8828,2212.5,5054.8828,2222.5,5058.8828,2218.5,5054.8828" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2218.5" y="5036.8169">REQUEST-CONSENT-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="2376.5" y="5036.8169">const model = await loadFromKVS()</text><polygon fill="#A80036" points="2606.5,5085.0156,2616.5,5089.0156,2606.5,5093.0156,2610.5,5089.0156" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2206.5" x2="2612.5" y1="5089.0156" y2="5089.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2213.5" y="5083.9497">REQUEST-CONSENT-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="2380.5" y="5083.9497">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="2675.5" y1="5113.1484" y2="5113.1484"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2675.5" x2="2675.5" y1="5113.1484" y2="5126.1484"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2634.5" x2="2675.5" y1="5126.1484" y2="5126.1484"/><polygon fill="#A80036" points="2644.5,5122.1484,2634.5,5126.1484,2644.5,5130.1484,2640.5,5126.1484" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2640.5" y="5108.0825">REQUEST-CONSENT-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="2807.5" y="5108.0825">DFSPBackendRequests.validateConsentRequest()</text><polygon fill="#A80036" points="3116.5,5156.2813,3126.5,5160.2813,3116.5,5164.2813,3120.5,5160.2813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="3122.5" y1="5160.2813" y2="5160.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2635.5" y="5155.2153">REQUEST-CONSENT-12</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="256" x="2802.5" y="5155.2153">POST/store/consentRequests/6789</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3138.5" x2="3180.5" y1="5189.4141" y2="5189.4141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3180.5" x2="3180.5" y1="5189.4141" y2="5202.4141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3139.5" x2="3180.5" y1="5202.4141" y2="5202.4141"/><polygon fill="#A80036" points="3149.5,5198.4141,3139.5,5202.4141,3149.5,5206.4141,3145.5,5202.4141" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3145.5" y="5184.3481">REQUEST-CONSENT-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="3312.5" y="5184.3481">store consentRequest details</text><polygon fill="#A80036" points="2639.5,5227.5469,2629.5,5231.5469,2639.5,5235.5469,2635.5,5231.5469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2633.5" x2="3132.5" y1="5231.5469" y2="5231.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2645.5" y="5226.481">REQUEST-CONSENT-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="2812.5" y="5226.481">201 Created</text><polygon fill="#A80036" points="1877.5,5256.6797,1867.5,5260.6797,1877.5,5264.6797,1873.5,5260.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1871.5" x2="2200.5" y1="5260.6797" y2="5260.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1883.5" y="5255.6138">REQUEST-CONSENT-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2050.5" y="5255.6138">202 Accepted</text><polygon fill="#A80036" points="1877.5,5285.8125,1867.5,5289.8125,1877.5,5293.8125,1873.5,5289.8125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1871.5" x2="2617.5" y1="5289.8125" y2="5289.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1883.5" y="5284.7466">REQUEST-CONSENT-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="2050.5" y="5284.7466">PUT /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f12un5mu44osrr)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="457" x="2156" y="5302.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="2160" y="5318.8794">PUT /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="2160" y="5334.0122">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2160" y="5349.145">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2160" y="5364.2778">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="2168" y="5379.4106">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="2168" y="5394.5435">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2176" y="5409.6763">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2176" y="5424.8091">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2176" y="5439.9419">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2176" y="5455.0747">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="2168" y="5470.2075">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="2168" y="5485.3403">authChannels: ["WEB"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2168" y="5500.4731">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441" x="2168" y="5515.606">authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2160" y="5530.7388">}</text><polygon fill="#A80036" points="2611.5,5559.9375,2621.5,5563.9375,2611.5,5567.9375,2615.5,5563.9375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1866.5" x2="2617.5" y1="5563.9375" y2="5563.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1873.5" y="5558.8716">REQUEST-CONSENT-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2040.5" y="5558.8716">202 ACCEPTED</text><polygon fill="#A80036" points="1461.5,5589.0703,1451.5,5593.0703,1461.5,5597.0703,1457.5,5593.0703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1455.5" x2="1855.5" y1="5593.0703" y2="5593.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1467.5" y="5588.0044">REQUEST-CONSENT-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="1634.5" y="5588.0044">PUT /consentRequests/6789</text><polygon fill="#A80036" points="1849.5,5618.2031,1859.5,5622.2031,1849.5,5626.2031,1853.5,5622.2031" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1450.5" x2="1855.5" y1="5622.2031" y2="5622.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1457.5" y="5617.1372">REQUEST-CONSENT-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1624.5" y="5617.1372">200 OK</text><polygon fill="#A80036" points="1002.5,5647.3359,992.5,5651.3359,1002.5,5655.3359,998.5,5651.3359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="996.5" x2="1444.5" y1="5651.3359" y2="5651.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1008.5" y="5646.27">REQUEST-CONSENT-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="1175.5" y="5646.27">Consent Request response recieved</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="338" x="996" y="5664.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="330" x="1000" y="5680.4028">state: webAuthenticationChannelResponseRecieved</text><polygon fill="#A80036" points="589.5,5709.6016,579.5,5713.6016,589.5,5717.6016,585.5,5713.6016" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="985.5" y1="5713.6016" y2="5713.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="595.5" y="5708.5356">REQUEST-CONSENT-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="762.5" y="5708.5356">return Authentication Response</text><polygon fill="#A80036" points="82.5,5738.7344,72.5,5742.7344,82.5,5746.7344,78.5,5742.7344" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="76.5" x2="567.5" y1="5742.7344" y2="5742.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="88.5" y="5737.6685">REQUEST-CONSENT-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="255.5" y="5737.6685">200 OK Autentication Response</text><path d="M5,5755.7344 L5,5840.7344 L2686,5840.7344 L2686,5765.7344 L2676,5755.7344 L5,5755.7344 " fill="#FBFB77" filter="url(#f12un5mu44osrr)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2676,5755.7344 L2676,5765.7344 L2686,5765.7344 L2676,5755.7344 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="1136" y="5772.8013">ERROR_SCENARIO:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="222" x="1144" y="5787.9341">FSP does not find scopes suitable |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="398" x="1144" y="5803.0669">FSP does not support any requested authentication channels |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="333" x="1144" y="5818.1997">FSP does not support any requested scope actions |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="1144" y="5833.3325">FSP does not trust PISP callback URI</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2206.5" x2="2253.5" y1="5866.5313" y2="5866.5313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2253.5" x2="2253.5" y1="5866.5313" y2="5879.5313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2212.5" x2="2253.5" y1="5879.5313" y2="5879.5313"/><polygon fill="#A80036" points="2222.5,5875.5313,2212.5,5879.5313,2222.5,5883.5313,2218.5,5879.5313" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2218.5" y="5861.4653">REQUEST-CONSENT-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="2385.5" y="5861.4653">const model = await loadFromKVS()</text><polygon fill="#A80036" points="2606.5,5909.6641,2616.5,5913.6641,2606.5,5917.6641,2610.5,5913.6641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2206.5" x2="2612.5" y1="5913.6641" y2="5913.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2213.5" y="5908.5981">REQUEST-CONSENT-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="2380.5" y="5908.5981">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="2670.5" y1="5942.7969" y2="5942.7969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2670.5" x2="2670.5" y1="5942.7969" y2="5955.7969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2629.5" x2="2670.5" y1="5955.7969" y2="5955.7969"/><polygon fill="#A80036" points="2639.5,5951.7969,2629.5,5955.7969,2639.5,5959.7969,2635.5,5955.7969" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2635.5" y="5937.731">REQUEST-CONSENT-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="2802.5" y="5937.731">DFSPBackendRequests.validateConsentRequest()</text><polygon fill="#A80036" points="1877.5,5980.9297,1867.5,5984.9297,1877.5,5988.9297,1873.5,5984.9297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1871.5" x2="2200.5" y1="5984.9297" y2="5984.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1883.5" y="5979.8638">REQUEST-CONSENT-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2050.5" y="5979.8638">202 Accepted</text><polygon fill="#A80036" points="1877.5,6010.0625,1867.5,6014.0625,1877.5,6018.0625,1873.5,6014.0625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1871.5" x2="2617.5" y1="6014.0625" y2="6014.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1883.5" y="6008.9966">REQUEST-CONSENT-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="2050.5" y="6008.9966">PUT /consentRequests/6789/error</text><rect fill="#F08080" filter="url(#f12un5mu44osrr)" height="325" style="stroke:#A80036;stroke-width:1.0;" width="531" x="2082" y="6027.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="2086" y="6043.1294">PUT /consentRequests/6789/error</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="2086" y="6058.2622">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="2086" y="6073.395">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2086" y="6088.5278">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2094" y="6103.6606">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="2102" y="6118.7935">errorCode: '720x',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="331" x="2102" y="6133.9263">errorDescription: 'FSP does not find scopes suitable'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2094" y="6149.0591">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2094" y="6164.1919">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2102" y="6179.3247">errorCode: '7203',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="2102" y="6194.4575">errorDescription: 'FSP does not support any requested authentication channels'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2094" y="6209.5903">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2094" y="6224.7231">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2102" y="6239.856">errorCode: '7204',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="442" x="2102" y="6254.9888">errorDescription: 'FSP does not support any requested scope actions'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2094" y="6270.1216">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2094" y="6285.2544">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="2102" y="6300.3872">errorCode: '720x',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="347" x="2102" y="6315.52">errorDescription: 'FSP does not trust PISP callback URI'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2094" y="6330.6528">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2086" y="6345.7856">}</text><polygon fill="#A80036" points="2611.5,6374.9844,2621.5,6378.9844,2611.5,6382.9844,2615.5,6378.9844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1866.5" x2="2617.5" y1="6378.9844" y2="6378.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1873.5" y="6373.9185">REQUEST-CONSENT-28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2040.5" y="6373.9185">200 OK</text><polygon fill="#A80036" points="1461.5,6404.1172,1451.5,6408.1172,1461.5,6412.1172,1457.5,6408.1172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1455.5" x2="1855.5" y1="6408.1172" y2="6408.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1467.5" y="6403.0513">REQUEST-CONSENT-29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="1634.5" y="6403.0513">PUT /consentRequests/6789/error</text><polygon fill="#A80036" points="1849.5,6433.25,1859.5,6437.25,1849.5,6441.25,1853.5,6437.25" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1450.5" x2="1855.5" y1="6437.25" y2="6437.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1457.5" y="6432.1841">REQUEST-CONSENT-30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1624.5" y="6432.1841">200 OK</text><polygon fill="#A80036" points="1002.5,6462.3828,992.5,6466.3828,1002.5,6470.3828,998.5,6466.3828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="996.5" x2="1444.5" y1="6466.3828" y2="6466.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1008.5" y="6461.3169">REQUEST-CONSENT-31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="1175.5" y="6461.3169">MojaloopFSPIOPError response recieved</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="996" y="6479.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1000" y="6495.4497">state: errored</text><polygon fill="#A80036" points="589.5,6524.6484,579.5,6528.6484,589.5,6532.6484,585.5,6528.6484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="985.5" y1="6528.6484" y2="6528.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="595.5" y="6523.5825">REQUEST-CONSENT-32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="762.5" y="6523.5825">return MojaloopFSPIOPError</text><polygon fill="#A80036" points="77.5,6553.7813,67.5,6557.7813,77.5,6561.7813,73.5,6557.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="71.5" x2="572.5" y1="6557.7813" y2="6557.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="83.5" y="6552.7153">REQUEST-CONSENT-33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="250.5" y="6552.7153">500 Internal Server Error ErrorInformationObject</text><rect fill="#EEEEEE" filter="url(#f12un5mu44osrr)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="3510.5" x="0" y="6586.3477"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3510.5" y1="6586.3477" y2="6586.3477"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3510.5" y1="6589.3477" y2="6589.3477"/><rect fill="#EEEEEE" filter="url(#f12un5mu44osrr)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="189" x="1660.75" y="6575.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="170" x="1666.75" y="6591.8481">Request Consent - OTP</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="485" x="71" y="6613.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="75" y="6629.981">PISP presents accounts to user. User selects one or more accounts to link.</text><polygon fill="#A80036" points="556.5,6659.1797,566.5,6663.1797,556.5,6667.1797,560.5,6663.1797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="71.5" x2="562.5" y1="6663.1797" y2="6663.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="78.5" y="6658.1138">REQUEST-CONSENT-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="236.5" y="6658.1138">POST /linking/request-consent</text><rect fill="#ADD8E6" filter="url(#f12un5mu44osrr)" height="189" style="stroke:#A80036;stroke-width:1.0;" width="244" x="76" y="6676.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="80" y="6692.2466">POST /linking/request-consent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="80" y="6707.3794">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="88" y="6722.5122">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="96" y="6737.645">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="96" y="6752.7778">actions: [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="96" y="6767.9106">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="96" y="6783.0435">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="96" y="6798.1763">actions: [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="5" x="96" y="6813.3091">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="88" y="6828.4419">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="88" y="6843.5747">callbackURI: 'pisp-app://callback'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="80" y="6858.7075">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="620.5" y1="6891.9063" y2="6891.9063"/><line style="stroke:#A80036;stroke-width:1.0;" x1="620.5" x2="620.5" y1="6891.9063" y2="6904.9063"/><line style="stroke:#A80036;stroke-width:1.0;" x1="579.5" x2="620.5" y1="6904.9063" y2="6904.9063"/><polygon fill="#A80036" points="589.5,6900.9063,579.5,6904.9063,589.5,6908.9063,585.5,6904.9063" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="585.5" y="6886.8403">REQUEST-CONSENT-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="743.5" y="6886.8403">const model = await loadFromKVS()</text><polygon fill="#A80036" points="969.5,6930.0391,979.5,6934.0391,969.5,6938.0391,973.5,6934.0391" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="975.5" y1="6934.0391" y2="6934.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="585.5" y="6928.9731">REQUEST-CONSENT-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="743.5" y="6928.9731">model.requestConsent()</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="151" x="996" y="6947.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="1000" y="6963.106">state: requestConsent</text><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1033.5" y1="6996.3047" y2="6996.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1033.5" x2="1033.5" y1="6996.3047" y2="7009.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="1033.5" y1="7009.3047" y2="7009.3047"/><polygon fill="#A80036" points="1002.5,7005.3047,992.5,7009.3047,1002.5,7013.3047,998.5,7009.3047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="998.5" y="6991.2388">REQUEST-CONSENT-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1156.5" y="6991.2388">ThirdpartyRequests.postConsentRequests()</text><polygon fill="#A80036" points="1844.5,7034.4375,1854.5,7038.4375,1844.5,7042.4375,1848.5,7038.4375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="991.5" x2="1850.5" y1="7038.4375" y2="7038.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="998.5" y="7033.3716">REQUEST-CONSENT-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1156.5" y="7033.3716">POST /consentRequests</text><rect fill="#ADD8E6" filter="url(#f12un5mu44osrr)" height="265" style="stroke:#A80036;stroke-width:1.0;" width="358" x="996" y="7051.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1000" y="7067.5044">POST /consentRequests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1000" y="7082.6372">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1000" y="7097.77">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1000" y="7112.9028">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1008" y="7128.0356">// consentRequestId will be the uuid created</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1008" y="7143.1685">// at the PRELINKING-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1008" y="7158.3013">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1008" y="7173.4341">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1016" y="7188.5669">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1016" y="7203.6997">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1016" y="7218.8325">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1016" y="7233.9653">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1008" y="7249.0981">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1008" y="7264.231">// model will add `authChannels`</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1008" y="7279.3638">authChannels: ["OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216" x="1008" y="7294.4966">callbackURI: 'pisp-app://callback...'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1000" y="7309.6294">}</text><polygon fill="#A80036" points="997.5,7338.8281,987.5,7342.8281,997.5,7346.8281,993.5,7342.8281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="991.5" x2="1855.5" y1="7342.8281" y2="7342.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1003.5" y="7337.7622">REQUEST-CONSENT-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1161.5" y="7337.7622">202 Accepted</text><polygon fill="#A80036" points="2184.5,7367.9609,2194.5,7371.9609,2184.5,7375.9609,2188.5,7371.9609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1866.5" x2="2190.5" y1="7371.9609" y2="7371.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1873.5" y="7366.895">REQUEST-CONSENT-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="2031.5" y="7366.895">POST /consentRequests</text><polygon fill="#A80036" points="1872.5,7397.0938,1862.5,7401.0938,1872.5,7405.0938,1868.5,7401.0938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1866.5" x2="2195.5" y1="7401.0938" y2="7401.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1878.5" y="7396.0278">REQUEST-CONSENT-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2036.5" y="7396.0278">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2206.5" x2="2253.5" y1="7425.2266" y2="7425.2266"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2253.5" x2="2253.5" y1="7425.2266" y2="7438.2266"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2212.5" x2="2253.5" y1="7438.2266" y2="7438.2266"/><polygon fill="#A80036" points="2222.5,7434.2266,2212.5,7438.2266,2222.5,7442.2266,2218.5,7438.2266" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2218.5" y="7420.1606">REQUEST-CONSENT-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="2376.5" y="7420.1606">const model = await loadFromKVS()</text><polygon fill="#A80036" points="2606.5,7468.3594,2616.5,7472.3594,2606.5,7476.3594,2610.5,7472.3594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2206.5" x2="2612.5" y1="7472.3594" y2="7472.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2213.5" y="7467.2935">REQUEST-CONSENT-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="2380.5" y="7467.2935">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="2675.5" y1="7496.4922" y2="7496.4922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2675.5" x2="2675.5" y1="7496.4922" y2="7509.4922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2634.5" x2="2675.5" y1="7509.4922" y2="7509.4922"/><polygon fill="#A80036" points="2644.5,7505.4922,2634.5,7509.4922,2644.5,7513.4922,2640.5,7509.4922" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2640.5" y="7491.4263">REQUEST-CONSENT-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="2807.5" y="7491.4263">DFSPBackendRequests.validateConsentRequest()</text><polygon fill="#A80036" points="3116.5,7539.625,3126.5,7543.625,3116.5,7547.625,3120.5,7543.625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="3122.5" y1="7543.625" y2="7543.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2635.5" y="7538.5591">REQUEST-CONSENT-12</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="256" x="2802.5" y="7538.5591">POST/store/consentRequests/6789</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3138.5" x2="3180.5" y1="7572.7578" y2="7572.7578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3180.5" x2="3180.5" y1="7572.7578" y2="7585.7578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3139.5" x2="3180.5" y1="7585.7578" y2="7585.7578"/><polygon fill="#A80036" points="3149.5,7581.7578,3139.5,7585.7578,3149.5,7589.7578,3145.5,7585.7578" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3145.5" y="7567.6919">REQUEST-CONSENT-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="3312.5" y="7567.6919">store consentRequest details</text><polygon fill="#A80036" points="2639.5,7610.8906,2629.5,7614.8906,2639.5,7618.8906,2635.5,7614.8906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2633.5" x2="3132.5" y1="7614.8906" y2="7614.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2645.5" y="7609.8247">REQUEST-CONSENT-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="2812.5" y="7609.8247">201 Created</text><polygon fill="#A80036" points="1877.5,7640.0234,1867.5,7644.0234,1877.5,7648.0234,1873.5,7644.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1871.5" x2="2200.5" y1="7644.0234" y2="7644.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1883.5" y="7638.9575">REQUEST-CONSENT-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2050.5" y="7638.9575">202 Accepted</text><polygon fill="#A80036" points="1877.5,7669.1563,1867.5,7673.1563,1877.5,7677.1563,1873.5,7673.1563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1871.5" x2="2617.5" y1="7673.1563" y2="7673.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1883.5" y="7668.0903">REQUEST-CONSENT-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="2050.5" y="7668.0903">PUT /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f12un5mu44osrr)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="457" x="2156" y="7686.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="2160" y="7702.2231">PUT /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="2160" y="7717.356">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2160" y="7732.4888">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2160" y="7747.6216">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="2168" y="7762.7544">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="2168" y="7777.8872">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2176" y="7793.02">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2176" y="7808.1528">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2176" y="7823.2856">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2176" y="7838.4185">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="2168" y="7853.5513">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="2168" y="7868.6841">authChannels: ["OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2168" y="7883.8169">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441" x="2168" y="7898.9497">authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2160" y="7914.0825">}</text><polygon fill="#A80036" points="2611.5,7943.2813,2621.5,7947.2813,2611.5,7951.2813,2615.5,7947.2813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1866.5" x2="2617.5" y1="7947.2813" y2="7947.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1873.5" y="7942.2153">REQUEST-CONSENT-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2040.5" y="7942.2153">202 ACCEPTED</text><polygon fill="#A80036" points="1461.5,7972.4141,1451.5,7976.4141,1461.5,7980.4141,1457.5,7976.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1455.5" x2="1855.5" y1="7976.4141" y2="7976.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1467.5" y="7971.3481">REQUEST-CONSENT-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="1634.5" y="7971.3481">PUT /consentRequests/6789</text><polygon fill="#A80036" points="1849.5,8001.5469,1859.5,8005.5469,1849.5,8009.5469,1853.5,8005.5469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1450.5" x2="1855.5" y1="8005.5469" y2="8005.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1457.5" y="8000.481">REQUEST-CONSENT-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1624.5" y="8000.481">200 OK</text><polygon fill="#A80036" points="1002.5,8030.6797,992.5,8034.6797,1002.5,8038.6797,998.5,8034.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="996.5" x2="1444.5" y1="8034.6797" y2="8034.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1008.5" y="8029.6138">REQUEST-CONSENT-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="1175.5" y="8029.6138">Consent Request response recieved</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="338" x="996" y="8047.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="330" x="1000" y="8063.7466">state: OTPAuthenticationChannelResponseRecieved</text><polygon fill="#A80036" points="589.5,8092.9453,579.5,8096.9453,589.5,8100.9453,585.5,8096.9453" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="985.5" y1="8096.9453" y2="8096.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="595.5" y="8091.8794">REQUEST-CONSENT-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="762.5" y="8091.8794">return Authentication Response</text><polygon fill="#A80036" points="82.5,8122.0781,72.5,8126.0781,82.5,8130.0781,78.5,8126.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="76.5" x2="567.5" y1="8126.0781" y2="8126.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="88.5" y="8121.0122">REQUEST-CONSENT-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="255.5" y="8121.0122">200 OK Autentication Response</text><path d="M5,8139.0781 L5,8224.0781 L2686,8224.0781 L2686,8149.0781 L2676,8139.0781 L5,8139.0781 " fill="#FBFB77" filter="url(#f12un5mu44osrr)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2676,8139.0781 L2676,8149.0781 L2686,8149.0781 L2676,8139.0781 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="1136" y="8156.145">ERROR_SCENARIO:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="222" x="1144" y="8171.2778">FSP does not find scopes suitable |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="398" x="1144" y="8186.4106">FSP does not support any requested authentication channels |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="333" x="1144" y="8201.5435">FSP does not support any requested scope actions |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="1144" y="8216.6763">FSP does not trust PISP callback URI</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2206.5" x2="2253.5" y1="8249.875" y2="8249.875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2253.5" x2="2253.5" y1="8249.875" y2="8262.875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2212.5" x2="2253.5" y1="8262.875" y2="8262.875"/><polygon fill="#A80036" points="2222.5,8258.875,2212.5,8262.875,2222.5,8266.875,2218.5,8262.875" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2218.5" y="8244.8091">REQUEST-CONSENT-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="2385.5" y="8244.8091">const model = await loadFromKVS()</text><polygon fill="#A80036" points="2606.5,8293.0078,2616.5,8297.0078,2606.5,8301.0078,2610.5,8297.0078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2206.5" x2="2612.5" y1="8297.0078" y2="8297.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2213.5" y="8291.9419">REQUEST-CONSENT-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="2380.5" y="8291.9419">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2628.5" x2="2670.5" y1="8326.1406" y2="8326.1406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2670.5" x2="2670.5" y1="8326.1406" y2="8339.1406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2629.5" x2="2670.5" y1="8339.1406" y2="8339.1406"/><polygon fill="#A80036" points="2639.5,8335.1406,2629.5,8339.1406,2639.5,8343.1406,2635.5,8339.1406" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2635.5" y="8321.0747">REQUEST-CONSENT-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="2802.5" y="8321.0747">DFSPBackendRequests.validateConsentRequest()</text><polygon fill="#A80036" points="1877.5,8364.2734,1867.5,8368.2734,1877.5,8372.2734,1873.5,8368.2734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1871.5" x2="2200.5" y1="8368.2734" y2="8368.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1883.5" y="8363.2075">REQUEST-CONSENT-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2050.5" y="8363.2075">202 Accepted</text><polygon fill="#A80036" points="1877.5,8393.4063,1867.5,8397.4063,1877.5,8401.4063,1873.5,8397.4063" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1871.5" x2="2617.5" y1="8397.4063" y2="8397.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1883.5" y="8392.3403">REQUEST-CONSENT-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="2050.5" y="8392.3403">PUT /consentRequests/6789/error</text><rect fill="#F08080" filter="url(#f12un5mu44osrr)" height="325" style="stroke:#A80036;stroke-width:1.0;" width="531" x="2082" y="8410.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="2086" y="8426.4731">PUT /consentRequests/6789/error</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="2086" y="8441.606">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="2086" y="8456.7388">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2086" y="8471.8716">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2094" y="8487.0044">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="2102" y="8502.1372">errorCode: '720x',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="331" x="2102" y="8517.27">errorDescription: 'FSP does not find scopes suitable'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2094" y="8532.4028">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2094" y="8547.5356">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2102" y="8562.6685">errorCode: '7203',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="2102" y="8577.8013">errorDescription: 'FSP does not support any requested authentication channels'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2094" y="8592.9341">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2094" y="8608.0669">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2102" y="8623.1997">errorCode: '7204',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="442" x="2102" y="8638.3325">errorDescription: 'FSP does not support any requested scope actions'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2094" y="8653.4653">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2094" y="8668.5981">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="2102" y="8683.731">errorCode: '720x',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="347" x="2102" y="8698.8638">errorDescription: 'FSP does not trust PISP callback URI'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2094" y="8713.9966">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2086" y="8729.1294">}</text><polygon fill="#A80036" points="2611.5,8758.3281,2621.5,8762.3281,2611.5,8766.3281,2615.5,8762.3281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1866.5" x2="2617.5" y1="8762.3281" y2="8762.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1873.5" y="8757.2622">REQUEST-CONSENT-28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2040.5" y="8757.2622">200 OK</text><polygon fill="#A80036" points="1461.5,8787.4609,1451.5,8791.4609,1461.5,8795.4609,1457.5,8791.4609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1455.5" x2="1855.5" y1="8791.4609" y2="8791.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1467.5" y="8786.395">REQUEST-CONSENT-29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="1634.5" y="8786.395">PUT /consentRequests/6789/error</text><polygon fill="#A80036" points="1849.5,8816.5938,1859.5,8820.5938,1849.5,8824.5938,1853.5,8820.5938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1450.5" x2="1855.5" y1="8820.5938" y2="8820.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1457.5" y="8815.5278">REQUEST-CONSENT-30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1624.5" y="8815.5278">200 OK</text><polygon fill="#A80036" points="1002.5,8845.7266,992.5,8849.7266,1002.5,8853.7266,998.5,8849.7266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="996.5" x2="1444.5" y1="8849.7266" y2="8849.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1008.5" y="8844.6606">REQUEST-CONSENT-31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="1175.5" y="8844.6606">MojaloopFSPIOPError response recieved</text><rect fill="#FBFB77" filter="url(#f12un5mu44osrr)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="996" y="8862.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1000" y="8878.7935">state: errored</text><polygon fill="#A80036" points="589.5,8907.9922,579.5,8911.9922,589.5,8915.9922,585.5,8911.9922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="985.5" y1="8911.9922" y2="8911.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="595.5" y="8906.9263">REQUEST-CONSENT-32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="762.5" y="8906.9263">return MojaloopFSPIOPError</text><polygon fill="#A80036" points="77.5,8937.125,67.5,8941.125,77.5,8945.125,73.5,8941.125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="71.5" x2="572.5" y1="8941.125" y2="8941.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="83.5" y="8936.0591">REQUEST-CONSENT-33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="250.5" y="8936.0591">500 Internal Server Error ErrorInformationObject</text><!--MD5=[ef37aa15dbe92d861328da88f3373b44]
@startuml

title PISP Pre-linking

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box
participant DFSPAuthorizeSimulator

== Pre-Linking ==
autonumber 1 "<b>PRELINKING-#</b>"

PISP -> PISP_TP_OUT: GET /linking/get-dfsps

activate PISP
activate PISP_TP_OUT

rnote right of PISP_TP_OUT: We will need a uuid from the start of the model to link all steps
PISP_TP_OUT -> PISP_TP_OUT: const uuid = uuidv4() ex: 6789
PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
rnote right of PISP_TP_OUT: state: start
PISP_TP_OUT -> PISP_LM: model.getThirdpartyEnabledDFSPs()

activate PISP_LM

rnote right of PISP_LM: state: requestEnabledDFSPLookup
PISP_LM -> PISP_LM: Check cache.\nDFSPs not stored in cache or cache is stale.
PISP_LM -> PISP_LM: ThirdpartyRequests.getServicesById()
PISP_LM -> Switch: GET /services/THIRD_PARTY_DFSP

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM

note over PISP, Switch
  HAPPY_SCENARIO: Switch returns a non-empty list
end note

activate PISP_TP_IN

Switch - -> PISP_TP_IN: PUT /services/THIRD_PARTY_DFSP
rnote left of Switch #LightBlue
PUT /services/THIRD_PARTY_DFSP
{
  serviceProviders: [
    "dfspa", "dfspb"
  ]
}
end note
PISP_TP_IN - -> Switch: 200 OK

deactivate Switch

PISP_TP_IN -> PISP_LM: Services request recieved

deactivate PISP_TP_IN
activate PISP_LM

PISP_LM -> PISP_LM: Store DFSPs in cache
PISP_LM -> PISP_LM: Store DFSPs in model data
rnote right of PISP_LM: state: enabledDFSPLookupSuccess
PISP_LM -> PISP_TP_OUT: return TPEnabledDFSPs

deactivate PISP_LM

PISP_TP_OUT - -> PISP: 200 OK TPEnabledDFSPs

note over PISP, Switch
  ERROR_SCENARIO: Switch receives 7201 error.
  NOTE: What microservice is handling service lookup?
end note

activate PISP_TP_IN
activate Switch

Switch - -> PISP_TP_IN: PUT /services/THIRD_PARTY_DFSP/error
rnote left of Switch #LightCoral
PUT /services/THIRD_PARTY_DFSP/error
{
  errorInformation: {
    errorCode: '7201',
    errorDescription: 'No thirdparty enabled FSP found'
  }
}
end note
PISP_TP_IN - -> Switch: 200 OK

deactivate Switch

PISP_TP_IN -> PISP_LM: ErrorInformationObject recieved

deactivate PISP_TP_IN
activate PISP_LM

PISP_LM -> PISP_LM: throw same error
rnote right of PISP_LM #LightCoral
{
  errorInformation: {
    errorCode: '7201',
    errorDescription: 'No thirdparty enabled FSP found'
  }
}
end note
rnote right of PISP_LM: state: errored
PISP_LM -> PISP_TP_OUT: catch MojaloopFSPIOPError

deactivate PISP_LM

PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject


note over PISP, Switch
  ERROR_SCENARIO: Switch sends back any other error.
end note

activate PISP_TP_IN
activate Switch
Switch - -> PISP_TP_IN: PUT /services/THIRD_PARTY_DFSP/error
rnote left of Switch #LightCoral
PUT /services/THIRD_PARTY_DFSP/error
{
  errorInformation: {
    errorCode: '2001',
    errorDescription: 'Internal server error'
  }
}
end note
PISP_TP_IN - -> Switch: 200 OK

deactivate Switch

PISP_TP_IN -> PISP_LM: Services request recieved

deactivate PISP_TP_IN
activate PISP_LM

PISP_LM -> PISP_LM: throw account linking generic error
rnote right of PISP_LM #LightCoral
{
  errorInformation: {
    errorCode: '7200',
    errorDescription: 'Generic Thirdparty account linking error'
  }
}
end note
rnote right of PISP_LM: state: errored
PISP_LM -> PISP_TP_OUT: catch MojaloopFSPIOPError

deactivate PISP_LM

PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject

deactivate PISP_TP_OUT
deactivate PISP

== Pre-Linking - Cached ==
autonumber 1 "<b>PRELINKING-#</b>"

PISP -> PISP_TP_OUT: GET /linking/get-dfsps

activate PISP
activate PISP_TP_OUT

rnote right of PISP_TP_OUT: We will need a uuid from the start of the model to link all steps
PISP_TP_OUT -> PISP_TP_OUT: const uuid = uuidv4()
PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
PISP_TP_OUT -> PISP_LM: model.getThirdpartyEnabledDFSPs()

activate PISP_LM

rnote right of PISP_LM: state: requestTPEnabledDFSPs
PISP_LM -> PISP_LM: Check cache.\nDFSPs is stored in cache.
PISP_LM -> PISP_LM: Retrieve from cache
rnote right of PISP_LM: state: enabledDFSPLookupSuccess
PISP_LM -> PISP_TP_OUT: return TPEnabledDFSPs

deactivate PISP_LM

PISP_TP_OUT - -> PISP: 200 OK TPEnabledDFSPs

deactivate PISP_TP_OUT
deactivate PISP

== Discovery ==
autonumber 1 "<b>DISCOVERY-#</b>"
rnote right of PISP
PISP presents DFSPs to user. User selects a dfpsa and provides a generic ID to search for associated accounts
end note
PISP -> PISP_TP_OUT: GET /linking/accounts/dfspa/username1234

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS()
PISP_TP_OUT -> PISP_LM: model.getAccounts()

activate PISP_LM

rnote right of PISP_LM: state: requestAccounts
PISP_LM -> PISP_LM: ThirdpartyRequests.getAccounts()
PISP_LM -> Switch: GET /accounts/username1234
rnote right of PISP_LM #LightBlue
GET /accounts/username1234
FSIOP-Source: pispa
FSIOP-Destination: dfspa
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM

Switch -> DFSP_TP_IN: GET /accounts/username1234
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch

rnote right of DFSP_TP_IN #LightBlue
NOTE: What identifier do we use that this state machine can be
      pulled from cache so that we can have one giant state machine?
      Do we pass the DFSP the uuid made in PRELINKING-2 so it can use that
      as a key?
end note
DFSP_TP_IN -> DFSP_TP_IN: const model = await create()
DFSP_TP_IN -> DFSP_LM: model.retrieveAccounts()
deactivate DFSP_TP_IN

note over PISP, DFSP_LM
  HAPPY_SCENARIO: DFSP returns list of accounts.
end note

activate DFSP_LM
DFSP_LM -> DFSP_LM: DFSPBackendRequests.getUserAccounts('username1234')
DFSP_LM -> DFSP_LM: Accounts returned.
rnote right of DFSP_LM: state: accountsRetrieved

rnote left of DFSP_LM #LightBlue
NOTE: This deviates from the original design document.
      Which has the response as a top-level array which
      is a security and expandability risk.
      Fixing that here.
PUT /accounts/username1234
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  "accounts": [
    { accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },
    { accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }
  ]
}
end note

DFSP_LM -> Switch: PUT /accounts/username1234
activate Switch
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM

Switch - -> PISP_TP_IN: PUT /accounts/username1234
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch

PISP_TP_IN -> PISP_LM: Accounts response recieved
rnote right of PISP_LM: state: accountLookupSuccess
deactivate PISP_TP_IN
activate PISP_LM
PISP_LM -> PISP_TP_OUT: return Accounts
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Accounts


note over PISP, DFSP_LM
  ERROR_SCENARIO: Switch receives 7202 No accounts found for generic ID error.
end note

activate DFSP_LM
DFSP_LM -> DFSP_LM: DFSPBackendRequests.getUserAccounts('username1234')
DFSP_LM -> DFSP_LM: No accounts returned.
DFSP_LM -> DFSP_LM: throw MojaloopFSPIOPError

rnote right of DFSP_LM: state: errored
rnote left of DFSP_LM #LightCoral
PUT /accounts/username1234/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '7202',
    errorDescription: 'No accounts found for generic ID'
  }
}
end note

DFSP_LM -> Switch: PUT /accounts/username1234/error
activate Switch
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM

Switch - -> PISP_TP_IN: PUT /accounts/username1234/error
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch

PISP_TP_IN -> PISP_LM: MojaloopFSPIOPError response recieved
deactivate PISP_TP_IN
activate PISP_LM
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
rnote right of PISP_LM: state: errored
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP

== Request Consent - Web ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: [
      'accounts.getBalance',
      'accounts.transfer'
    ],
    accountId: 'dfspa.username.5678',
    actions: [
      'accounts.getBalance',
      'accounts.transfer'
    ]
  }],
  callbackURI: 'pisp-app://callback'
}
end note


activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS()
PISP_TP_OUT -> PISP_LM: model.requestConsent()

activate PISP_LM

rnote right of PISP_LM: state: requestConsent
PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  // consentRequestId will be the uuid created
  // at the PRELINKING-2
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  // model will add `authChannels`
  authChannels: ["WEB", "OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM

Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS()
activate DFSP_LM
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()
activate DFSPAuthorizeSimulator
DFSP_LM -> DFSPAuthorizeSimulator: ""POST /store/consentRequests/6789""
DFSPAuthorizeSimulator -> DFSPAuthorizeSimulator: store consentRequest details
DFSPAuthorizeSimulator -> DFSP_LM: 201 Created
deactivate DFSPAuthorizeSimulator
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate DFSP_TP_IN


activate Switch
DFSP_LM -> Switch: PUT /consentRequests/6789

rnote left of DFSP_LM #LightBlue
PUT /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  authChannels: ["WEB"],
  callbackURI: 'pisp-app://callback...',
  authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
activate PISP_TP_IN
Switch ->  PISP_TP_IN: PUT /consentRequests/6789
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: Consent Request response recieved
rnote right of PISP_LM: state: webAuthenticationChannelResponseRecieved
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return Authentication Response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Autentication Response

note over PISP, DFSP_LM
  ERROR_SCENARIO:
    FSP does not find scopes suitable |
    FSP does not support any requested authentication channels |
    FSP does not support any requested scope actions |
    FSP does not trust PISP callback URI
end note

activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS()
activate DFSP_LM
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()

DFSP_TP_IN - -> Switch: 202 Accepted
deactivate DFSP_TP_IN

activate Switch
DFSP_LM -> Switch: PUT /consentRequests/6789/error

rnote left of DFSP_LM #LightCoral
PUT /consentRequests/6789/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '720x',
    errorDescription: 'FSP does not find scopes suitable'
  } OR
  errorInformation: {
    errorCode: '7203',
    errorDescription: 'FSP does not support any requested authentication channels'
  } OR
  errorInformation: {
    errorCode: '7204',
    errorDescription: 'FSP does not support any requested scope actions'
  } OR
  errorInformation: {
    errorCode: '720x',
    errorDescription: 'FSP does not trust PISP callback URI'
  }
}
end note
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
activate PISP_TP_IN
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consentRequests/6789/error
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: MojaloopFSPIOPError response recieved
rnote right of PISP_LM: state: errored
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP

== Request Consent - OTP ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: [
      'accounts.getBalance',
      'accounts.transfer'
    ],
    accountId: 'dfspa.username.5678',
    actions: [
      'accounts.getBalance',
      'accounts.transfer'
    ]
  }],
  callbackURI: 'pisp-app://callback'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS()
PISP_TP_OUT -> PISP_LM: model.requestConsent()

activate PISP_LM

rnote right of PISP_LM: state: requestConsent
PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  // consentRequestId will be the uuid created
  // at the PRELINKING-2
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  // model will add `authChannels`
  authChannels: ["OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM

Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS()
activate DFSP_LM
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()

activate DFSPAuthorizeSimulator
DFSP_LM -> DFSPAuthorizeSimulator: ""POST /store/consentRequests/6789""
DFSPAuthorizeSimulator -> DFSPAuthorizeSimulator: store consentRequest details
DFSPAuthorizeSimulator -> DFSP_LM: 201 Created
deactivate DFSPAuthorizeSimulator

DFSP_TP_IN - -> Switch: 202 Accepted
deactivate DFSP_TP_IN


activate Switch
DFSP_LM -> Switch: PUT /consentRequests/6789

rnote left of DFSP_LM #LightBlue
PUT /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  authChannels: ["OTP"],
  callbackURI: 'pisp-app://callback...',
  authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
activate PISP_TP_IN
Switch ->  PISP_TP_IN: PUT /consentRequests/6789
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: Consent Request response recieved
rnote right of PISP_LM: state: OTPAuthenticationChannelResponseRecieved
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return Authentication Response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Autentication Response

note over PISP, DFSP_LM
  ERROR_SCENARIO:
    FSP does not find scopes suitable |
    FSP does not support any requested authentication channels |
    FSP does not support any requested scope actions |
    FSP does not trust PISP callback URI
end note

activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS()
activate DFSP_LM
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()

DFSP_TP_IN - -> Switch: 202 Accepted
deactivate DFSP_TP_IN

activate Switch
DFSP_LM -> Switch: PUT /consentRequests/6789/error

rnote left of DFSP_LM #LightCoral
PUT /consentRequests/6789/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '720x',
    errorDescription: 'FSP does not find scopes suitable'
  } OR
  errorInformation: {
    errorCode: '7203',
    errorDescription: 'FSP does not support any requested authentication channels'
  } OR
  errorInformation: {
    errorCode: '7204',
    errorDescription: 'FSP does not support any requested scope actions'
  } OR
  errorInformation: {
    errorCode: '720x',
    errorDescription: 'FSP does not trust PISP callback URI'
  }
}
end note
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
activate PISP_TP_IN
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consentRequests/6789/error
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: MojaloopFSPIOPError response recieved
rnote right of PISP_LM: state: errored
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP

@enduml

@startuml

title PISP Pre-linking

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box
participant DFSPAuthorizeSimulator

== Pre-Linking ==
autonumber 1 "<b>PRELINKING-#</b>"

PISP -> PISP_TP_OUT: GET /linking/get-dfsps

activate PISP
activate PISP_TP_OUT

rnote right of PISP_TP_OUT: We will need a uuid from the start of the model to link all steps
PISP_TP_OUT -> PISP_TP_OUT: const uuid = uuidv4() ex: 6789
PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
rnote right of PISP_TP_OUT: state: start
PISP_TP_OUT -> PISP_LM: model.getThirdpartyEnabledDFSPs()

activate PISP_LM

rnote right of PISP_LM: state: requestEnabledDFSPLookup
PISP_LM -> PISP_LM: Check cache.\nDFSPs not stored in cache or cache is stale.
PISP_LM -> PISP_LM: ThirdpartyRequests.getServicesById()
PISP_LM -> Switch: GET /services/THIRD_PARTY_DFSP

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM

note over PISP, Switch
  HAPPY_SCENARIO: Switch returns a non-empty list
end note

activate PISP_TP_IN

Switch - -> PISP_TP_IN: PUT /services/THIRD_PARTY_DFSP
rnote left of Switch #LightBlue
PUT /services/THIRD_PARTY_DFSP
{
  serviceProviders: [
    "dfspa", "dfspb"
  ]
}
end note
PISP_TP_IN - -> Switch: 200 OK

deactivate Switch

PISP_TP_IN -> PISP_LM: Services request recieved

deactivate PISP_TP_IN
activate PISP_LM

PISP_LM -> PISP_LM: Store DFSPs in cache
PISP_LM -> PISP_LM: Store DFSPs in model data
rnote right of PISP_LM: state: enabledDFSPLookupSuccess
PISP_LM -> PISP_TP_OUT: return TPEnabledDFSPs

deactivate PISP_LM

PISP_TP_OUT - -> PISP: 200 OK TPEnabledDFSPs

note over PISP, Switch
  ERROR_SCENARIO: Switch receives 7201 error.
  NOTE: What microservice is handling service lookup?
end note

activate PISP_TP_IN
activate Switch

Switch - -> PISP_TP_IN: PUT /services/THIRD_PARTY_DFSP/error
rnote left of Switch #LightCoral
PUT /services/THIRD_PARTY_DFSP/error
{
  errorInformation: {
    errorCode: '7201',
    errorDescription: 'No thirdparty enabled FSP found'
  }
}
end note
PISP_TP_IN - -> Switch: 200 OK

deactivate Switch

PISP_TP_IN -> PISP_LM: ErrorInformationObject recieved

deactivate PISP_TP_IN
activate PISP_LM

PISP_LM -> PISP_LM: throw same error
rnote right of PISP_LM #LightCoral
{
  errorInformation: {
    errorCode: '7201',
    errorDescription: 'No thirdparty enabled FSP found'
  }
}
end note
rnote right of PISP_LM: state: errored
PISP_LM -> PISP_TP_OUT: catch MojaloopFSPIOPError

deactivate PISP_LM

PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject


note over PISP, Switch
  ERROR_SCENARIO: Switch sends back any other error.
end note

activate PISP_TP_IN
activate Switch
Switch - -> PISP_TP_IN: PUT /services/THIRD_PARTY_DFSP/error
rnote left of Switch #LightCoral
PUT /services/THIRD_PARTY_DFSP/error
{
  errorInformation: {
    errorCode: '2001',
    errorDescription: 'Internal server error'
  }
}
end note
PISP_TP_IN - -> Switch: 200 OK

deactivate Switch

PISP_TP_IN -> PISP_LM: Services request recieved

deactivate PISP_TP_IN
activate PISP_LM

PISP_LM -> PISP_LM: throw account linking generic error
rnote right of PISP_LM #LightCoral
{
  errorInformation: {
    errorCode: '7200',
    errorDescription: 'Generic Thirdparty account linking error'
  }
}
end note
rnote right of PISP_LM: state: errored
PISP_LM -> PISP_TP_OUT: catch MojaloopFSPIOPError

deactivate PISP_LM

PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject

deactivate PISP_TP_OUT
deactivate PISP

== Pre-Linking - Cached ==
autonumber 1 "<b>PRELINKING-#</b>"

PISP -> PISP_TP_OUT: GET /linking/get-dfsps

activate PISP
activate PISP_TP_OUT

rnote right of PISP_TP_OUT: We will need a uuid from the start of the model to link all steps
PISP_TP_OUT -> PISP_TP_OUT: const uuid = uuidv4()
PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
PISP_TP_OUT -> PISP_LM: model.getThirdpartyEnabledDFSPs()

activate PISP_LM

rnote right of PISP_LM: state: requestTPEnabledDFSPs
PISP_LM -> PISP_LM: Check cache.\nDFSPs is stored in cache.
PISP_LM -> PISP_LM: Retrieve from cache
rnote right of PISP_LM: state: enabledDFSPLookupSuccess
PISP_LM -> PISP_TP_OUT: return TPEnabledDFSPs

deactivate PISP_LM

PISP_TP_OUT - -> PISP: 200 OK TPEnabledDFSPs

deactivate PISP_TP_OUT
deactivate PISP

== Discovery ==
autonumber 1 "<b>DISCOVERY-#</b>"
rnote right of PISP
PISP presents DFSPs to user. User selects a dfpsa and provides a generic ID to search for associated accounts
end note
PISP -> PISP_TP_OUT: GET /linking/accounts/dfspa/username1234

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS()
PISP_TP_OUT -> PISP_LM: model.getAccounts()

activate PISP_LM

rnote right of PISP_LM: state: requestAccounts
PISP_LM -> PISP_LM: ThirdpartyRequests.getAccounts()
PISP_LM -> Switch: GET /accounts/username1234
rnote right of PISP_LM #LightBlue
GET /accounts/username1234
FSIOP-Source: pispa
FSIOP-Destination: dfspa
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM

Switch -> DFSP_TP_IN: GET /accounts/username1234
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch

rnote right of DFSP_TP_IN #LightBlue
NOTE: What identifier do we use that this state machine can be
      pulled from cache so that we can have one giant state machine?
      Do we pass the DFSP the uuid made in PRELINKING-2 so it can use that
      as a key?
end note
DFSP_TP_IN -> DFSP_TP_IN: const model = await create()
DFSP_TP_IN -> DFSP_LM: model.retrieveAccounts()
deactivate DFSP_TP_IN

note over PISP, DFSP_LM
  HAPPY_SCENARIO: DFSP returns list of accounts.
end note

activate DFSP_LM
DFSP_LM -> DFSP_LM: DFSPBackendRequests.getUserAccounts('username1234')
DFSP_LM -> DFSP_LM: Accounts returned.
rnote right of DFSP_LM: state: accountsRetrieved

rnote left of DFSP_LM #LightBlue
NOTE: This deviates from the original design document.
      Which has the response as a top-level array which
      is a security and expandability risk.
      Fixing that here.
PUT /accounts/username1234
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  "accounts": [
    { accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },
    { accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }
  ]
}
end note

DFSP_LM -> Switch: PUT /accounts/username1234
activate Switch
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM

Switch - -> PISP_TP_IN: PUT /accounts/username1234
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch

PISP_TP_IN -> PISP_LM: Accounts response recieved
rnote right of PISP_LM: state: accountLookupSuccess
deactivate PISP_TP_IN
activate PISP_LM
PISP_LM -> PISP_TP_OUT: return Accounts
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Accounts


note over PISP, DFSP_LM
  ERROR_SCENARIO: Switch receives 7202 No accounts found for generic ID error.
end note

activate DFSP_LM
DFSP_LM -> DFSP_LM: DFSPBackendRequests.getUserAccounts('username1234')
DFSP_LM -> DFSP_LM: No accounts returned.
DFSP_LM -> DFSP_LM: throw MojaloopFSPIOPError

rnote right of DFSP_LM: state: errored
rnote left of DFSP_LM #LightCoral
PUT /accounts/username1234/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '7202',
    errorDescription: 'No accounts found for generic ID'
  }
}
end note

DFSP_LM -> Switch: PUT /accounts/username1234/error
activate Switch
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM

Switch - -> PISP_TP_IN: PUT /accounts/username1234/error
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch

PISP_TP_IN -> PISP_LM: MojaloopFSPIOPError response recieved
deactivate PISP_TP_IN
activate PISP_LM
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
rnote right of PISP_LM: state: errored
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP

== Request Consent - Web ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: [
    ],
    accountId: 'dfspa.username.5678',
    actions: [
    ]
  }],
  callbackURI: 'pisp-app://callback'
}
end note


activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS()
PISP_TP_OUT -> PISP_LM: model.requestConsent()

activate PISP_LM

rnote right of PISP_LM: state: requestConsent
PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  // consentRequestId will be the uuid created
  // at the PRELINKING-2
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  // model will add `authChannels`
  authChannels: ["WEB", "OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM

Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS()
activate DFSP_LM
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()
activate DFSPAuthorizeSimulator
DFSP_LM -> DFSPAuthorizeSimulator: ""POST /store/consentRequests/6789""
DFSPAuthorizeSimulator -> DFSPAuthorizeSimulator: store consentRequest details
DFSPAuthorizeSimulator -> DFSP_LM: 201 Created
deactivate DFSPAuthorizeSimulator
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate DFSP_TP_IN


activate Switch
DFSP_LM -> Switch: PUT /consentRequests/6789

rnote left of DFSP_LM #LightBlue
PUT /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  authChannels: ["WEB"],
  callbackURI: 'pisp-app://callback...',
  authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
activate PISP_TP_IN
Switch ->  PISP_TP_IN: PUT /consentRequests/6789
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: Consent Request response recieved
rnote right of PISP_LM: state: webAuthenticationChannelResponseRecieved
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return Authentication Response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Autentication Response

note over PISP, DFSP_LM
  ERROR_SCENARIO:
    FSP does not find scopes suitable |
    FSP does not support any requested authentication channels |
    FSP does not support any requested scope actions |
    FSP does not trust PISP callback URI
end note

activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS()
activate DFSP_LM
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()

DFSP_TP_IN - -> Switch: 202 Accepted
deactivate DFSP_TP_IN

activate Switch
DFSP_LM -> Switch: PUT /consentRequests/6789/error

rnote left of DFSP_LM #LightCoral
PUT /consentRequests/6789/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '720x',
    errorDescription: 'FSP does not find scopes suitable'
  } OR
  errorInformation: {
    errorCode: '7203',
    errorDescription: 'FSP does not support any requested authentication channels'
  } OR
  errorInformation: {
    errorCode: '7204',
    errorDescription: 'FSP does not support any requested scope actions'
  } OR
  errorInformation: {
    errorCode: '720x',
    errorDescription: 'FSP does not trust PISP callback URI'
  }
}
end note
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
activate PISP_TP_IN
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consentRequests/6789/error
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: MojaloopFSPIOPError response recieved
rnote right of PISP_LM: state: errored
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP

== Request Consent - OTP ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: [
    ],
    accountId: 'dfspa.username.5678',
    actions: [
    ]
  }],
  callbackURI: 'pisp-app://callback'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS()
PISP_TP_OUT -> PISP_LM: model.requestConsent()

activate PISP_LM

rnote right of PISP_LM: state: requestConsent
PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  // consentRequestId will be the uuid created
  // at the PRELINKING-2
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  // model will add `authChannels`
  authChannels: ["OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM

Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS()
activate DFSP_LM
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()

activate DFSPAuthorizeSimulator
DFSP_LM -> DFSPAuthorizeSimulator: ""POST /store/consentRequests/6789""
DFSPAuthorizeSimulator -> DFSPAuthorizeSimulator: store consentRequest details
DFSPAuthorizeSimulator -> DFSP_LM: 201 Created
deactivate DFSPAuthorizeSimulator

DFSP_TP_IN - -> Switch: 202 Accepted
deactivate DFSP_TP_IN


activate Switch
DFSP_LM -> Switch: PUT /consentRequests/6789

rnote left of DFSP_LM #LightBlue
PUT /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  authChannels: ["OTP"],
  callbackURI: 'pisp-app://callback...',
  authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
activate PISP_TP_IN
Switch ->  PISP_TP_IN: PUT /consentRequests/6789
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: Consent Request response recieved
rnote right of PISP_LM: state: OTPAuthenticationChannelResponseRecieved
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return Authentication Response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Autentication Response

note over PISP, DFSP_LM
  ERROR_SCENARIO:
    FSP does not find scopes suitable |
    FSP does not support any requested authentication channels |
    FSP does not support any requested scope actions |
    FSP does not trust PISP callback URI
end note

activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS()
activate DFSP_LM
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()

DFSP_TP_IN - -> Switch: 202 Accepted
deactivate DFSP_TP_IN

activate Switch
DFSP_LM -> Switch: PUT /consentRequests/6789/error

rnote left of DFSP_LM #LightCoral
PUT /consentRequests/6789/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '720x',
    errorDescription: 'FSP does not find scopes suitable'
  } OR
  errorInformation: {
    errorCode: '7203',
    errorDescription: 'FSP does not support any requested authentication channels'
  } OR
  errorInformation: {
    errorCode: '7204',
    errorDescription: 'FSP does not support any requested scope actions'
  } OR
  errorInformation: {
    errorCode: '720x',
    errorDescription: 'FSP does not trust PISP callback URI'
  }
}
end note
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
activate PISP_TP_IN
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consentRequests/6789/error
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: MojaloopFSPIOPError response recieved
rnote right of PISP_LM: state: errored
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP

@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
