<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="6816px" preserveAspectRatio="none" style="width:4686px;height:6816px;" version="1.1" viewBox="0 0 4686 6816" width="4686px" zoomAndPan="magnify"><defs><filter height="300%" id="f1ryulwit6ran0" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="155" x="2262.25" y="28.708">PISP Linking Web</text><rect fill="#DDDDDD" height="6769.9844" style="stroke:#A80036;stroke-width:1.0;" width="1122.5" x="484.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="955.75" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="6769.9844" style="stroke:#A80036;stroke-width:1.0;" width="920.5" x="2022" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="2448.75" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="6769.9844" style="stroke:#A80036;stroke-width:1.0;" width="658" x="3213" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="3449" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="1535.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="4620.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="2143.0703"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="1535.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="4620.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="2143.0703"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="387.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="446.2422"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="104.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="1604.8828"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="2326"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="618.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="3520.375"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="6525.3125"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="1546.6172"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="3449.1094"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="6454.0469"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="332.3906" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="559.6406"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="374.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="1201.2266"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="196.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="2397.2656"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3251.7813"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="485.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3849.8359"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="954.9766" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="4514.5547"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="6256.7188"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2400.5" y="4875.0781"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2841.5" y="5498.6641"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="862.8984"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="2564.3281"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="4168.2266"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5293.8672"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5556.9297"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="514.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="996.4297"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="722.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="2697.8594"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="566.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="4272.625"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="984.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="5440.3984"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="71.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="4297.5" y="1067.6953"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="2016" y="5822.8594"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="76" x2="76" y1="95.3828" y2="6772.6406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="555.5" x2="555.5" y1="95.3828" y2="6772.6406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1031.5" x2="1031.5" y1="95.3828" y2="6772.6406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1541" x2="1541" y1="95.3828" y2="6772.6406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2057" x2="2057" y1="95.3828" y2="6772.6406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2405.5" x2="2405.5" y1="95.3828" y2="6772.6406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2846.5" x2="2846.5" y1="95.3828" y2="6772.6406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3278" x2="3278" y1="95.3828" y2="6772.6406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3794" x2="3794" y1="95.3828" y2="6772.6406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="4302" x2="4302" y1="95.3828" y2="6772.6406"/><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="20" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="27" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="20" y="6771.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="27" y="6791.6357">PISP Backend</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="488.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="495.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="488.5" y="6771.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="495.5" y="6791.6357">outbound-server</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="962.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="969.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="962.5" y="6771.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="969.5" y="6791.6357">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1480" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1487" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1480" y="6771.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1487" y="6791.6357">inbound-server</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2026" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2033" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2026" y="6771.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2033" y="6791.6357">Switch</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2353.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2360.5" y="80.0811">Auth Service</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2353.5" y="6771.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2360.5" y="6791.6357">Auth Service</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2754.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2761.5" y="80.0811">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2754.5" y="6771.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2761.5" y="6791.6357">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3217" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3224" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3217" y="6771.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3224" y="6791.6357">inbound-server</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3722" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3729" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3722" y="6771.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3729" y="6791.6357">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4210" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4217" y="80.0811">DFSPAuthorizeSimulator</text><rect fill="#FEFECE" filter="url(#f1ryulwit6ran0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4210" y="6771.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4217" y="6791.6357">DFSPAuthorizeSimulator</text><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="1535.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="4620.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="2143.0703"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="1535.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="4620.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="2143.0703"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="387.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="446.2422"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="104.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="1604.8828"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="2326"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="618.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="3520.375"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="6525.3125"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="1546.6172"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="3449.1094"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="6454.0469"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="332.3906" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="559.6406"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="374.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="1201.2266"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="196.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="2397.2656"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3251.7813"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="485.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3849.8359"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="954.9766" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="4514.5547"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="6256.7188"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2400.5" y="4875.0781"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2841.5" y="5498.6641"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="862.8984"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="2564.3281"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="4168.2266"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5293.8672"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5556.9297"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="514.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="996.4297"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="722.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="2697.8594"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="566.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="4272.625"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="984.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="5440.3984"/><rect fill="#FFFFFF" filter="url(#f1ryulwit6ran0)" height="71.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="4297.5" y="1067.6953"/><rect fill="#EEEEEE" filter="url(#f1ryulwit6ran0)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4679.5" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4679.5" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4679.5" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#f1ryulwit6ran0)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="193" x="2243.25" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="174" x="2249.25" y="131.4497">Request Consent - Web</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="485" x="81" y="153.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="85" y="169.5825">PISP presents accounts to user. User selects one or more accounts to link.</text><polygon fill="#A80036" points="538.5,198.7813,548.5,202.7813,538.5,206.7813,542.5,202.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="544.5" y1="202.7813" y2="202.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="88.5" y="197.7153">REQUEST-CONSENT-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="246.5" y="197.7153">POST /linking/request-consent</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="570" x="86" y="215.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="90" y="231.8481">POST /linking/request-consent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="246.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="98" y="262.1138">accounts: [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="106" y="277.2466">{ accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="546" x="106" y="292.3794">{ accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="98" y="307.5122">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="98" y="322.645">callbackURI: 'pisp-app://callback'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="337.7778">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="602.5" y1="370.9766" y2="370.9766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="602.5" y1="370.9766" y2="383.9766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="561.5" x2="602.5" y1="383.9766" y2="383.9766"/><polygon fill="#A80036" points="571.5,379.9766,561.5,383.9766,571.5,387.9766,567.5,383.9766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="567.5" y="365.9106">REQUEST-CONSENT-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="725.5" y="365.9106">const model = await create()</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="565" y="396.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="569" y="413.0435">state: start</text><polygon fill="#A80036" points="1014.5,442.2422,1024.5,446.2422,1014.5,450.2422,1018.5,446.2422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="1020.5" y1="446.2422" y2="446.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="567.5" y="441.1763">REQUEST-CONSENT-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="725.5" y="441.1763">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="475.375" y2="475.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="475.375" y2="488.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="488.375" y2="488.375"/><polygon fill="#A80036" points="1047.5,484.375,1037.5,488.375,1047.5,492.375,1043.5,488.375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="470.3091">REQUEST-CONSENT-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1201.5" y="470.3091">ThirdpartyRequests.postConsentRequests()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="517.5078" y2="517.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="517.5078" y2="530.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="530.5078" y2="530.5078"/><polygon fill="#A80036" points="1047.5,526.5078,1037.5,530.5078,1047.5,534.5078,1043.5,530.5078" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="512.4419">REQUEST-CONSENT-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="1201.5" y="512.4419">const consentRequestId = uuid()</text><polygon fill="#A80036" points="2040.5,555.6406,2050.5,559.6406,2040.5,563.6406,2044.5,559.6406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="559.6406" y2="559.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="554.5747">REQUEST-CONSENT-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1201.5" y="554.5747">POST /consentRequests</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1041" y="572.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1045" y="588.7075">POST /consentRequests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="603.8403">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="618.9731">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="634.106">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1053" y="649.2388">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1053" y="664.3716">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="679.5044">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="694.6372">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="709.77">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="724.9028">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1053" y="740.0356">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1053" y="755.1685">// model will add `authChannels`</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="1053" y="770.3013">authChannels: ["WEB", "OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216" x="1053" y="785.4341">callbackURI: 'pisp-app://callback...'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="800.5669">}</text><polygon fill="#A80036" points="1042.5,829.7656,1032.5,833.7656,1042.5,837.7656,1038.5,833.7656" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="833.7656" y2="833.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1048.5" y="828.6997">REQUEST-CONSENT-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1206.5" y="828.6997">202 Accepted</text><polygon fill="#A80036" points="3261.5,858.8984,3271.5,862.8984,3261.5,866.8984,3265.5,862.8984" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="862.8984" y2="862.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2069.5" y="857.8325">REQUEST-CONSENT-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="2227.5" y="857.8325">POST /consentRequests</text><polygon fill="#A80036" points="2068.5,888.0313,2058.5,892.0313,2068.5,896.0313,2064.5,892.0313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3272.5" y1="892.0313" y2="892.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2074.5" y="886.9653">REQUEST-CONSENT-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2232.5" y="886.9653">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="921.1641" y2="921.1641"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="921.1641" y2="934.1641"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="934.1641" y2="934.1641"/><polygon fill="#A80036" points="3294.5,930.1641,3284.5,934.1641,3294.5,938.1641,3290.5,934.1641" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3290.5" y="916.0981">REQUEST-CONSENT-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="3457.5" y="916.0981">const model = await create()</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="3288" y="947.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="3292" y="963.231">state: start</text><polygon fill="#A80036" points="3777.5,992.4297,3787.5,996.4297,3777.5,1000.4297,3781.5,996.4297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3278.5" x2="3783.5" y1="996.4297" y2="996.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3285.5" y="991.3638">REQUEST-CONSENT-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="3452.5" y="991.3638">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="1025.5625" y2="1025.5625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="1025.5625" y2="1038.5625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="1038.5625" y2="1038.5625"/><polygon fill="#A80036" points="3810.5,1034.5625,3800.5,1038.5625,3810.5,1042.5625,3806.5,1038.5625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3806.5" y="1020.4966">REQUEST-CONSENT-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="3973.5" y="1020.4966">DFSPBackendRequests.validateConsentRequest()</text><polygon fill="#A80036" points="4285.5,1063.6953,4295.5,1067.6953,4285.5,1071.6953,4289.5,1067.6953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="4291.5" y1="1067.6953" y2="1067.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3806.5" y="1062.6294">REQUEST-CONSENT-13</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="256" x="3973.5" y="1062.6294">POSTÂ /store/consentRequests/6789</text><line style="stroke:#A80036;stroke-width:1.0;" x1="4307.5" x2="4349.5" y1="1096.8281" y2="1096.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="4349.5" x2="4349.5" y1="1096.8281" y2="1109.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="4308.5" x2="4349.5" y1="1109.8281" y2="1109.8281"/><polygon fill="#A80036" points="4318.5,1105.8281,4308.5,1109.8281,4318.5,1113.8281,4314.5,1109.8281" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="4314.5" y="1091.7622">REQUEST-CONSENT-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="4481.5" y="1091.7622">store consentRequest details</text><polygon fill="#A80036" points="3810.5,1134.9609,3800.5,1138.9609,3810.5,1142.9609,3806.5,1138.9609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="4301.5" y1="1138.9609" y2="1138.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3816.5" y="1133.895">REQUEST-CONSENT-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3983.5" y="1133.895">201 Created</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3804" y="1151.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3808" y="1168.0278">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="2073.5,1197.2266,2063.5,1201.2266,2073.5,1205.2266,2069.5,1201.2266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="1201.2266" y2="1201.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2079.5" y="1196.1606">REQUEST-CONSENT-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="2246.5" y="1196.1606">PUT /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="457" x="3327" y="1214.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="3331" y="1230.2935">PUT /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3331" y="1245.4263">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="3331" y="1260.5591">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3331" y="1275.6919">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3339" y="1290.8247">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3339" y="1305.9575">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3347" y="1321.0903">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3347" y="1336.2231">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3347" y="1351.356">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3347" y="1366.4888">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3339" y="1381.6216">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="3339" y="1396.7544">authChannels: ["WEB"], // updated with the channel in use</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3339" y="1411.8872">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441" x="3339" y="1427.02">authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3331" y="1442.1528">}</text><polygon fill="#A80036" points="3777.5,1471.3516,3787.5,1475.3516,3777.5,1479.3516,3781.5,1475.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3783.5" y1="1475.3516" y2="1475.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2069.5" y="1470.2856">REQUEST-CONSENT-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2236.5" y="1470.2856">202 ACCEPTED</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="1509.4844" y2="1509.4844"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="1509.4844" y2="1522.4844"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3794.5" x2="3841.5" y1="1522.4844" y2="1522.4844"/><polygon fill="#A80036" points="3804.5,1518.4844,3794.5,1522.4844,3804.5,1526.4844,3800.5,1522.4844" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3806.5" y="1504.4185">REQUEST-CONSENT-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="3973.5" y="1504.4185">this.saveToKVS()</text><polygon fill="#A80036" points="1557.5,1542.6172,1547.5,1546.6172,1557.5,1550.6172,1553.5,1546.6172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="1546.6172" y2="1546.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1563.5" y="1541.5513">REQUEST-CONSENT-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="1730.5" y="1541.5513">PUT /consentRequests/6789</text><polygon fill="#A80036" points="2045.5,1571.75,2055.5,1575.75,2045.5,1579.75,2049.5,1575.75" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1546.5" x2="2051.5" y1="1575.75" y2="1575.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1553.5" y="1570.6841">REQUEST-CONSENT-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1720.5" y="1570.6841">200 OK</text><polygon fill="#A80036" points="1047.5,1600.8828,1037.5,1604.8828,1047.5,1608.8828,1043.5,1604.8828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1041.5" x2="1540.5" y1="1604.8828" y2="1604.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1053.5" y="1599.8169">REQUEST-CONSENT-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="1220.5" y="1599.8169">Consent Request response recieved</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="338" x="1041" y="1617.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="330" x="1045" y="1633.9497">state: webAuthenticationChannelResponseRecieved</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="1667.1484" y2="1667.1484"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="1667.1484" y2="1680.1484"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1037.5" x2="1078.5" y1="1680.1484" y2="1680.1484"/><polygon fill="#A80036" points="1047.5,1676.1484,1037.5,1680.1484,1047.5,1684.1484,1043.5,1680.1484" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1043.5" y="1662.0825">REQUEST-CONSENT-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="1210.5" y="1662.0825">this.saveToKVS()</text><polygon fill="#A80036" points="571.5,1705.2813,561.5,1709.2813,571.5,1713.2813,567.5,1709.2813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="565.5" x2="1030.5" y1="1709.2813" y2="1709.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="577.5" y="1704.2153">REQUEST-CONSENT-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="744.5" y="1704.2153">return Authentication Response</text><polygon fill="#A80036" points="87.5,1734.4141,77.5,1738.4141,87.5,1742.4141,83.5,1738.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="81.5" x2="554.5" y1="1738.4141" y2="1738.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="93.5" y="1733.3481">REQUEST-CONSENT-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="260.5" y="1733.3481">200 OK Autentication Response</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="465" x="85" y="1751.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="89" y="1767.481">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="97" y="1782.6138">channelResponse: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="105" y="1797.7466">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="105" y="1812.8794">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="113" y="1828.0122">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="113" y="1843.145">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="113" y="1858.2778">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="113" y="1873.4106">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="105" y="1888.5435">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="105" y="1903.6763">authChannels: ["WEB"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="105" y="1918.8091">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441" x="105" y="1933.9419">authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="97" y="1949.0747">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="97" y="1964.2075">currentState="OTPAuthenticationChannelResponseRecieved"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="89" y="1979.3403">}</text><path d="M5,1996.4063 L5,2036.4063 L4375,2036.4063 L4375,2006.4063 L4365,1996.4063 L5,1996.4063 " fill="#FBFB77" filter="url(#f1ryulwit6ran0)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M4365,1996.4063 L4365,2006.4063 L4375,2006.4063 L4365,1996.4063 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="784" x="1791.5" y="2013.4731">The PISP is expected to redirect to the DFSP's `authUri` in their application to let the end user complete the web login flow.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="580" x="1791.5" y="2028.606">Logging in successfully should provide the PISP with a secret to use in the next linking step.</text><rect fill="#EEEEEE" filter="url(#f1ryulwit6ran0)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4679.5" x="0" y="2066.2383"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4679.5" y1="2066.2383" y2="2066.2383"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4679.5" y1="2069.2383" y2="2069.2383"/><rect fill="#EEEEEE" filter="url(#f1ryulwit6ran0)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="397" x="2141.25" y="2055.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="378" x="2147.25" y="2071.7388">Authentication+Grant Consent+Register Credential</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="503" x="81" y="2093.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495" x="85" y="2109.8716">PISP has obtained authToken from end-user(OTP) or through a callback(Web).</text><polygon fill="#A80036" points="538.5,2139.0703,548.5,2143.0703,538.5,2147.0703,542.5,2143.0703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="544.5" y1="2143.0703" y2="2143.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="88.5" y="2138.0044">AUTHENTICATION-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="231.5" y="2138.0044">POST /linking/request-consent/6789/authenticate</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="320" x="86" y="2156.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="90" y="2172.1372">POST /linking/request-consent/6789/authenticate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="2187.27">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="98" y="2202.4028">authToken: '123456'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="2217.5356">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="602.5" y1="2250.7344" y2="2250.7344"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="602.5" y1="2250.7344" y2="2263.7344"/><line style="stroke:#A80036;stroke-width:1.0;" x1="561.5" x2="602.5" y1="2263.7344" y2="2263.7344"/><polygon fill="#A80036" points="571.5,2259.7344,561.5,2263.7344,571.5,2267.7344,567.5,2263.7344" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="567.5" y="2245.6685">AUTHENTICATION-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="710.5" y="2245.6685">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="648" x="565" y="2276.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="640" x="569" y="2292.8013">state: webAuthenticationChannelResponseRecieved or OTPAuthenticationChannelResponseRecieved</text><polygon fill="#A80036" points="1014.5,2322,1024.5,2326,1014.5,2330,1018.5,2326" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="1020.5" y1="2326" y2="2326"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="567.5" y="2320.9341">AUTHENTICATION-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="710.5" y="2320.9341">model.authenticate()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="2355.1328" y2="2355.1328"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="2355.1328" y2="2368.1328"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="2368.1328" y2="2368.1328"/><polygon fill="#A80036" points="1047.5,2364.1328,1037.5,2368.1328,1047.5,2372.1328,1043.5,2368.1328" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1043.5" y="2350.0669">AUTHENTICATION-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="1186.5" y="2350.0669">ThirdpartyRequests.patchConsentRequests()</text><polygon fill="#A80036" points="2040.5,2393.2656,2050.5,2397.2656,2040.5,2401.2656,2044.5,2397.2656" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="2397.2656" y2="2397.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1043.5" y="2392.1997">AUTHENTICATION-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1186.5" y="2392.1997">PATCH /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="205" x="1041" y="2410.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1045" y="2426.3325">PATCH /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="2441.4653">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="2456.5981">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="2471.731">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1053" y="2486.8638">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="2501.9966">}</text><polygon fill="#A80036" points="1042.5,2531.1953,1032.5,2535.1953,1042.5,2539.1953,1038.5,2535.1953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="2535.1953" y2="2535.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1048.5" y="2530.1294">AUTHENTICATION-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1191.5" y="2530.1294">202 Accepted</text><polygon fill="#A80036" points="3261.5,2560.3281,3271.5,2564.3281,3261.5,2568.3281,3265.5,2564.3281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="2564.3281" y2="2564.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2069.5" y="2559.2622">AUTHENTICATION-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="2212.5" y="2559.2622">PATCH /consentRequests/6789</text><polygon fill="#A80036" points="2068.5,2589.4609,2058.5,2593.4609,2068.5,2597.4609,2064.5,2593.4609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3272.5" y1="2593.4609" y2="2593.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2074.5" y="2588.395">AUTHENTICATION-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2217.5" y="2588.395">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="2622.5938" y2="2622.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="2622.5938" y2="2635.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="2635.5938" y2="2635.5938"/><polygon fill="#A80036" points="3294.5,2631.5938,3284.5,2635.5938,3294.5,2639.5938,3290.5,2635.5938" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="3290.5" y="2617.5278">AUTHENTICATION-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="3433.5" y="2617.5278">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3288" y="2648.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3292" y="2664.6606">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="3777.5,2693.8594,3787.5,2697.8594,3777.5,2701.8594,3781.5,2697.8594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3278.5" x2="3783.5" y1="2697.8594" y2="2697.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3285.5" y="2692.7935">AUTHENTICATION-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="3437.5" y="2692.7935">model.validateAuthToken()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="2726.9922" y2="2726.9922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="2726.9922" y2="2739.9922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="2739.9922" y2="2739.9922"/><polygon fill="#A80036" points="3810.5,2735.9922,3800.5,2739.9922,3810.5,2743.9922,3806.5,2739.9922" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="2721.9263">AUTHENTICATION-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="3958.5" y="2721.9263">DFSPBackendRequests.validateAuthToken()</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="159" style="stroke:#A80036;stroke-width:1.0;" width="416" x="3804" y="2752.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="3808" y="2769.0591">Do we need two backend endpoints for validating</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="408" x="3808" y="2784.1919">web authTokens and OTP authTokens? Or is a DFSP expected to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="3808" y="2799.3247">validate both cases with one endpoint?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="3812" y="2814.4575"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3808" y="2829.5903">POST /validateAuthToken</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="2844.7231">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3816" y="2859.856">consentRequestId: '6789'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3816" y="2874.9888">authChannel: model.data.authChannel,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3816" y="2890.1216">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="2905.2544">}</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="176" x="3804" y="2922.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="3808" y="2938.3872">state: authTokenValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="2971.5859" y2="2971.5859"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="2971.5859" y2="2984.5859"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="2984.5859" y2="2984.5859"/><polygon fill="#A80036" points="3810.5,2980.5859,3800.5,2984.5859,3810.5,2988.5859,3806.5,2984.5859" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="2966.52">AUTHENTICATION-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3958.5" y="2966.52">const consentId = uuid()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="3013.7188" y2="3013.7188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="3013.7188" y2="3026.7188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="3026.7188" y2="3026.7188"/><polygon fill="#A80036" points="3810.5,3022.7188,3800.5,3026.7188,3810.5,3030.7188,3806.5,3026.7188" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="3008.6528">AUTHENTICATION-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="3958.5" y="3008.6528">model.grantConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="3055.8516" y2="3055.8516"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="3055.8516" y2="3068.8516"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="3068.8516" y2="3068.8516"/><polygon fill="#A80036" points="3810.5,3064.8516,3800.5,3068.8516,3810.5,3072.8516,3806.5,3068.8516" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="3050.7856">AUTHENTICATION-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="3958.5" y="3050.7856">ThirdpartyRequests.postConsents()</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="152" x="3804" y="3081.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3808" y="3097.9185">state: consentGranted</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="3804" y="3114.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="3808" y="3131.0513">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="3808" y="3146.1841">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="3808" y="3161.3169">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="3808" y="3176.4497">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="3209.6484" y2="3209.6484"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="3209.6484" y2="3222.6484"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="3222.6484" y2="3222.6484"/><polygon fill="#A80036" points="3810.5,3218.6484,3800.5,3222.6484,3810.5,3226.6484,3806.5,3222.6484" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="3204.5825">AUTHENTICATION-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="3958.5" y="3204.5825">this.saveToKVS({key: '1a2b3c4d'})</text><polygon fill="#A80036" points="2073.5,3247.7813,2063.5,3251.7813,2073.5,3255.7813,2069.5,3251.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="3251.7813" y2="3251.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="3246.7153">AUTHENTICATION-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="2231.5" y="3246.7153">POST /consents</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="191" x="3593" y="3264.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="3597" y="3280.8481">POST /consents</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3597" y="3295.981">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3597" y="3311.1138">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3597" y="3326.2466">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="3605" y="3341.3794">consentId: 1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3605" y="3356.5122">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="3605" y="3371.645">scopes: model.data.scopes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3597" y="3386.7778">}</text><polygon fill="#A80036" points="3782.5,3415.9766,3792.5,3419.9766,3782.5,3423.9766,3786.5,3419.9766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="3419.9766" y2="3419.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="3414.9106">AUTHENTICATION-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2221.5" y="3414.9106">202 ACCEPTED</text><polygon fill="#A80036" points="1557.5,3445.1094,1547.5,3449.1094,1557.5,3453.1094,1553.5,3449.1094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="3449.1094" y2="3449.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1563.5" y="3444.0435">AUTHENTICATION-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="1715.5" y="3444.0435">POST /consents</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1546.5" x2="1588.5" y1="3478.2422" y2="3478.2422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1588.5" x2="1588.5" y1="3478.2422" y2="3491.2422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1547.5" x2="1588.5" y1="3491.2422" y2="3491.2422"/><polygon fill="#A80036" points="1557.5,3487.2422,1547.5,3491.2422,1557.5,3495.2422,1553.5,3491.2422" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1553.5" y="3473.1763">AUTHENTICATION-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="1705.5" y="3473.1763">const model = await loadFromKVS({key: 6789})</text><polygon fill="#A80036" points="1047.5,3516.375,1037.5,3520.375,1047.5,3524.375,1043.5,3520.375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="1535.5" y1="3520.375" y2="3520.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1053.5" y="3515.3091">AUTHENTICATION-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="1205.5" y="3515.3091">model.registerCredential()</text><polygon fill="#A80036" points="2045.5,3545.5078,2055.5,3549.5078,2045.5,3553.5078,2049.5,3549.5078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1541.5" x2="2051.5" y1="3549.5078" y2="3549.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1548.5" y="3544.4419">AUTHENTICATION-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1700.5" y="3544.4419">202 Accepted</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="157" x="1041" y="3562.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="1045" y="3578.5747">state: consentRecieved</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="1041" y="3595.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="1045" y="3611.7075">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="1045" y="3626.8403">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="1045" y="3641.9731">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="1045" y="3657.106">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="3690.3047" y2="3690.3047"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="3690.3047" y2="3703.3047"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1037.5" x2="1078.5" y1="3703.3047" y2="3703.3047"/><polygon fill="#A80036" points="1047.5,3699.3047,1037.5,3703.3047,1047.5,3707.3047,1043.5,3703.3047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3685.2388">AUTHENTICATION-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1195.5" y="3685.2388">const challenge = deriveChallenge(consentRequest)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="3732.4375" y2="3732.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="3732.4375" y2="3745.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1037.5" x2="1078.5" y1="3745.4375" y2="3745.4375"/><polygon fill="#A80036" points="1047.5,3741.4375,1037.5,3745.4375,1047.5,3749.4375,1043.5,3745.4375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3727.3716">AUTHENTICATION-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1195.5" y="3727.3716">this.saveToKVS({key: '1a2b3c4d'})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="3774.5703" y2="3774.5703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="3774.5703" y2="3787.5703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="3787.5703" y2="3787.5703"/><polygon fill="#A80036" points="1047.5,3783.5703,1037.5,3787.5703,1047.5,3791.5703,1043.5,3787.5703" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3769.5044">AUTHENTICATION-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="1195.5" y="3769.5044">ThirdpartyRequests.putConsents()</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="174" x="1041" y="3800.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="1045" y="3816.6372">state: signedConsentSent</text><polygon fill="#A80036" points="2040.5,3845.8359,2050.5,3849.8359,2040.5,3853.8359,2044.5,3849.8359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="3849.8359" y2="3849.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3844.77">AUTHENTICATION-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1195.5" y="3844.77">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1041" y="3862.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="3878.9028">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="3894.0356">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="3909.1685">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="3924.3013">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1053" y="3939.4341">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="3954.5669">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="3969.6997">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="3984.8325">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="3999.9653">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1053" y="4015.0981">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="1053" y="4030.231">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1061" y="4045.3638">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="1061" y="4060.4966">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="1061" y="4075.6294">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1053" y="4090.7622">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="4105.895">}</text><polygon fill="#A80036" points="1042.5,4135.0938,1032.5,4139.0938,1042.5,4143.0938,1038.5,4139.0938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="4139.0938" y2="4139.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1048.5" y="4134.0278">AUTHENTICATION-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1200.5" y="4134.0278">202 Accepted</text><polygon fill="#A80036" points="3261.5,4164.2266,3271.5,4168.2266,3261.5,4172.2266,3265.5,4168.2266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="4168.2266" y2="4168.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="4163.1606">AUTHENTICATION-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2221.5" y="4163.1606">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="4197.3594" y2="4197.3594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="4197.3594" y2="4210.3594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="4210.3594" y2="4210.3594"/><polygon fill="#A80036" points="3294.5,4206.3594,3284.5,4210.3594,3294.5,4214.3594,3290.5,4210.3594" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="4192.2935">AUTHENTICATION-28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3442.5" y="4192.2935">const model = await loadFromKVS({key: 1a2b3c4d})</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="201" x="3288" y="4223.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="3292" y="4239.4263">state: signedConsentRecieved</text><polygon fill="#A80036" points="3777.5,4268.625,3787.5,4272.625,3777.5,4276.625,3781.5,4272.625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="4272.625" y2="4272.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="4267.5591">AUTHENTICATION-29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3442.5" y="4267.5591">model.validateSignedConsent()</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="264" x="3288" y="4285.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="3292" y="4301.6919">state: pendingRegistrationAndValidation</text><polygon fill="#A80036" points="2068.5,4330.8906,2058.5,4334.8906,2068.5,4338.8906,2064.5,4334.8906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="4334.8906" y2="4334.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="4329.8247">AUTHENTICATION-30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2226.5" y="4329.8247">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="4364.0234" y2="4364.0234"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="4364.0234" y2="4377.0234"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="4377.0234" y2="4377.0234"/><polygon fill="#A80036" points="3810.5,4373.0234,3800.5,4377.0234,3810.5,4381.0234,3806.5,4377.0234" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="4358.9575">AUTHENTICATION-31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3958.5" y="4358.9575">Check signed consent.</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="530" x="3804" y="4390.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="522" x="3808" y="4406.0903">Does this need a backend request or can the scheme adapter check the consent.</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="199" x="3804" y="4423.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="3808" y="4439.2231">state: signedConsentChecked</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="4472.4219" y2="4472.4219"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="4472.4219" y2="4485.4219"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="4485.4219" y2="4485.4219"/><polygon fill="#A80036" points="3810.5,4481.4219,3800.5,4485.4219,3810.5,4489.4219,3806.5,4485.4219" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="4467.356">AUTHENTICATION-32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="3958.5" y="4467.356">model.validateWithAuthService()</text><polygon fill="#A80036" points="2073.5,4510.5547,2063.5,4514.5547,2073.5,4518.5547,2069.5,4514.5547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="4514.5547" y2="4514.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="4509.4888">AUTHENTICATION-33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2231.5" y="4509.4888">POST /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="3426" y="4527.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="3430" y="4543.6216">POST /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3430" y="4558.7544">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3430" y="4573.8872">FSIOP-Destination: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3430" y="4589.02">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3438" y="4604.1528">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3446" y="4619.2856">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3446" y="4634.4185">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3446" y="4649.5513">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3446" y="4664.6841">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3438" y="4679.8169">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3438" y="4694.9497">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="3446" y="4710.0825">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="3446" y="4725.2153">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="3446" y="4740.3481">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3438" y="4755.481">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3430" y="4770.6138">}</text><polygon fill="#A80036" points="3777.5,4799.8125,3787.5,4803.8125,3777.5,4807.8125,3781.5,4803.8125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3783.5" y1="4803.8125" y2="4803.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="4798.7466">AUTHENTICATION-34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2221.5" y="4798.7466">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="4837.9453" y2="4837.9453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="4837.9453" y2="4850.9453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3794.5" x2="3841.5" y1="4850.9453" y2="4850.9453"/><polygon fill="#A80036" points="3804.5,4846.9453,3794.5,4850.9453,3804.5,4854.9453,3800.5,4850.9453" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="4832.8794">AUTHENTICATION-35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="3958.5" y="4832.8794">this.saveToKVS()</text><polygon fill="#A80036" points="2388.5,4871.0781,2398.5,4875.0781,2388.5,4879.0781,2392.5,4875.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="2394.5" y1="4875.0781" y2="4875.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="4870.0122">AUTHENTICATION-36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2221.5" y="4870.0122">POST /consents/1a2b3c4d</text><polygon fill="#A80036" points="2073.5,4900.2109,2063.5,4904.2109,2073.5,4908.2109,2069.5,4904.2109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="2399.5" y1="4904.2109" y2="4904.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="4899.145">AUTHENTICATION-37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2231.5" y="4899.145">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2410.5" x2="2452.5" y1="4933.3438" y2="4933.3438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2452.5" x2="2452.5" y1="4933.3438" y2="4946.3438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2411.5" x2="2452.5" y1="4946.3438" y2="4946.3438"/><polygon fill="#A80036" points="2421.5,4942.3438,2411.5,4946.3438,2421.5,4950.3438,2417.5,4946.3438" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2417.5" y="4928.2778">AUTHENTICATION-38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="2569.5" y="4928.2778">Check consent.</text><polygon fill="#A80036" points="2073.5,4971.4766,2063.5,4975.4766,2073.5,4979.4766,2069.5,4975.4766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="2399.5" y1="4975.4766" y2="4975.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="4970.4106">AUTHENTICATION-39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2231.5" y="4970.4106">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="2037" y="4988.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2041" y="5004.5435">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="2041" y="5019.6763">FSIOP-Source: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2041" y="5034.8091">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2041" y="5049.9419">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="2049" y="5065.0747">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2057" y="5080.2075">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2057" y="5095.3403">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2057" y="5110.4731">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2057" y="5125.606">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="2049" y="5140.7388">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="2049" y="5155.8716">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="2057" y="5171.0044">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="2057" y="5186.1372">status: "VERIFIED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="2057" y="5201.27">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2049" y="5216.4028">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2041" y="5231.5356">}</text><polygon fill="#A80036" points="2388.5,5260.7344,2398.5,5264.7344,2388.5,5268.7344,2392.5,5264.7344" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="2394.5" y1="5264.7344" y2="5264.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5259.6685">AUTHENTICATION-40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2221.5" y="5259.6685">200 OK</text><polygon fill="#A80036" points="3261.5,5289.8672,3271.5,5293.8672,3261.5,5297.8672,3265.5,5293.8672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="5293.8672" y2="5293.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5288.8013">AUTHENTICATION-41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2221.5" y="5288.8013">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5323" y2="5323"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5323" y2="5336"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5336" y2="5336"/><polygon fill="#A80036" points="3294.5,5332,3284.5,5336,3294.5,5340,3290.5,5336" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5317.9341">AUTHENTICATION-42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3442.5" y="5317.9341">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5365.1328" y2="5365.1328"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5365.1328" y2="5378.1328"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5378.1328" y2="5378.1328"/><polygon fill="#A80036" points="3294.5,5374.1328,3284.5,5378.1328,3294.5,5382.1328,3290.5,5378.1328" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5360.0669">AUTHENTICATION-43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="3442.5" y="5360.0669">consentResponseRecieved()</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="219" x="3288" y="5391.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="3292" y="5407.1997">state: consentResponseRecieved</text><polygon fill="#A80036" points="3777.5,5436.3984,3787.5,5440.3984,3777.5,5444.3984,3781.5,5440.3984" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="5440.3984" y2="5440.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5435.3325">AUTHENTICATION-44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="3442.5" y="5435.3325">Auth Service response recieved</text><polygon fill="#A80036" points="2068.5,5465.5313,2058.5,5469.5313,2068.5,5473.5313,2064.5,5469.5313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="5469.5313" y2="5469.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5464.4653">AUTHENTICATION-45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2226.5" y="5464.4653">200 OK</text><polygon fill="#A80036" points="2829.5,5494.6641,2839.5,5498.6641,2829.5,5502.6641,2833.5,5498.6641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2410.5" x2="2835.5" y1="5498.6641" y2="5498.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2417.5" y="5493.5981">AUTHENTICATION-46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="2569.5" y="5493.5981">POST /participants/CONSENTS/1a2b3c4d</text><polygon fill="#A80036" points="2416.5,5523.7969,2406.5,5527.7969,2416.5,5531.7969,2412.5,5527.7969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2410.5" x2="2840.5" y1="5527.7969" y2="5527.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2422.5" y="5522.731">AUTHENTICATION-47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2574.5" y="5522.731">202 Accepted</text><polygon fill="#A80036" points="3261.5,5552.9297,3271.5,5556.9297,3261.5,5560.9297,3265.5,5556.9297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2851.5" x2="3267.5" y1="5556.9297" y2="5556.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2858.5" y="5551.8638">AUTHENTICATION-48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3010.5" y="5551.8638">PUT /participants/CONSENTS/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5586.0625" y2="5586.0625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5586.0625" y2="5599.0625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5599.0625" y2="5599.0625"/><polygon fill="#A80036" points="3294.5,5595.0625,3284.5,5599.0625,3294.5,5603.0625,3290.5,5599.0625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5580.9966">AUTHENTICATION-49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3442.5" y="5580.9966">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5628.1953" y2="5628.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5628.1953" y2="5641.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5641.1953" y2="5641.1953"/><polygon fill="#A80036" points="3294.5,5637.1953,3284.5,5641.1953,3294.5,5645.1953,3290.5,5641.1953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5623.1294">AUTHENTICATION-50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="3442.5" y="5623.1294">participantResponseRecieved()</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="243" x="3288" y="5654.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="235" x="3292" y="5670.2622">state: participantsResponseRecieved</text><polygon fill="#A80036" points="3777.5,5699.4609,3787.5,5703.4609,3777.5,5707.4609,3781.5,5703.4609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="5703.4609" y2="5703.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5698.395">AUTHENTICATION-51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3442.5" y="5698.395">Participant response recieved</text><polygon fill="#A80036" points="2857.5,5728.5938,2847.5,5732.5938,2857.5,5736.5938,2853.5,5732.5938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2851.5" x2="3277.5" y1="5732.5938" y2="5732.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2863.5" y="5727.5278">AUTHENTICATION-52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="3015.5" y="5727.5278">200 Accepted</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="253" x="3804" y="5745.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="3808" y="5761.6606">state: consentRegisteredAndValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="5794.8594" y2="5794.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="5794.8594" y2="5807.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="5807.8594" y2="5807.8594"/><polygon fill="#A80036" points="3810.5,5803.8594,3800.5,5807.8594,3810.5,5811.8594,3806.5,5807.8594" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="5789.7935">AUTHENTICATION-53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="3958.5" y="5789.7935">model.finalizeConsent()</text><path d="M2016,5822.8594 L2093,5822.8594 L2093,5829.8594 L2083,5839.8594 L2016,5839.8594 L2016,5822.8594 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="2016" y="5822.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="2031" y="5835.9263">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="116" x="2108" y="5835.0698">[for each scope in</text><text fill="#000000" font-family="monospace" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="105" x="2228" y="5835.0698">Consents.scopes</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="5" x="2333" y="5835.0698">]</text><polygon fill="#A80036" points="2068.5,5857.125,2058.5,5861.125,2068.5,5865.125,2064.5,5861.125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3788.5" y1="5861.125" y2="5861.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5856.0591">AUTHENTICATION-54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2226.5" y="5856.0591">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="3777.5,5886.2578,3787.5,5890.2578,3777.5,5894.2578,3781.5,5890.2578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2057.5" x2="3783.5" y1="5890.2578" y2="5890.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="5885.1919">AUTHENTICATION-55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2216.5" y="5885.1919">202 Accepted</text><polygon fill="#A80036" points="2834.5,5915.3906,2844.5,5919.3906,2834.5,5923.3906,2838.5,5919.3906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2057.5" x2="2840.5" y1="5919.3906" y2="5919.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="5914.3247">AUTHENTICATION-56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2216.5" y="5914.3247">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2068.5,5944.5234,2058.5,5948.5234,2068.5,5952.5234,2064.5,5948.5234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="2845.5" y1="5948.5234" y2="5948.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5943.4575">AUTHENTICATION-57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2226.5" y="5943.4575">202 Accepted</text><polygon fill="#A80036" points="2068.5,5973.6563,2058.5,5977.6563,2068.5,5981.6563,2064.5,5977.6563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="2845.5" y1="5977.6563" y2="5977.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5972.5903">AUTHENTICATION-58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="2226.5" y="5972.5903">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2834.5,6002.7891,2844.5,6006.7891,2834.5,6010.7891,2838.5,6006.7891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2057.5" x2="2840.5" y1="6006.7891" y2="6006.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="6001.7231">AUTHENTICATION-59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2216.5" y="6001.7231">200 OK</text><polygon fill="#A80036" points="3266.5,6031.9219,3276.5,6035.9219,3266.5,6039.9219,3270.5,6035.9219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2057.5" x2="3272.5" y1="6035.9219" y2="6035.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="6030.856">AUTHENTICATION-60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="2216.5" y="6030.856">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2068.5,6061.0547,2058.5,6065.0547,2068.5,6069.0547,2064.5,6065.0547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="6065.0547" y2="6065.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="6059.9888">AUTHENTICATION-61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2226.5" y="6059.9888">200 OK</text><polygon fill="#A80036" points="3777.5,6090.1875,3787.5,6094.1875,3777.5,6098.1875,3781.5,6094.1875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3278.5" x2="3783.5" y1="6094.1875" y2="6094.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3285.5" y="6089.1216">AUTHENTICATION-62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3437.5" y="6089.1216">Participant response recieved</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6130.3203" y2="6130.3203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6130.3203" y2="6143.3203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6143.3203" y2="6143.3203"/><polygon fill="#A80036" points="3810.5,6139.3203,3800.5,6143.3203,3810.5,6147.3203,3806.5,6143.3203" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6125.2544">AUTHENTICATION-63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="3958.5" y="6125.2544">await Promise.all()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6172.4531" y2="6172.4531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6172.4531" y2="6185.4531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6185.4531" y2="6185.4531"/><polygon fill="#A80036" points="3810.5,6181.4531,3800.5,6185.4531,3810.5,6189.4531,3806.5,6185.4531" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6167.3872">AUTHENTICATION-64</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3958.5" y="6167.3872">state: PISPDFSPLinkEstablished</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6214.5859" y2="6214.5859"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6214.5859" y2="6227.5859"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6227.5859" y2="6227.5859"/><polygon fill="#A80036" points="3810.5,6223.5859,3800.5,6227.5859,3810.5,6231.5859,3806.5,6227.5859" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6209.52">AUTHENTICATION-65</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="3958.5" y="6209.52">model.notifyVerificationToPISP()</text><polygon fill="#A80036" points="2073.5,6252.7188,2063.5,6256.7188,2073.5,6260.7188,2069.5,6256.7188" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="6256.7188" y2="6256.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="6251.6528">AUTHENTICATION-66</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="2231.5" y="6251.6528">PATCH /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="184" x="3600" y="6269.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="3604" y="6285.7856">PATCH /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3604" y="6300.9185">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3604" y="6316.0513">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3604" y="6331.1841">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3612" y="6346.3169">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="3620" y="6361.4497">status: "VERIFIED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3612" y="6376.5825">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3604" y="6391.7153">}</text><polygon fill="#A80036" points="3782.5,6420.9141,3792.5,6424.9141,3782.5,6428.9141,3786.5,6424.9141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="6424.9141" y2="6424.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="6419.8481">AUTHENTICATION-67</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2221.5" y="6419.8481">200 OK</text><polygon fill="#A80036" points="1557.5,6450.0469,1547.5,6454.0469,1557.5,6458.0469,1553.5,6454.0469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="6454.0469" y2="6454.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1563.5" y="6448.981">AUTHENTICATION-68</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="1715.5" y="6448.981">PATCH /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1546.5" x2="1588.5" y1="6483.1797" y2="6483.1797"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1588.5" x2="1588.5" y1="6483.1797" y2="6496.1797"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1547.5" x2="1588.5" y1="6496.1797" y2="6496.1797"/><polygon fill="#A80036" points="1557.5,6492.1797,1547.5,6496.1797,1557.5,6500.1797,1553.5,6496.1797" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1553.5" y="6478.1138">AUTHENTICATION-69</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="1705.5" y="6478.1138">const model = await loadFromKVS({key: 1a2b3c4d})</text><polygon fill="#A80036" points="1047.5,6521.3125,1037.5,6525.3125,1047.5,6529.3125,1043.5,6525.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="1535.5" y1="6525.3125" y2="6525.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1053.5" y="6520.2466">AUTHENTICATION-70</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="1205.5" y="6520.2466">Verified Response recieved</text><polygon fill="#A80036" points="2045.5,6550.4453,2055.5,6554.4453,2045.5,6558.4453,2049.5,6554.4453" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1541.5" x2="2051.5" y1="6554.4453" y2="6554.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1548.5" y="6549.3794">AUTHENTICATION-71</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1700.5" y="6549.3794">200 OK</text><rect fill="#FBFB77" filter="url(#f1ryulwit6ran0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="148" x="1041" y="6567.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="1045" y="6583.5122">state: accountsLinked</text><polygon fill="#A80036" points="571.5,6612.7109,561.5,6616.7109,571.5,6620.7109,567.5,6616.7109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="565.5" x2="1030.5" y1="6616.7109" y2="6616.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="577.5" y="6611.645">AUTHENTICATION-72</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="729.5" y="6611.645">return Accounts linked response</text><polygon fill="#A80036" points="92.5,6641.8438,82.5,6645.8438,92.5,6649.8438,88.5,6645.8438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="86.5" x2="549.5" y1="6645.8438" y2="6645.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="98.5" y="6640.7778">AUTHENTICATION-73</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="250.5" y="6640.7778">200 OK Accounts Linked</text><rect fill="#ADD8E6" filter="url(#f1ryulwit6ran0)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="217" x="328" y="6658.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="332" y="6674.9106">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="340" y="6690.0435">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="348" y="6705.1763">status: "VERIFIED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="340" y="6720.3091">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="340" y="6735.4419">currentState="accountsLinked"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="332" y="6750.5747">}</text><!--MD5=[f928f0531312d3c2e9ae6bc4772d2c91]
@startuml

title PISP Linking Web

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
    participant "Auth Service" as AUTH
    participant "Account Lookup Service" as ALS
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box
participant DFSPAuthorizeSimulator

== Request Consent - Web ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  accounts: [
    { accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },
    { accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }
  ],
  callbackURI: 'pisp-app://callback'
}
end note


activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
rnote right of PISP_TP_OUT: state: start
PISP_TP_OUT -> PISP_LM: model.requestConsent()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> PISP_LM: const consentRequestId = uuid()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  // model will add `authChannels`
  authChannels: ["WEB", "OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN

DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
DFSP_TP_IN -> DFSP_TP_IN: const model = await create()
rnote right of DFSP_TP_IN: state: start
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
deactivate DFSP_TP_IN
activate DFSP_LM
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()
DFSP_LM -> DFSPAuthorizeSimulator: ""POST /store/consentRequests/6789""
activate DFSPAuthorizeSimulator
DFSPAuthorizeSimulator -> DFSPAuthorizeSimulator: store consentRequest details
DFSPAuthorizeSimulator -> DFSP_LM: 201 Created
rnote right of DFSP_LM: state: consentRequestValidatedAndStored
deactivate DFSPAuthorizeSimulator

DFSP_LM -> Switch: PUT /consentRequests/6789
activate Switch

rnote left of DFSP_LM #LightBlue
PUT /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  authChannels: ["WEB"], // updated with the channel in use
  callbackURI: 'pisp-app://callback...',
  authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
DFSP_LM -> DFSP_LM: this.saveToKVS()
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consentRequests/6789
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
PISP_TP_IN - -> PISP_LM: Consent Request response recieved
deactivate PISP_TP_IN
activate PISP_LM
rnote right of PISP_LM: state: webAuthenticationChannelResponseRecieved
PISP_LM - -> PISP_LM: this.saveToKVS()
PISP_LM -> PISP_TP_OUT: return Authentication Response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Autentication Response
rnote left of PISP_TP_OUT #LightBlue
{
  channelResponse: {
    consentRequestId: 6789
    scopes: [{
      accountId: 'dfspa.username.1234',
      actions: ['accounts.getBalance', 'accounts.transfer'],
      accountId: 'dfspa.username.5678',
      actions: ['accounts.getBalance', 'accounts.transfer'],
    }],
    authChannels: ["WEB"],
    callbackURI: 'pisp-app://callback...',
    authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
  },
  currentState="OTPAuthenticationChannelResponseRecieved"
}
end note
deactivate PISP_TP_OUT
deactivate PISP

note over PISP, DFSPAuthorizeSimulator
  The PISP is expected to redirect to the DFSP's `authUri` in their application to let the end user complete the web login flow.
  Logging in successfully should provide the PISP with a secret to use in the next linking step.
end note

== Authentication+Grant Consent+Register Credential ==
autonumber 1 "<b>AUTHENTICATION-#</b>"
rnote right of PISP
PISP has obtained authToken from end-user(OTP) or through a callback(Web).
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent/6789/authenticate
rnote right of PISP #LightBlue
POST /linking/request-consent/6789/authenticate
{
  authToken: '123456'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS({key: 6789})
rnote right of PISP_TP_OUT: state: webAuthenticationChannelResponseRecieved or OTPAuthenticationChannelResponseRecieved
PISP_TP_OUT -> PISP_LM: model.authenticate()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.patchConsentRequests()
PISP_LM -> Switch: PATCH /consentRequests/6789
rnote right of PISP_LM #LightBlue
PATCH /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  authToken: '124356'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PATCH /consentRequests/6789
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 6789})
rnote right of DFSP_TP_IN: state: consentRequestValidatedAndStored
DFSP_TP_IN -> DFSP_LM: model.validateAuthToken()
deactivate DFSP_TP_IN
activate DFSP_LM

DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateAuthToken()
rnote right of DFSP_LM #LightBlue
Do we need two backend endpoints for validating
web authTokens and OTP authTokens? Or is a DFSP expected to
validate both cases with one endpoint?

POST /validateAuthToken
{
  consentRequestId: '6789'
  authChannel: model.data.authChannel,
  authToken: '124356'
}
end note
rnote right of DFSP_LM: state: authTokenValidated

DFSP_LM -> DFSP_LM: const consentId = uuid()
DFSP_LM -> DFSP_LM: model.grantConsent()
DFSP_LM -> DFSP_LM: ThirdpartyRequests.postConsents()
rnote right of DFSP_LM: state: consentGranted
rnote right of DFSP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
DFSP_LM -> DFSP_LM: this.saveToKVS({key: '1a2b3c4d'})

DFSP_LM -> Switch: POST /consents
activate Switch

rnote left of DFSP_LM #LightBlue
POST /consents
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  consentId: 1a2b3c4d
  consentRequestId: 6789
  scopes: model.data.scopes
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
Switch ->  PISP_TP_IN: POST /consents
activate PISP_TP_IN
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 6789})
PISP_TP_IN -> PISP_LM: model.registerCredential()
activate PISP_LM
PISP_TP_IN - -> Switch: 202 Accepted
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: consentRecieved
rnote right of PISP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
PISP_LM - -> PISP_LM: const challenge = deriveChallenge(consentRequest)
PISP_LM - -> PISP_LM: this.saveToKVS({key: '1a2b3c4d'})

PISP_LM -> PISP_LM: ThirdpartyRequests.putConsents()
rnote right of PISP_LM: state: signedConsentSent
PISP_LM -> Switch: PUT /consents/1a2b3c4d
activate Switch

rnote right of PISP_LM #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
activate DFSP_TP_IN

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
rnote right of DFSP_TP_IN: state: signedConsentRecieved
DFSP_TP_IN -> DFSP_LM: model.validateSignedConsent()
activate DFSP_LM
rnote right of DFSP_TP_IN: state: pendingRegistrationAndValidation
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: Check signed consent.
rnote right of DFSP_LM #LightBlue
Does this need a backend request or can the scheme adapter check the consent.
end note
rnote right of DFSP_LM: state: signedConsentChecked
DFSP_LM-> DFSP_LM: model.validateWithAuthService()
DFSP_LM -> Switch: POST /consents/1a2b3c4d
activate Switch

rnote left of DFSP_LM #LightBlue
POST /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: central-auth
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note
Switch - -> DFSP_LM: 202 Accepted
DFSP_LM -> DFSP_LM: this.saveToKVS()
deactivate DFSP_LM

Switch -> AUTH: POST /consents/1a2b3c4d
activate AUTH
AUTH - -> Switch: 202 Accepted
AUTH -> AUTH: Check consent.
AUTH -> Switch: PUT /consents/1a2b3c4d

rnote left of AUTH #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: central-auth
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "VERIFIED",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> AUTH: 200 OK
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: consentResponseRecieved()
rnote right of DFSP_TP_IN: state: consentResponseRecieved
DFSP_TP_IN -> DFSP_LM: Auth Service response recieved
activate DFSP_LM
DFSP_TP_IN - -> Switch: 200 OK
deactivate Switch
deactivate DFSP_TP_IN

AUTH -> ALS: POST /participants/CONSENTS/1a2b3c4d
activate ALS
ALS - -> AUTH: 202 Accepted
deactivate AUTH

ALS -> DFSP_TP_IN: PUT /participants/CONSENTS/1a2b3c4d
activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: participantResponseRecieved()
rnote right of DFSP_TP_IN: state: participantsResponseRecieved
DFSP_TP_IN -> DFSP_LM: Participant response recieved
DFSP_TP_IN - -> ALS: 200 Accepted
deactivate ALS
deactivate DFSP_TP_IN
rnote right of DFSP_LM: state: consentRegisteredAndValidated
DFSP_LM -> DFSP_LM: model.finalizeConsent()

loop for each scope in ""Consents.scopes""
DFSP_LM -> Switch: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> DFSP_LM: 202 Accepted
Switch -> ALS: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
ALS - -> Switch: 202 Accepted
ALS -> Switch: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> ALS: 200 OK
Switch -> DFSP_TP_IN: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678
DFSP_TP_IN - -> Switch: 200 OK
DFSP_TP_IN -> DFSP_LM: Participant response recieved
end

DFSP_LM -> DFSP_LM: await Promise.all()
DFSP_LM -> DFSP_LM: state: PISPDFSPLinkEstablished
DFSP_LM -> DFSP_LM: model.notifyVerificationToPISP()
DFSP_LM -> Switch: PATCH /consents/1a2b3c4d
rnote left of DFSP_LM #LightBlue
PATCH /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  credential: {
    status: "VERIFIED"
  }
}
end note
activate Switch
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
Switch -> PISP_TP_IN: PATCH /consents/1a2b3c4d
activate PISP_TP_IN
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})


PISP_TP_IN -> PISP_LM: Verified Response recieved
activate PISP_LM
PISP_TP_IN - -> Switch: 200 OK
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: accountsLinked
PISP_LM - -> PISP_TP_OUT: return Accounts linked response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Accounts Linked
rnote left of PISP_TP_OUT #LightBlue
{
  credential: {
    status: "VERIFIED"
  }
  currentState="accountsLinked"
}
end note
@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>