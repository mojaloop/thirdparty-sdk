<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="5129px" preserveAspectRatio="none" style="width:4337px;height:5129px;" version="1.1" viewBox="0 0 4337 5129" width="4337px" zoomAndPan="magnify"><defs><filter height="300%" id="f1dw90o7bh3xz5" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="485" x="1922.5" y="28.708">PISP Linking Error Scenarios Register Credential Phase</text><rect fill="#DDDDDD" height="5082.4219" style="stroke:#A80036;stroke-width:1.0;" width="1131.5" x="488.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="964.25" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="5082.4219" style="stroke:#A80036;stroke-width:1.0;" width="920.5" x="2004" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="2430.75" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="5082.4219" style="stroke:#A80036;stroke-width:1.0;" width="658" x="3195" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="3431" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="4864.2969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="56.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="4864.2969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="554.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="385.7109"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="1580.0859"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="514.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="2063.6094"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="4975.6797"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="142.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1549.5" y="1508.8203"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1549.5" y="4917.4141"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="196.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="456.9766"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="339.8594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="1311.4922"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="485.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="2288.6719"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="954.9766" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="2953.3906"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="302.125" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="4644.4219"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2382.5" y="3313.9141"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2823.5" y="3937.5"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3255.5" y="624.0391"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3255.5" y="2607.0625"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3255.5" y="3732.7031"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3255.5" y="3995.7656"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="722.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3771.5" y="757.5703"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="566.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3771.5" y="2711.4609"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="1009.0469" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3771.5" y="3879.2344"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="1998" y="4261.6953"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="61" x2="61" y1="95.3828" y2="5085.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="559.5" x2="559.5" y1="95.3828" y2="5085.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1044.5" x2="1044.5" y1="95.3828" y2="5085.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1554" x2="1554" y1="95.3828" y2="5085.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2039" x2="2039" y1="95.3828" y2="5085.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2387.5" x2="2387.5" y1="95.3828" y2="5085.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2828.5" x2="2828.5" y1="95.3828" y2="5085.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3260" x2="3260" y1="95.3828" y2="5085.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3776" x2="3776" y1="95.3828" y2="5085.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="4232" x2="4232" y1="95.3828" y2="5085.0781"/><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="12" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="5" y="5084.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="12" y="5104.0732">PISP Backend</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="492.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="499.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="492.5" y="5084.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="499.5" y="5104.0732">outbound-server</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="975.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="982.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="975.5" y="5084.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="982.5" y="5104.0732">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1493" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1500" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1493" y="5084.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1500" y="5104.0732">inbound-server</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2008" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2015" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2008" y="5084.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2015" y="5104.0732">Switch</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2335.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2342.5" y="80.0811">Auth Service</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2335.5" y="5084.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2342.5" y="5104.0732">Auth Service</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2736.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2743.5" y="80.0811">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2736.5" y="5084.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2743.5" y="5104.0732">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3199" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3206" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3199" y="5084.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3206" y="5104.0732">inbound-server</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3704" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3711" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3704" y="5084.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3711" y="5104.0732">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4140" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4147" y="80.0811">DFSPAuthorizeSimulator</text><rect fill="#FEFECE" filter="url(#f1dw90o7bh3xz5)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4140" y="5084.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4147" y="5104.0732">DFSPAuthorizeSimulator</text><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="4864.2969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="56.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="4864.2969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="554.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="385.7109"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="1580.0859"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="514.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="2063.6094"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="4975.6797"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="142.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1549.5" y="1508.8203"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1549.5" y="4917.4141"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="196.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="456.9766"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="339.8594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="1311.4922"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="485.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="2288.6719"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="954.9766" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="2953.3906"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="302.125" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="4644.4219"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2382.5" y="3313.9141"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2823.5" y="3937.5"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3255.5" y="624.0391"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3255.5" y="2607.0625"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3255.5" y="3732.7031"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3255.5" y="3995.7656"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="722.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3771.5" y="757.5703"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="566.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3771.5" y="2711.4609"/><rect fill="#FFFFFF" filter="url(#f1dw90o7bh3xz5)" height="1009.0469" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3771.5" y="3879.2344"/><rect fill="#EEEEEE" filter="url(#f1dw90o7bh3xz5)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4330" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4330" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4330" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#f1dw90o7bh3xz5)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="397" x="1966.5" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="378" x="1972.5" y="131.4497">Authentication+Grant Consent+Register Credential</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="503" x="66" y="153.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495" x="70" y="169.5825">PISP has obtained authToken from end-user(OTP) or through a callback(Web).</text><polygon fill="#A80036" points="542.5,198.7813,552.5,202.7813,542.5,206.7813,546.5,202.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="66.5" x2="548.5" y1="202.7813" y2="202.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="73.5" y="197.7153">AUTHENTICATION-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="216.5" y="197.7153">POST /linking/request-consent/6789/authenticate</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="320" x="71" y="215.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="75" y="231.8481">POST /linking/request-consent/6789/authenticate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="246.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="83" y="262.1138">authToken: '123456'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="277.2466">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="564.5" x2="606.5" y1="310.4453" y2="310.4453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="606.5" x2="606.5" y1="310.4453" y2="323.4453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="565.5" x2="606.5" y1="323.4453" y2="323.4453"/><polygon fill="#A80036" points="575.5,319.4453,565.5,323.4453,575.5,327.4453,571.5,323.4453" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="571.5" y="305.3794">AUTHENTICATION-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="714.5" y="305.3794">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="648" x="569" y="336.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="640" x="573" y="352.5122">state: webAuthenticationChannelResponseReceived or OTPAuthenticationChannelResponseReceived</text><polygon fill="#A80036" points="1027.5,381.7109,1037.5,385.7109,1027.5,389.7109,1031.5,385.7109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="564.5" x2="1033.5" y1="385.7109" y2="385.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="571.5" y="380.645">AUTHENTICATION-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="714.5" y="380.645">model.authenticate()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1049.5" x2="1091.5" y1="414.8438" y2="414.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1091.5" x2="1091.5" y1="414.8438" y2="427.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1050.5" x2="1091.5" y1="427.8438" y2="427.8438"/><polygon fill="#A80036" points="1060.5,423.8438,1050.5,427.8438,1060.5,431.8438,1056.5,427.8438" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1056.5" y="409.7778">AUTHENTICATION-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="1199.5" y="409.7778">ThirdpartyRequests.patchConsentRequests()</text><polygon fill="#A80036" points="2022.5,452.9766,2032.5,456.9766,2022.5,460.9766,2026.5,456.9766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1049.5" x2="2028.5" y1="456.9766" y2="456.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1056.5" y="451.9106">AUTHENTICATION-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1199.5" y="451.9106">PATCH /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="205" x="1054" y="469.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1058" y="486.0435">PATCH /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1058" y="501.1763">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1058" y="516.3091">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1058" y="531.4419">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1066" y="546.5747">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1058" y="561.7075">}</text><polygon fill="#A80036" points="1055.5,590.9063,1045.5,594.9063,1055.5,598.9063,1051.5,594.9063" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1049.5" x2="2033.5" y1="594.9063" y2="594.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1061.5" y="589.8403">AUTHENTICATION-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1204.5" y="589.8403">202 Accepted</text><polygon fill="#A80036" points="3243.5,620.0391,3253.5,624.0391,3243.5,628.0391,3247.5,624.0391" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2044.5" x2="3249.5" y1="624.0391" y2="624.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2051.5" y="618.9731">AUTHENTICATION-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="2194.5" y="618.9731">PATCH /consentRequests/6789</text><polygon fill="#A80036" points="2050.5,649.1719,2040.5,653.1719,2050.5,657.1719,2046.5,653.1719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="3254.5" y1="653.1719" y2="653.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2056.5" y="648.106">AUTHENTICATION-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2199.5" y="648.106">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3265.5" x2="3307.5" y1="682.3047" y2="682.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3307.5" x2="3307.5" y1="682.3047" y2="695.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3266.5" x2="3307.5" y1="695.3047" y2="695.3047"/><polygon fill="#A80036" points="3276.5,691.3047,3266.5,695.3047,3276.5,699.3047,3272.5,695.3047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="3272.5" y="677.2388">AUTHENTICATION-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="3415.5" y="677.2388">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3270" y="708.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3274" y="724.3716">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="3759.5,753.5703,3769.5,757.5703,3759.5,761.5703,3763.5,757.5703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3260.5" x2="3765.5" y1="757.5703" y2="757.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3267.5" y="752.5044">AUTHENTICATION-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="3419.5" y="752.5044">model.validateAuthToken()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3781.5" x2="3823.5" y1="786.7031" y2="786.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3823.5" x2="3823.5" y1="786.7031" y2="799.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3782.5" x2="3823.5" y1="799.7031" y2="799.7031"/><polygon fill="#A80036" points="3792.5,795.7031,3782.5,799.7031,3792.5,803.7031,3788.5,799.7031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3788.5" y="781.6372">AUTHENTICATION-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="3940.5" y="781.6372">DFSPBackendRequests.validateAuthToken()</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="159" style="stroke:#A80036;stroke-width:1.0;" width="416" x="3786" y="812.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="3790" y="828.77">Do we need two backend endpoints for validating</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="408" x="3790" y="843.9028">web authTokens and OTP authTokens? Or is a DFSP expected to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="3790" y="859.0356">validate both cases with one endpoint?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="3794" y="874.1685"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3790" y="889.3013">POST /validateAuthToken</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3790" y="904.4341">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3798" y="919.5669">consentRequestId: '6789'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3798" y="934.6997">authChannel: model.data.authChannel,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3798" y="949.8325">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3790" y="964.9653">}</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="176" x="3786" y="982.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="3790" y="998.0981">state: authTokenValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3781.5" x2="3823.5" y1="1031.2969" y2="1031.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3823.5" x2="3823.5" y1="1031.2969" y2="1044.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3782.5" x2="3823.5" y1="1044.2969" y2="1044.2969"/><polygon fill="#A80036" points="3792.5,1040.2969,3782.5,1044.2969,3792.5,1048.2969,3788.5,1044.2969" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3788.5" y="1026.231">AUTHENTICATION-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3940.5" y="1026.231">const consentId = uuid()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3781.5" x2="3823.5" y1="1073.4297" y2="1073.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3823.5" x2="3823.5" y1="1073.4297" y2="1086.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3782.5" x2="3823.5" y1="1086.4297" y2="1086.4297"/><polygon fill="#A80036" points="3792.5,1082.4297,3782.5,1086.4297,3792.5,1090.4297,3788.5,1086.4297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3788.5" y="1068.3638">AUTHENTICATION-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="3940.5" y="1068.3638">model.grantConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3781.5" x2="3823.5" y1="1115.5625" y2="1115.5625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3823.5" x2="3823.5" y1="1115.5625" y2="1128.5625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3782.5" x2="3823.5" y1="1128.5625" y2="1128.5625"/><polygon fill="#A80036" points="3792.5,1124.5625,3782.5,1128.5625,3792.5,1132.5625,3788.5,1128.5625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3788.5" y="1110.4966">AUTHENTICATION-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="3940.5" y="1110.4966">ThirdpartyRequests.postConsents()</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="152" x="3786" y="1141.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3790" y="1157.6294">state: consentGranted</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="3786" y="1174.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="3790" y="1190.7622">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="3790" y="1205.895">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="3790" y="1221.0278">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="3790" y="1236.1606">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3781.5" x2="3823.5" y1="1269.3594" y2="1269.3594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3823.5" x2="3823.5" y1="1269.3594" y2="1282.3594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3782.5" x2="3823.5" y1="1282.3594" y2="1282.3594"/><polygon fill="#A80036" points="3792.5,1278.3594,3782.5,1282.3594,3792.5,1286.3594,3788.5,1282.3594" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3788.5" y="1264.2935">AUTHENTICATION-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="3940.5" y="1264.2935">this.saveToKVS({key: '1a2b3c4d'})</text><polygon fill="#A80036" points="2055.5,1307.4922,2045.5,1311.4922,2055.5,1315.4922,2051.5,1311.4922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2049.5" x2="3770.5" y1="1311.4922" y2="1311.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2061.5" y="1306.4263">AUTHENTICATION-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="2213.5" y="1306.4263">POST /consents</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="191" x="3575" y="1324.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="3579" y="1340.5591">POST /consents</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3579" y="1355.6919">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3579" y="1370.8247">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3579" y="1385.9575">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="3587" y="1401.0903">consentId: 1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3587" y="1416.2231">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="3587" y="1431.356">scopes: model.data.scopes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3579" y="1446.4888">}</text><polygon fill="#A80036" points="3764.5,1475.6875,3774.5,1479.6875,3764.5,1483.6875,3768.5,1479.6875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="3770.5" y1="1479.6875" y2="1479.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2051.5" y="1474.6216">AUTHENTICATION-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2203.5" y="1474.6216">202 ACCEPTED</text><polygon fill="#A80036" points="1570.5,1504.8203,1560.5,1508.8203,1570.5,1512.8203,1566.5,1508.8203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1564.5" x2="2033.5" y1="1508.8203" y2="1508.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1576.5" y="1503.7544">AUTHENTICATION-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="1728.5" y="1503.7544">POST /consents</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1559.5" x2="1601.5" y1="1537.9531" y2="1537.9531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1601.5" x2="1601.5" y1="1537.9531" y2="1550.9531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1560.5" x2="1601.5" y1="1550.9531" y2="1550.9531"/><polygon fill="#A80036" points="1570.5,1546.9531,1560.5,1550.9531,1570.5,1554.9531,1566.5,1550.9531" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1566.5" y="1532.8872">AUTHENTICATION-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="1718.5" y="1532.8872">const model = await loadFromKVS({key: 6789})</text><polygon fill="#A80036" points="1060.5,1576.0859,1050.5,1580.0859,1060.5,1584.0859,1056.5,1580.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1054.5" x2="1548.5" y1="1580.0859" y2="1580.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1066.5" y="1575.02">AUTHENTICATION-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="261" x="1218.5" y="1575.02">model.consentReceivedAwaitCredential()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1049.5" x2="1091.5" y1="1609.2188" y2="1609.2188"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1091.5" x2="1091.5" y1="1609.2188" y2="1622.2188"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1050.5" x2="1091.5" y1="1622.2188" y2="1622.2188"/><polygon fill="#A80036" points="1060.5,1618.2188,1050.5,1622.2188,1060.5,1626.2188,1056.5,1622.2188" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1056.5" y="1604.1528">AUTHENTICATION-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1208.5" y="1604.1528">const challenge = deriveChallenge(consentRequest)</text><polygon fill="#A80036" points="2027.5,1647.3516,2037.5,1651.3516,2027.5,1655.3516,2031.5,1651.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1554.5" x2="2033.5" y1="1651.3516" y2="1651.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1561.5" y="1646.2856">AUTHENTICATION-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1713.5" y="1646.2856">202 Accepted</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="275" x="1054" y="1664.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="267" x="1058" y="1680.4185">state: consentReceivedAwaitingCredential</text><polygon fill="#A80036" points="575.5,1709.6172,565.5,1713.6172,575.5,1717.6172,571.5,1713.6172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="569.5" x2="1043.5" y1="1713.6172" y2="1713.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="581.5" y="1708.5513">AUTHENTICATION-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="733.5" y="1708.5513">return Model state and challenge</text><polygon fill="#A80036" points="77.5,1738.75,67.5,1742.75,77.5,1746.75,73.5,1742.75" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="71.5" x2="553.5" y1="1742.75" y2="1742.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="83.5" y="1737.6841">AUTHENTICATION-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="235.5" y="1737.6841">200 OK Model State and challenge</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="341" x="208" y="1755.75"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="212" y="1771.8169">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="325" x="220" y="1786.9497">currentState: "consentReceivedAwaitingCredential"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="220" y="1802.0825">challenge: challenge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="212" y="1817.2153">}</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="310" x="71" y="1834.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="302" x="75" y="1850.3481">PISP has obtained credential from the end-user</text><polygon fill="#A80036" points="542.5,1879.5469,552.5,1883.5469,542.5,1887.5469,546.5,1883.5469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="66.5" x2="548.5" y1="1883.5469" y2="1883.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="73.5" y="1878.481">AUTHENTICATION-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="225.5" y="1878.481">POST /linking/request-consent/6789/authenticate</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="337" x="71" y="1896.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="329" x="75" y="1912.6138">POST /linking/request-consent/6789/pass-credential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="1927.7466">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="83" y="1942.8794">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="91" y="1958.0122">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="83" y="1973.145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="1988.2778">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="564.5" x2="606.5" y1="2021.4766" y2="2021.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="606.5" x2="606.5" y1="2021.4766" y2="2034.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="565.5" x2="606.5" y1="2034.4766" y2="2034.4766"/><polygon fill="#A80036" points="575.5,2030.4766,565.5,2034.4766,575.5,2038.4766,571.5,2034.4766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="571.5" y="2016.4106">AUTHENTICATION-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="723.5" y="2016.4106">const model = await loadFromKVS({key: 6789})</text><polygon fill="#A80036" points="1027.5,2059.6094,1037.5,2063.6094,1027.5,2067.6094,1031.5,2063.6094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="564.5" x2="1033.5" y1="2063.6094" y2="2063.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="571.5" y="2058.5435">AUTHENTICATION-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="723.5" y="2058.5435">model.registerCredential()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1049.5" x2="1091.5" y1="2092.7422" y2="2092.7422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1091.5" x2="1091.5" y1="2092.7422" y2="2105.7422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1050.5" x2="1091.5" y1="2105.7422" y2="2105.7422"/><polygon fill="#A80036" points="1060.5,2101.7422,1050.5,2105.7422,1060.5,2109.7422,1056.5,2105.7422" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1056.5" y="2087.6763">AUTHENTICATION-28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="1208.5" y="2087.6763">ThirdpartyRequests.putConsents()</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="174" x="1054" y="2118.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="1058" y="2134.8091">state: signedConsentSent</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="1054" y="2151.875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="1058" y="2167.9419">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="1058" y="2183.0747">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="1058" y="2198.2075">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="1058" y="2213.3403">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1049.5" x2="1091.5" y1="2246.5391" y2="2246.5391"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1091.5" x2="1091.5" y1="2246.5391" y2="2259.5391"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1050.5" x2="1091.5" y1="2259.5391" y2="2259.5391"/><polygon fill="#A80036" points="1060.5,2255.5391,1050.5,2259.5391,1060.5,2263.5391,1056.5,2259.5391" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1056.5" y="2241.4731">AUTHENTICATION-29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1208.5" y="2241.4731">this.saveToKVS({key: '1a2b3c4d'})</text><polygon fill="#A80036" points="2022.5,2284.6719,2032.5,2288.6719,2022.5,2292.6719,2026.5,2288.6719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1049.5" x2="2028.5" y1="2288.6719" y2="2288.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1056.5" y="2283.606">AUTHENTICATION-30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1208.5" y="2283.606">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1054" y="2301.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1058" y="2317.7388">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1058" y="2332.8716">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1058" y="2348.0044">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1058" y="2363.1372">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1066" y="2378.27">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1074" y="2393.4028">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1074" y="2408.5356">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1074" y="2423.6685">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1074" y="2438.8013">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1066" y="2453.9341">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="1066" y="2469.0669">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1074" y="2484.1997">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="1074" y="2499.3325">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="1074" y="2514.4653">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1066" y="2529.5981">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1058" y="2544.731">}</text><polygon fill="#A80036" points="1055.5,2573.9297,1045.5,2577.9297,1055.5,2581.9297,1051.5,2577.9297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1049.5" x2="2033.5" y1="2577.9297" y2="2577.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1061.5" y="2572.8638">AUTHENTICATION-31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1213.5" y="2572.8638">202 Accepted</text><polygon fill="#A80036" points="3243.5,2603.0625,3253.5,2607.0625,3243.5,2611.0625,3247.5,2607.0625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2044.5" x2="3249.5" y1="2607.0625" y2="2607.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2051.5" y="2601.9966">AUTHENTICATION-32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2203.5" y="2601.9966">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3265.5" x2="3307.5" y1="2636.1953" y2="2636.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3307.5" x2="3307.5" y1="2636.1953" y2="2649.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3266.5" x2="3307.5" y1="2649.1953" y2="2649.1953"/><polygon fill="#A80036" points="3276.5,2645.1953,3266.5,2649.1953,3276.5,2653.1953,3272.5,2649.1953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3272.5" y="2631.1294">AUTHENTICATION-33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3424.5" y="2631.1294">const model = await loadFromKVS({key: 1a2b3c4d})</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="201" x="3270" y="2662.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="3274" y="2678.2622">state: signedConsentReceived</text><polygon fill="#A80036" points="3759.5,2707.4609,3769.5,2711.4609,3759.5,2715.4609,3763.5,2711.4609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3265.5" x2="3765.5" y1="2711.4609" y2="2711.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3272.5" y="2706.395">AUTHENTICATION-34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3424.5" y="2706.395">model.validateSignedConsent()</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="264" x="3270" y="2724.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="3274" y="2740.5278">state: pendingRegistrationAndValidation</text><polygon fill="#A80036" points="2050.5,2769.7266,2040.5,2773.7266,2050.5,2777.7266,2046.5,2773.7266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="3259.5" y1="2773.7266" y2="2773.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2056.5" y="2768.6606">AUTHENTICATION-35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2208.5" y="2768.6606">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3781.5" x2="3823.5" y1="2802.8594" y2="2802.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3823.5" x2="3823.5" y1="2802.8594" y2="2815.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3782.5" x2="3823.5" y1="2815.8594" y2="2815.8594"/><polygon fill="#A80036" points="3792.5,2811.8594,3782.5,2815.8594,3792.5,2819.8594,3788.5,2815.8594" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3788.5" y="2797.7935">AUTHENTICATION-36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3940.5" y="2797.7935">Check signed consent.</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="530" x="3786" y="2828.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="522" x="3790" y="2844.9263">Does this need a backend request or can the SDK check the consent.</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="199" x="3786" y="2861.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="3790" y="2878.0591">state: signedConsentChecked</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3781.5" x2="3823.5" y1="2911.2578" y2="2911.2578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3823.5" x2="3823.5" y1="2911.2578" y2="2924.2578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3782.5" x2="3823.5" y1="2924.2578" y2="2924.2578"/><polygon fill="#A80036" points="3792.5,2920.2578,3782.5,2924.2578,3792.5,2928.2578,3788.5,2924.2578" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3788.5" y="2906.1919">AUTHENTICATION-37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="3940.5" y="2906.1919">model.validateWithAuthService()</text><polygon fill="#A80036" points="2055.5,2949.3906,2045.5,2953.3906,2055.5,2957.3906,2051.5,2953.3906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2049.5" x2="3770.5" y1="2953.3906" y2="2953.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2061.5" y="2948.3247">AUTHENTICATION-38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2213.5" y="2948.3247">POST /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="3408" y="2966.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="3412" y="2982.4575">POST /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3412" y="2997.5903">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3412" y="3012.7231">FSIOP-Destination: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3412" y="3027.856">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3420" y="3042.9888">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3428" y="3058.1216">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3428" y="3073.2544">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3428" y="3088.3872">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3428" y="3103.52">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3420" y="3118.6528">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3420" y="3133.7856">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="3428" y="3148.9185">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="3428" y="3164.0513">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="3428" y="3179.1841">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3420" y="3194.3169">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3412" y="3209.4497">}</text><polygon fill="#A80036" points="3759.5,3238.6484,3769.5,3242.6484,3759.5,3246.6484,3763.5,3242.6484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="3765.5" y1="3242.6484" y2="3242.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2051.5" y="3237.5825">AUTHENTICATION-39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2203.5" y="3237.5825">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3781.5" x2="3823.5" y1="3276.7813" y2="3276.7813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3823.5" x2="3823.5" y1="3276.7813" y2="3289.7813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3776.5" x2="3823.5" y1="3289.7813" y2="3289.7813"/><polygon fill="#A80036" points="3786.5,3285.7813,3776.5,3289.7813,3786.5,3293.7813,3782.5,3289.7813" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3788.5" y="3271.7153">AUTHENTICATION-40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="3940.5" y="3271.7153">this.saveToKVS()</text><polygon fill="#A80036" points="2370.5,3309.9141,2380.5,3313.9141,2370.5,3317.9141,2374.5,3313.9141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2044.5" x2="2376.5" y1="3313.9141" y2="3313.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2051.5" y="3308.8481">AUTHENTICATION-41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2203.5" y="3308.8481">POST /consents/1a2b3c4d</text><polygon fill="#A80036" points="2055.5,3339.0469,2045.5,3343.0469,2055.5,3347.0469,2051.5,3343.0469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2049.5" x2="2381.5" y1="3343.0469" y2="3343.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2061.5" y="3337.981">AUTHENTICATION-42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2213.5" y="3337.981">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2392.5" x2="2434.5" y1="3372.1797" y2="3372.1797"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2434.5" x2="2434.5" y1="3372.1797" y2="3385.1797"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2393.5" x2="2434.5" y1="3385.1797" y2="3385.1797"/><polygon fill="#A80036" points="2403.5,3381.1797,2393.5,3385.1797,2403.5,3389.1797,2399.5,3385.1797" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2399.5" y="3367.1138">AUTHENTICATION-43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="2551.5" y="3367.1138">Check consent.</text><polygon fill="#A80036" points="2055.5,3410.3125,2045.5,3414.3125,2055.5,3418.3125,2051.5,3414.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2049.5" x2="2381.5" y1="3414.3125" y2="3414.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2061.5" y="3409.2466">AUTHENTICATION-44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2213.5" y="3409.2466">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1dw90o7bh3xz5)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="2019" y="3427.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2023" y="3443.3794">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="2023" y="3458.5122">FSIOP-Source: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2023" y="3473.645">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2023" y="3488.7778">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="2031" y="3503.9106">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2039" y="3519.0435">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2039" y="3534.1763">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2039" y="3549.3091">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2039" y="3564.4419">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="2031" y="3579.5747">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="2031" y="3594.7075">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="2039" y="3609.8403">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="2039" y="3624.9731">status: "VERIFIED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="2039" y="3640.106">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2031" y="3655.2388">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2023" y="3670.3716">}</text><polygon fill="#A80036" points="2370.5,3699.5703,2380.5,3703.5703,2370.5,3707.5703,2374.5,3703.5703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="2376.5" y1="3703.5703" y2="3703.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2051.5" y="3698.5044">AUTHENTICATION-45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2203.5" y="3698.5044">200 OK</text><polygon fill="#A80036" points="3243.5,3728.7031,3253.5,3732.7031,3243.5,3736.7031,3247.5,3732.7031" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2044.5" x2="3249.5" y1="3732.7031" y2="3732.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2051.5" y="3727.6372">AUTHENTICATION-46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2203.5" y="3727.6372">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3265.5" x2="3307.5" y1="3761.8359" y2="3761.8359"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3307.5" x2="3307.5" y1="3761.8359" y2="3774.8359"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3266.5" x2="3307.5" y1="3774.8359" y2="3774.8359"/><polygon fill="#A80036" points="3276.5,3770.8359,3266.5,3774.8359,3276.5,3778.8359,3272.5,3774.8359" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3272.5" y="3756.77">AUTHENTICATION-47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3424.5" y="3756.77">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3265.5" x2="3307.5" y1="3803.9688" y2="3803.9688"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3307.5" x2="3307.5" y1="3803.9688" y2="3816.9688"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3266.5" x2="3307.5" y1="3816.9688" y2="3816.9688"/><polygon fill="#A80036" points="3276.5,3812.9688,3266.5,3816.9688,3276.5,3820.9688,3272.5,3816.9688" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3272.5" y="3798.9028">AUTHENTICATION-48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="3424.5" y="3798.9028">consentResponseReceived()</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="219" x="3270" y="3829.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="3274" y="3846.0356">state: consentResponseReceived</text><polygon fill="#A80036" points="3759.5,3875.2344,3769.5,3879.2344,3759.5,3883.2344,3763.5,3879.2344" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3265.5" x2="3765.5" y1="3879.2344" y2="3879.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3272.5" y="3874.1685">AUTHENTICATION-49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="3424.5" y="3874.1685">Auth Service response received</text><polygon fill="#A80036" points="2050.5,3904.3672,2040.5,3908.3672,2050.5,3912.3672,2046.5,3908.3672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="3259.5" y1="3908.3672" y2="3908.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2056.5" y="3903.3013">AUTHENTICATION-50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2208.5" y="3903.3013">200 OK</text><polygon fill="#A80036" points="2811.5,3933.5,2821.5,3937.5,2811.5,3941.5,2815.5,3937.5" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2392.5" x2="2817.5" y1="3937.5" y2="3937.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2399.5" y="3932.4341">AUTHENTICATION-51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="2551.5" y="3932.4341">POST /participants/CONSENTS/1a2b3c4d</text><polygon fill="#A80036" points="2398.5,3962.6328,2388.5,3966.6328,2398.5,3970.6328,2394.5,3966.6328" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2392.5" x2="2822.5" y1="3966.6328" y2="3966.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2404.5" y="3961.5669">AUTHENTICATION-52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2556.5" y="3961.5669">202 Accepted</text><polygon fill="#A80036" points="3243.5,3991.7656,3253.5,3995.7656,3243.5,3999.7656,3247.5,3995.7656" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2833.5" x2="3249.5" y1="3995.7656" y2="3995.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2840.5" y="3990.6997">AUTHENTICATION-53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="2992.5" y="3990.6997">PUT /participants/CONSENTS/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3265.5" x2="3307.5" y1="4024.8984" y2="4024.8984"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3307.5" x2="3307.5" y1="4024.8984" y2="4037.8984"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3266.5" x2="3307.5" y1="4037.8984" y2="4037.8984"/><polygon fill="#A80036" points="3276.5,4033.8984,3266.5,4037.8984,3276.5,4041.8984,3272.5,4037.8984" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3272.5" y="4019.8325">AUTHENTICATION-54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3424.5" y="4019.8325">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3265.5" x2="3307.5" y1="4067.0313" y2="4067.0313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3307.5" x2="3307.5" y1="4067.0313" y2="4080.0313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3266.5" x2="3307.5" y1="4080.0313" y2="4080.0313"/><polygon fill="#A80036" points="3276.5,4076.0313,3266.5,4080.0313,3276.5,4084.0313,3272.5,4080.0313" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3272.5" y="4061.9653">AUTHENTICATION-55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="3424.5" y="4061.9653">participantResponseReceived()</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="243" x="3270" y="4093.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="235" x="3274" y="4109.0981">state: participantsResponseReceived</text><polygon fill="#A80036" points="3759.5,4138.2969,3769.5,4142.2969,3759.5,4146.2969,3763.5,4142.2969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3265.5" x2="3765.5" y1="4142.2969" y2="4142.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3272.5" y="4137.231">AUTHENTICATION-56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3424.5" y="4137.231">Participant response received</text><polygon fill="#A80036" points="2839.5,4167.4297,2829.5,4171.4297,2839.5,4175.4297,2835.5,4171.4297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2833.5" x2="3259.5" y1="4171.4297" y2="4171.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2845.5" y="4166.3638">AUTHENTICATION-57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2997.5" y="4166.3638">200 Accepted</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="253" x="3786" y="4184.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="3790" y="4200.4966">state: consentRegisteredAndValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3781.5" x2="3823.5" y1="4233.6953" y2="4233.6953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3823.5" x2="3823.5" y1="4233.6953" y2="4246.6953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3782.5" x2="3823.5" y1="4246.6953" y2="4246.6953"/><polygon fill="#A80036" points="3792.5,4242.6953,3782.5,4246.6953,3792.5,4250.6953,3788.5,4246.6953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3788.5" y="4228.6294">AUTHENTICATION-58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="3940.5" y="4228.6294">model.finalizeConsent()</text><path d="M1998,4261.6953 L2075,4261.6953 L2075,4268.6953 L2065,4278.6953 L1998,4278.6953 L1998,4261.6953 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="1998" y="4261.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="2013" y="4274.7622">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="116" x="2090" y="4273.9058">[for each scope in</text><text fill="#000000" font-family="monospace" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="105" x="2210" y="4273.9058">Consents.scopes</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="5" x="2315" y="4273.9058">]</text><polygon fill="#A80036" points="2050.5,4295.9609,2040.5,4299.9609,2050.5,4303.9609,2046.5,4299.9609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2044.5" x2="3770.5" y1="4299.9609" y2="4299.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2056.5" y="4294.895">AUTHENTICATION-59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2208.5" y="4294.895">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="3759.5,4325.0938,3769.5,4329.0938,3759.5,4333.0938,3763.5,4329.0938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2039.5" x2="3765.5" y1="4329.0938" y2="4329.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2046.5" y="4324.0278">AUTHENTICATION-60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2198.5" y="4324.0278">202 Accepted</text><polygon fill="#A80036" points="2816.5,4354.2266,2826.5,4358.2266,2816.5,4362.2266,2820.5,4358.2266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2039.5" x2="2822.5" y1="4358.2266" y2="4358.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2046.5" y="4353.1606">AUTHENTICATION-61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2198.5" y="4353.1606">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2050.5,4383.3594,2040.5,4387.3594,2050.5,4391.3594,2046.5,4387.3594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="2827.5" y1="4387.3594" y2="4387.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2056.5" y="4382.2935">AUTHENTICATION-62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2208.5" y="4382.2935">202 Accepted</text><polygon fill="#A80036" points="2050.5,4412.4922,2040.5,4416.4922,2050.5,4420.4922,2046.5,4416.4922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2044.5" x2="2827.5" y1="4416.4922" y2="4416.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2056.5" y="4411.4263">AUTHENTICATION-63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="402" x="2208.5" y="4411.4263">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678/error</text><polygon fill="#A80036" points="2816.5,4441.625,2826.5,4445.625,2816.5,4449.625,2820.5,4445.625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2039.5" x2="2822.5" y1="4445.625" y2="4445.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2046.5" y="4440.5591">AUTHENTICATION-64</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2198.5" y="4440.5591">200 OK</text><polygon fill="#A80036" points="3248.5,4470.7578,3258.5,4474.7578,3248.5,4478.7578,3252.5,4474.7578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2039.5" x2="3254.5" y1="4474.7578" y2="4474.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2046.5" y="4469.6919">AUTHENTICATION-65</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="402" x="2198.5" y="4469.6919">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678/error</text><polygon fill="#A80036" points="2050.5,4499.8906,2040.5,4503.8906,2050.5,4507.8906,2046.5,4503.8906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="3259.5" y1="4503.8906" y2="4503.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2056.5" y="4498.8247">AUTHENTICATION-66</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2208.5" y="4498.8247">200 OK</text><polygon fill="#A80036" points="3759.5,4529.0234,3769.5,4533.0234,3759.5,4537.0234,3763.5,4533.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3260.5" x2="3765.5" y1="4533.0234" y2="4533.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3267.5" y="4527.9575">AUTHENTICATION-67</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3419.5" y="4527.9575">Participant response received</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3781.5" x2="3823.5" y1="4569.1563" y2="4569.1563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3823.5" x2="3823.5" y1="4569.1563" y2="4582.1563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3782.5" x2="3823.5" y1="4582.1563" y2="4582.1563"/><polygon fill="#A80036" points="3792.5,4578.1563,3782.5,4582.1563,3792.5,4586.1563,3788.5,4582.1563" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3788.5" y="4564.0903">AUTHENTICATION-68</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="3940.5" y="4564.0903">await Promise.all()</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="3786" y="4595.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="3790" y="4611.2231">state: errored</text><polygon fill="#A80036" points="2055.5,4640.4219,2045.5,4644.4219,2055.5,4648.4219,2051.5,4644.4219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2049.5" x2="3770.5" y1="4644.4219" y2="4644.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2061.5" y="4639.356">AUTHENTICATION-69</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="2213.5" y="4639.356">PUT /consents/1a2b3c4d/error</text><rect fill="#F08080" filter="url(#f1dw90o7bh3xz5)" height="204" style="stroke:#A80036;stroke-width:1.0;" width="407" x="3359" y="4657.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="3363" y="4673.4888">PUT /consents/1a2b3c4d/error</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3363" y="4688.6216">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3363" y="4703.7544">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3363" y="4718.8872">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="3371" y="4734.02">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="3379" y="4749.1528">errorCode: '7200',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="368" x="3379" y="4764.2856">errorDescription: 'Generic Thirdparty account linking error'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="3371" y="4779.4185">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="3371" y="4794.5513">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="3379" y="4809.6841">errorCode: '7214',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="383" x="3379" y="4824.8169">errorDescription: 'Failed to register account links with oracle'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3371" y="4839.9497">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3363" y="4855.0825">}</text><polygon fill="#A80036" points="3764.5,4884.2813,3774.5,4888.2813,3764.5,4892.2813,3768.5,4888.2813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="3770.5" y1="4888.2813" y2="4888.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2051.5" y="4883.2153">AUTHENTICATION-70</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2203.5" y="4883.2153">200 OK</text><polygon fill="#A80036" points="1570.5,4913.4141,1560.5,4917.4141,1570.5,4921.4141,1566.5,4917.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1564.5" x2="2033.5" y1="4917.4141" y2="4917.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1576.5" y="4912.3481">AUTHENTICATION-71</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="1728.5" y="4912.3481">PUT /consents/1a2b3c4d/error</text><polygon fill="#A80036" points="2027.5,4942.5469,2037.5,4946.5469,2027.5,4950.5469,2031.5,4946.5469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1559.5" x2="2033.5" y1="4946.5469" y2="4946.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1566.5" y="4941.481">AUTHENTICATION-72</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1718.5" y="4941.481">200 OK</text><polygon fill="#A80036" points="1060.5,4971.6797,1050.5,4975.6797,1060.5,4979.6797,1056.5,4975.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1054.5" x2="1553.5" y1="4975.6797" y2="4975.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1066.5" y="4970.6138">AUTHENTICATION-73</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="1218.5" y="4970.6138">MojaloopFSPIOPError response received</text><rect fill="#FBFB77" filter="url(#f1dw90o7bh3xz5)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="1054" y="4988.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1058" y="5004.7466">state: errored</text><polygon fill="#A80036" points="575.5,5033.9453,565.5,5037.9453,575.5,5041.9453,571.5,5037.9453" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="569.5" x2="1043.5" y1="5037.9453" y2="5037.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="581.5" y="5032.8794">AUTHENTICATION-74</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="733.5" y="5032.8794">return MojaloopFSPIOPError</text><polygon fill="#A80036" points="72.5,5063.0781,62.5,5067.0781,72.5,5071.0781,68.5,5067.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="66.5" x2="558.5" y1="5067.0781" y2="5067.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="78.5" y="5062.0122">AUTHENTICATION-75</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="230.5" y="5062.0122">500 Internal Server Error ErrorInformationObject</text><!--MD5=[6cef98bed9897f3550d83f6a1e87f27e]
@startuml

title PISP Linking Error Scenarios Register Credential Phase

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
    participant "Auth Service" as AUTH
    participant "Account Lookup Service" as ALS
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box
participant DFSPAuthorizeSimulator

== Authentication+Grant Consent+Register Credential ==
autonumber 1 "<b>AUTHENTICATION-#</b>"
rnote right of PISP
PISP has obtained authToken from end-user(OTP) or through a callback(Web).
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent/6789/authenticate
rnote right of PISP #LightBlue
POST /linking/request-consent/6789/authenticate
{
  authToken: '123456'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS({key: 6789})
rnote right of PISP_TP_OUT: state: webAuthenticationChannelResponseReceived or OTPAuthenticationChannelResponseReceived
PISP_TP_OUT -> PISP_LM: model.authenticate()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.patchConsentRequests()
PISP_LM -> Switch: PATCH /consentRequests/6789
rnote right of PISP_LM #LightBlue
PATCH /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  authToken: '124356'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PATCH /consentRequests/6789
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 6789})
rnote right of DFSP_TP_IN: state: consentRequestValidatedAndStored
DFSP_TP_IN -> DFSP_LM: model.validateAuthToken()
deactivate DFSP_TP_IN
activate DFSP_LM

DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateAuthToken()
rnote right of DFSP_LM #LightBlue
Do we need two backend endpoints for validating
web authTokens and OTP authTokens? Or is a DFSP expected to
validate both cases with one endpoint?

POST /validateAuthToken
{
  consentRequestId: '6789'
  authChannel: model.data.authChannel,
  authToken: '124356'
}
end note
rnote right of DFSP_LM: state: authTokenValidated

DFSP_LM -> DFSP_LM: const consentId = uuid()
DFSP_LM -> DFSP_LM: model.grantConsent()
DFSP_LM -> DFSP_LM: ThirdpartyRequests.postConsents()
rnote right of DFSP_LM: state: consentGranted
rnote right of DFSP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
DFSP_LM -> DFSP_LM: this.saveToKVS({key: '1a2b3c4d'})

DFSP_LM -> Switch: POST /consents
activate Switch

rnote left of DFSP_LM #LightBlue
POST /consents
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  consentId: 1a2b3c4d
  consentRequestId: 6789
  scopes: model.data.scopes
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
Switch ->  PISP_TP_IN: POST /consents
activate PISP_TP_IN
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 6789})
PISP_TP_IN -> PISP_LM: model.consentReceivedAwaitCredential()
activate PISP_LM
PISP_LM - -> PISP_LM: const challenge = deriveChallenge(consentRequest)
PISP_TP_IN - -> Switch: 202 Accepted
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: consentReceivedAwaitingCredential
PISP_LM -> PISP_TP_OUT: return Model state and challenge
deactivate PISP_LM
PISP_TP_OUT -> PISP: 200 OK Model State and challenge
rnote left of PISP_TP_OUT #LightBlue
{
  currentState: "consentReceivedAwaitingCredential"
  challenge: challenge
}
end note

rnote right of PISP
PISP has obtained credential from the end-user
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent/6789/authenticate
rnote right of PISP #LightBlue
POST /linking/request-consent/6789/pass-credential
{
  credential: {
    payload: PublicKeyCredential
  }
}
end note
PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS({key: 6789})
PISP_TP_OUT -> PISP_LM: model.registerCredential()
activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.putConsents()
rnote right of PISP_LM: state: signedConsentSent
rnote right of PISP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
PISP_LM - -> PISP_LM: this.saveToKVS({key: '1a2b3c4d'})
PISP_LM -> Switch: PUT /consents/1a2b3c4d
activate Switch

rnote right of PISP_LM #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
activate DFSP_TP_IN

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
rnote right of DFSP_TP_IN: state: signedConsentReceived
DFSP_TP_IN -> DFSP_LM: model.validateSignedConsent()
activate DFSP_LM
rnote right of DFSP_TP_IN: state: pendingRegistrationAndValidation
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: Check signed consent.
rnote right of DFSP_LM #LightBlue
Does this need a backend request or can the SDK check the consent.
end note
rnote right of DFSP_LM: state: signedConsentChecked
DFSP_LM-> DFSP_LM: model.validateWithAuthService()
DFSP_LM -> Switch: POST /consents/1a2b3c4d
activate Switch

rnote left of DFSP_LM #LightBlue
POST /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: central-auth
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note
Switch - -> DFSP_LM: 202 Accepted
DFSP_LM -> DFSP_LM: this.saveToKVS()
deactivate DFSP_LM

Switch -> AUTH: POST /consents/1a2b3c4d
activate AUTH
AUTH - -> Switch: 202 Accepted
AUTH -> AUTH: Check consent.
AUTH -> Switch: PUT /consents/1a2b3c4d

rnote left of AUTH #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: central-auth
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "VERIFIED",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> AUTH: 200 OK
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: consentResponseReceived()
rnote right of DFSP_TP_IN: state: consentResponseReceived
DFSP_TP_IN -> DFSP_LM: Auth Service response received
activate DFSP_LM
DFSP_TP_IN - -> Switch: 200 OK
deactivate Switch
deactivate DFSP_TP_IN

AUTH -> ALS: POST /participants/CONSENTS/1a2b3c4d
activate ALS
ALS - -> AUTH: 202 Accepted
deactivate AUTH

ALS -> DFSP_TP_IN: PUT /participants/CONSENTS/1a2b3c4d
activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: participantResponseReceived()
rnote right of DFSP_TP_IN: state: participantsResponseReceived
DFSP_TP_IN -> DFSP_LM: Participant response received
DFSP_TP_IN - -> ALS: 200 Accepted
deactivate ALS
deactivate DFSP_TP_IN
rnote right of DFSP_LM: state: consentRegisteredAndValidated
DFSP_LM -> DFSP_LM: model.finalizeConsent()

loop for each scope in ""Consents.scopes""
DFSP_LM -> Switch: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> DFSP_LM: 202 Accepted
Switch -> ALS: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
ALS - -> Switch: 202 Accepted
ALS -> Switch: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678/error
Switch - -> ALS: 200 OK
Switch -> DFSP_TP_IN: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678/error
DFSP_TP_IN - -> Switch: 200 OK
DFSP_TP_IN -> DFSP_LM: Participant response received
end

DFSP_LM -> DFSP_LM: await Promise.all()
rnote right of DFSP_LM: state: errored
DFSP_LM -> Switch: PUT /consents/1a2b3c4d/error
activate Switch

rnote left of DFSP_LM #LightCoral
PUT /consents/1a2b3c4d/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '7200',
    errorDescription: 'Generic Thirdparty account linking error'
  } OR
  errorInformation: {
    errorCode: '7214',
    errorDescription: 'Failed to register account links with oracle'
  }
}
end note
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consents/1a2b3c4d/error
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
PISP_TP_IN - -> PISP_LM: MojaloopFSPIOPError response received
deactivate PISP_TP_IN
activate PISP_LM
rnote right of PISP_LM: state: errored
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP
@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>