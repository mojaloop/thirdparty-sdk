<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3505px" preserveAspectRatio="none" style="width:3527px;height:3505px;" version="1.1" viewBox="0 0 3527 3505" width="3527px" zoomAndPan="magnify"><defs><filter height="300%" id="fb3rrkwf3cfs0" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="471" x="1524.5" y="28.708">PISP Linking Error Scenarios Grant Consent Phase - 1</text><rect fill="#DDDDDD" height="3458.0547" style="stroke:#A80036;stroke-width:1.0;" width="1131.5" x="488.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="964.25" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="3458.0547" style="stroke:#A80036;stroke-width:1.0;" width="379" x="2004" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="2160" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="3458.0547" style="stroke:#A80036;stroke-width:1.0;" width="658" x="2385" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="2621" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="3239.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="56.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="3239.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="554.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="385.7109"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="1580.0859"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="514.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="2063.6094"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="3351.3125"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="142.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1549.5" y="1508.8203"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1549.5" y="3293.0469"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="196.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="456.9766"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="339.8594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="1311.4922"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="485.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="2288.6719"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="302.125" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="3020.0547"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2445.5" y="624.0391"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2445.5" y="2607.0625"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="722.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2961.5" y="757.5703"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="552.4531" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2961.5" y="2711.4609"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="61" x2="61" y1="95.3828" y2="3460.7109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="559.5" x2="559.5" y1="95.3828" y2="3460.7109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1044.5" x2="1044.5" y1="95.3828" y2="3460.7109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1554" x2="1554" y1="95.3828" y2="3460.7109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2039" x2="2039" y1="95.3828" y2="3460.7109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2133" x2="2133" y1="95.3828" y2="3460.7109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2287" x2="2287" y1="95.3828" y2="3460.7109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2450" x2="2450" y1="95.3828" y2="3460.7109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2966" x2="2966" y1="95.3828" y2="3460.7109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3422" x2="3422" y1="95.3828" y2="3460.7109"/><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="12" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="5" y="3459.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="12" y="3479.7061">PISP Backend</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="492.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="499.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="492.5" y="3459.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="499.5" y="3479.7061">outbound-server</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="975.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="982.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="975.5" y="3459.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="982.5" y="3479.7061">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1493" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1500" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1493" y="3459.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1500" y="3479.7061">inbound-server</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2008" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2015" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2008" y="3459.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2015" y="3479.7061">Switch</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2081" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2088" y="80.0811">Auth Service</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2081" y="3459.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2088" y="3479.7061">Auth Service</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2195" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2202" y="80.0811">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2195" y="3459.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2202" y="3479.7061">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="2389" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2396" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="2389" y="3459.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2396" y="3479.7061">inbound-server</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="2894" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="2901" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="2894" y="3459.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="2901" y="3479.7061">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="3330" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="3337" y="80.0811">DFSPAuthorizeSimulator</text><rect fill="#FEFECE" filter="url(#fb3rrkwf3cfs0)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="3330" y="3459.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="3337" y="3479.7061">DFSPAuthorizeSimulator</text><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="3239.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="56.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="3239.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="554.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="385.7109"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="1580.0859"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="514.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="2063.6094"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1039.5" y="3351.3125"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="142.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1549.5" y="1508.8203"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1549.5" y="3293.0469"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="196.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="456.9766"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="339.8594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="1311.4922"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="485.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="2288.6719"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="302.125" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2034.5" y="3020.0547"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2445.5" y="624.0391"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2445.5" y="2607.0625"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="722.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2961.5" y="757.5703"/><rect fill="#FFFFFF" filter="url(#fb3rrkwf3cfs0)" height="552.4531" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2961.5" y="2711.4609"/><rect fill="#EEEEEE" filter="url(#fb3rrkwf3cfs0)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="3520" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3520" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3520" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#fb3rrkwf3cfs0)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="243" x="1638.5" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="224" x="1644.5" y="131.4497">Authentication+Grant Consent</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="503" x="66" y="153.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495" x="70" y="169.5825">PISP has obtained authToken from end-user(OTP) or through a callback(Web).</text><polygon fill="#A80036" points="542.5,198.7813,552.5,202.7813,542.5,206.7813,546.5,202.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="66.5" x2="548.5" y1="202.7813" y2="202.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="73.5" y="197.7153">AUTHENTICATION-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="216.5" y="197.7153">POST /linking/request-consent/6789/authenticate</text><rect fill="#ADD8E6" filter="url(#fb3rrkwf3cfs0)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="320" x="71" y="215.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="75" y="231.8481">POST /linking/request-consent/6789/authenticate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="246.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="83" y="262.1138">authToken: '123456'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="277.2466">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="564.5" x2="606.5" y1="310.4453" y2="310.4453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="606.5" x2="606.5" y1="310.4453" y2="323.4453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="565.5" x2="606.5" y1="323.4453" y2="323.4453"/><polygon fill="#A80036" points="575.5,319.4453,565.5,323.4453,575.5,327.4453,571.5,323.4453" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="571.5" y="305.3794">AUTHENTICATION-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="714.5" y="305.3794">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="648" x="569" y="336.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="640" x="573" y="352.5122">state: webAuthenticationChannelResponseReceived or OTPAuthenticationChannelResponseReceived</text><polygon fill="#A80036" points="1027.5,381.7109,1037.5,385.7109,1027.5,389.7109,1031.5,385.7109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="564.5" x2="1033.5" y1="385.7109" y2="385.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="571.5" y="380.645">AUTHENTICATION-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="714.5" y="380.645">model.authenticate()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1049.5" x2="1091.5" y1="414.8438" y2="414.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1091.5" x2="1091.5" y1="414.8438" y2="427.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1050.5" x2="1091.5" y1="427.8438" y2="427.8438"/><polygon fill="#A80036" points="1060.5,423.8438,1050.5,427.8438,1060.5,431.8438,1056.5,427.8438" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1056.5" y="409.7778">AUTHENTICATION-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="1199.5" y="409.7778">ThirdpartyRequests.patchConsentRequests()</text><polygon fill="#A80036" points="2022.5,452.9766,2032.5,456.9766,2022.5,460.9766,2026.5,456.9766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1049.5" x2="2028.5" y1="456.9766" y2="456.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1056.5" y="451.9106">AUTHENTICATION-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1199.5" y="451.9106">PATCH /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#fb3rrkwf3cfs0)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="205" x="1054" y="469.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1058" y="486.0435">PATCH /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1058" y="501.1763">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1058" y="516.3091">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1058" y="531.4419">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1066" y="546.5747">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1058" y="561.7075">}</text><polygon fill="#A80036" points="1055.5,590.9063,1045.5,594.9063,1055.5,598.9063,1051.5,594.9063" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1049.5" x2="2033.5" y1="594.9063" y2="594.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1061.5" y="589.8403">AUTHENTICATION-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1204.5" y="589.8403">202 Accepted</text><polygon fill="#A80036" points="2433.5,620.0391,2443.5,624.0391,2433.5,628.0391,2437.5,624.0391" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2044.5" x2="2439.5" y1="624.0391" y2="624.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2051.5" y="618.9731">AUTHENTICATION-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="2194.5" y="618.9731">PATCH /consentRequests/6789</text><polygon fill="#A80036" points="2050.5,649.1719,2040.5,653.1719,2050.5,657.1719,2046.5,653.1719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="2444.5" y1="653.1719" y2="653.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2056.5" y="648.106">AUTHENTICATION-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2199.5" y="648.106">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2455.5" x2="2497.5" y1="682.3047" y2="682.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2497.5" x2="2497.5" y1="682.3047" y2="695.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2456.5" x2="2497.5" y1="695.3047" y2="695.3047"/><polygon fill="#A80036" points="2466.5,691.3047,2456.5,695.3047,2466.5,699.3047,2462.5,695.3047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2462.5" y="677.2388">AUTHENTICATION-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="2605.5" y="677.2388">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="2460" y="708.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="2464" y="724.3716">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="2949.5,753.5703,2959.5,757.5703,2949.5,761.5703,2953.5,757.5703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2450.5" x2="2955.5" y1="757.5703" y2="757.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2457.5" y="752.5044">AUTHENTICATION-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="2609.5" y="752.5044">model.validateAuthToken()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2971.5" x2="3013.5" y1="786.7031" y2="786.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3013.5" x2="3013.5" y1="786.7031" y2="799.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2972.5" x2="3013.5" y1="799.7031" y2="799.7031"/><polygon fill="#A80036" points="2982.5,795.7031,2972.5,799.7031,2982.5,803.7031,2978.5,799.7031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2978.5" y="781.6372">AUTHENTICATION-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="3130.5" y="781.6372">DFSPBackendRequests.validateAuthToken()</text><rect fill="#ADD8E6" filter="url(#fb3rrkwf3cfs0)" height="159" style="stroke:#A80036;stroke-width:1.0;" width="416" x="2976" y="812.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="2980" y="828.77">Do we need two backend endpoints for validating</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="408" x="2980" y="843.9028">web authTokens and OTP authTokens? Or is a DFSP expected to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="2980" y="859.0356">validate both cases with one endpoint?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="2984" y="874.1685"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="2980" y="889.3013">POST /validateAuthToken</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2980" y="904.4341">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="2988" y="919.5669">consentRequestId: '6789'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="2988" y="934.6997">authChannel: model.data.authChannel,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="2988" y="949.8325">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2980" y="964.9653">}</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="176" x="2976" y="982.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="2980" y="998.0981">state: authTokenValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2971.5" x2="3013.5" y1="1031.2969" y2="1031.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3013.5" x2="3013.5" y1="1031.2969" y2="1044.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2972.5" x2="3013.5" y1="1044.2969" y2="1044.2969"/><polygon fill="#A80036" points="2982.5,1040.2969,2972.5,1044.2969,2982.5,1048.2969,2978.5,1044.2969" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2978.5" y="1026.231">AUTHENTICATION-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3130.5" y="1026.231">const consentId = uuid()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2971.5" x2="3013.5" y1="1073.4297" y2="1073.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3013.5" x2="3013.5" y1="1073.4297" y2="1086.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2972.5" x2="3013.5" y1="1086.4297" y2="1086.4297"/><polygon fill="#A80036" points="2982.5,1082.4297,2972.5,1086.4297,2982.5,1090.4297,2978.5,1086.4297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2978.5" y="1068.3638">AUTHENTICATION-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="3130.5" y="1068.3638">model.grantConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2971.5" x2="3013.5" y1="1115.5625" y2="1115.5625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3013.5" x2="3013.5" y1="1115.5625" y2="1128.5625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2972.5" x2="3013.5" y1="1128.5625" y2="1128.5625"/><polygon fill="#A80036" points="2982.5,1124.5625,2972.5,1128.5625,2982.5,1132.5625,2978.5,1128.5625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2978.5" y="1110.4966">AUTHENTICATION-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="3130.5" y="1110.4966">ThirdpartyRequests.postConsents()</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="152" x="2976" y="1141.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="2980" y="1157.6294">state: consentGranted</text><rect fill="#ADD8E6" filter="url(#fb3rrkwf3cfs0)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="2976" y="1174.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="2980" y="1190.7622">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="2980" y="1205.895">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="2980" y="1221.0278">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="2980" y="1236.1606">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2971.5" x2="3013.5" y1="1269.3594" y2="1269.3594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3013.5" x2="3013.5" y1="1269.3594" y2="1282.3594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2972.5" x2="3013.5" y1="1282.3594" y2="1282.3594"/><polygon fill="#A80036" points="2982.5,1278.3594,2972.5,1282.3594,2982.5,1286.3594,2978.5,1282.3594" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2978.5" y="1264.2935">AUTHENTICATION-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="3130.5" y="1264.2935">this.saveToKVS({key: '1a2b3c4d'})</text><polygon fill="#A80036" points="2055.5,1307.4922,2045.5,1311.4922,2055.5,1315.4922,2051.5,1311.4922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2049.5" x2="2960.5" y1="1311.4922" y2="1311.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2061.5" y="1306.4263">AUTHENTICATION-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="2213.5" y="1306.4263">POST /consents</text><rect fill="#ADD8E6" filter="url(#fb3rrkwf3cfs0)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="191" x="2765" y="1324.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="2769" y="1340.5591">POST /consents</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="2769" y="1355.6919">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="2769" y="1370.8247">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2769" y="1385.9575">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="2777" y="1401.0903">consentId: 1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="2777" y="1416.2231">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="2777" y="1431.356">scopes: model.data.scopes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2769" y="1446.4888">}</text><polygon fill="#A80036" points="2954.5,1475.6875,2964.5,1479.6875,2954.5,1483.6875,2958.5,1479.6875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="2960.5" y1="1479.6875" y2="1479.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2051.5" y="1474.6216">AUTHENTICATION-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2203.5" y="1474.6216">202 ACCEPTED</text><polygon fill="#A80036" points="1570.5,1504.8203,1560.5,1508.8203,1570.5,1512.8203,1566.5,1508.8203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1564.5" x2="2033.5" y1="1508.8203" y2="1508.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1576.5" y="1503.7544">AUTHENTICATION-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="1728.5" y="1503.7544">POST /consents</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1559.5" x2="1601.5" y1="1537.9531" y2="1537.9531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1601.5" x2="1601.5" y1="1537.9531" y2="1550.9531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1560.5" x2="1601.5" y1="1550.9531" y2="1550.9531"/><polygon fill="#A80036" points="1570.5,1546.9531,1560.5,1550.9531,1570.5,1554.9531,1566.5,1550.9531" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1566.5" y="1532.8872">AUTHENTICATION-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="1718.5" y="1532.8872">const model = await loadFromKVS({key: 6789})</text><polygon fill="#A80036" points="1060.5,1576.0859,1050.5,1580.0859,1060.5,1584.0859,1056.5,1580.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1054.5" x2="1548.5" y1="1580.0859" y2="1580.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1066.5" y="1575.02">AUTHENTICATION-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="261" x="1218.5" y="1575.02">model.consentReceivedAwaitCredential()</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1049.5" x2="1091.5" y1="1609.2188" y2="1609.2188"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1091.5" x2="1091.5" y1="1609.2188" y2="1622.2188"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1050.5" x2="1091.5" y1="1622.2188" y2="1622.2188"/><polygon fill="#A80036" points="1060.5,1618.2188,1050.5,1622.2188,1060.5,1626.2188,1056.5,1622.2188" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1056.5" y="1604.1528">AUTHENTICATION-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1208.5" y="1604.1528">const challenge = deriveChallenge(consentRequest)</text><polygon fill="#A80036" points="2027.5,1647.3516,2037.5,1651.3516,2027.5,1655.3516,2031.5,1651.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1554.5" x2="2033.5" y1="1651.3516" y2="1651.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1561.5" y="1646.2856">AUTHENTICATION-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1713.5" y="1646.2856">202 Accepted</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="275" x="1054" y="1664.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="267" x="1058" y="1680.4185">state: consentReceivedAwaitingCredential</text><polygon fill="#A80036" points="575.5,1709.6172,565.5,1713.6172,575.5,1717.6172,571.5,1713.6172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="569.5" x2="1043.5" y1="1713.6172" y2="1713.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="581.5" y="1708.5513">AUTHENTICATION-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="733.5" y="1708.5513">return Model state and challenge</text><polygon fill="#A80036" points="77.5,1738.75,67.5,1742.75,77.5,1746.75,73.5,1742.75" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="71.5" x2="553.5" y1="1742.75" y2="1742.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="83.5" y="1737.6841">AUTHENTICATION-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="235.5" y="1737.6841">200 OK Model State and challenge</text><rect fill="#ADD8E6" filter="url(#fb3rrkwf3cfs0)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="341" x="208" y="1755.75"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="212" y="1771.8169">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="325" x="220" y="1786.9497">currentState: "consentReceivedAwaitingCredential"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="220" y="1802.0825">challenge: challenge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="212" y="1817.2153">}</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="310" x="71" y="1834.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="302" x="75" y="1850.3481">PISP has obtained credential from the end-user</text><polygon fill="#A80036" points="542.5,1879.5469,552.5,1883.5469,542.5,1887.5469,546.5,1883.5469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="66.5" x2="548.5" y1="1883.5469" y2="1883.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="73.5" y="1878.481">AUTHENTICATION-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="225.5" y="1878.481">POST /linking/request-consent/6789/authenticate</text><rect fill="#ADD8E6" filter="url(#fb3rrkwf3cfs0)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="337" x="71" y="1896.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="329" x="75" y="1912.6138">POST /linking/request-consent/6789/pass-credential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="1927.7466">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="83" y="1942.8794">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="91" y="1958.0122">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="83" y="1973.145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="1988.2778">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="564.5" x2="606.5" y1="2021.4766" y2="2021.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="606.5" x2="606.5" y1="2021.4766" y2="2034.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="565.5" x2="606.5" y1="2034.4766" y2="2034.4766"/><polygon fill="#A80036" points="575.5,2030.4766,565.5,2034.4766,575.5,2038.4766,571.5,2034.4766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="571.5" y="2016.4106">AUTHENTICATION-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="723.5" y="2016.4106">const model = await loadFromKVS({key: 6789})</text><polygon fill="#A80036" points="1027.5,2059.6094,1037.5,2063.6094,1027.5,2067.6094,1031.5,2063.6094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="564.5" x2="1033.5" y1="2063.6094" y2="2063.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="571.5" y="2058.5435">AUTHENTICATION-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="723.5" y="2058.5435">model.registerCredential()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1049.5" x2="1091.5" y1="2092.7422" y2="2092.7422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1091.5" x2="1091.5" y1="2092.7422" y2="2105.7422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1050.5" x2="1091.5" y1="2105.7422" y2="2105.7422"/><polygon fill="#A80036" points="1060.5,2101.7422,1050.5,2105.7422,1060.5,2109.7422,1056.5,2105.7422" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1056.5" y="2087.6763">AUTHENTICATION-28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="1208.5" y="2087.6763">ThirdpartyRequests.putConsents()</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="174" x="1054" y="2118.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="1058" y="2134.8091">state: signedConsentSent</text><rect fill="#ADD8E6" filter="url(#fb3rrkwf3cfs0)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="1054" y="2151.875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="1058" y="2167.9419">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="1058" y="2183.0747">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="1058" y="2198.2075">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="1058" y="2213.3403">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1049.5" x2="1091.5" y1="2246.5391" y2="2246.5391"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1091.5" x2="1091.5" y1="2246.5391" y2="2259.5391"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1050.5" x2="1091.5" y1="2259.5391" y2="2259.5391"/><polygon fill="#A80036" points="1060.5,2255.5391,1050.5,2259.5391,1060.5,2263.5391,1056.5,2259.5391" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1056.5" y="2241.4731">AUTHENTICATION-29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1208.5" y="2241.4731">this.saveToKVS({key: '1a2b3c4d'})</text><polygon fill="#A80036" points="2022.5,2284.6719,2032.5,2288.6719,2022.5,2292.6719,2026.5,2288.6719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1049.5" x2="2028.5" y1="2288.6719" y2="2288.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1056.5" y="2283.606">AUTHENTICATION-30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1208.5" y="2283.606">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#fb3rrkwf3cfs0)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1054" y="2301.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1058" y="2317.7388">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1058" y="2332.8716">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1058" y="2348.0044">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1058" y="2363.1372">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1066" y="2378.27">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1074" y="2393.4028">address: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1074" y="2408.5356">actions: ['ACCOUNTS_GET_BALANCE', 'ACCOUNTS_TRANSFER'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1074" y="2423.6685">address: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1074" y="2438.8013">actions: ['ACCOUNTS_GET_BALANCE', 'ACCOUNTS_TRANSFER'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1066" y="2453.9341">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="1066" y="2469.0669">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1074" y="2484.1997">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="1074" y="2499.3325">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="1074" y="2514.4653">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1066" y="2529.5981">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1058" y="2544.731">}</text><polygon fill="#A80036" points="1055.5,2573.9297,1045.5,2577.9297,1055.5,2581.9297,1051.5,2577.9297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1049.5" x2="2033.5" y1="2577.9297" y2="2577.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1061.5" y="2572.8638">AUTHENTICATION-31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1213.5" y="2572.8638">202 Accepted</text><polygon fill="#A80036" points="2433.5,2603.0625,2443.5,2607.0625,2433.5,2611.0625,2437.5,2607.0625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2044.5" x2="2439.5" y1="2607.0625" y2="2607.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2051.5" y="2601.9966">AUTHENTICATION-32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2203.5" y="2601.9966">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2455.5" x2="2497.5" y1="2636.1953" y2="2636.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2497.5" x2="2497.5" y1="2636.1953" y2="2649.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2456.5" x2="2497.5" y1="2649.1953" y2="2649.1953"/><polygon fill="#A80036" points="2466.5,2645.1953,2456.5,2649.1953,2466.5,2653.1953,2462.5,2649.1953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2462.5" y="2631.1294">AUTHENTICATION-33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="2614.5" y="2631.1294">const model = await loadFromKVS({key: 1a2b3c4d})</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="201" x="2460" y="2662.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="2464" y="2678.2622">state: signedConsentReceived</text><polygon fill="#A80036" points="2949.5,2707.4609,2959.5,2711.4609,2949.5,2715.4609,2953.5,2711.4609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2455.5" x2="2955.5" y1="2711.4609" y2="2711.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2462.5" y="2706.395">AUTHENTICATION-34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="2614.5" y="2706.395">model.validateSignedConsent()</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="264" x="2460" y="2724.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="2464" y="2740.5278">state: pendingRegistrationAndValidation</text><polygon fill="#A80036" points="2050.5,2769.7266,2040.5,2773.7266,2050.5,2777.7266,2046.5,2773.7266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="2449.5" y1="2773.7266" y2="2773.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2056.5" y="2768.6606">AUTHENTICATION-35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2208.5" y="2768.6606">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2971.5" x2="3013.5" y1="2802.8594" y2="2802.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3013.5" x2="3013.5" y1="2802.8594" y2="2815.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2972.5" x2="3013.5" y1="2815.8594" y2="2815.8594"/><polygon fill="#A80036" points="2982.5,2811.8594,2972.5,2815.8594,2982.5,2819.8594,2978.5,2815.8594" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2978.5" y="2797.7935">AUTHENTICATION-36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3130.5" y="2797.7935">Check signed consent.</text><rect fill="#ADD8E6" filter="url(#fb3rrkwf3cfs0)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="530" x="2976" y="2828.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="522" x="2980" y="2844.9263">Does this need a backend request or can the SDK check the consent.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="2984" y="2860.0591"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="462" x="2980" y="2875.1919">Yes and No. We're keeping it as this for now (default to just talking to the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="488" x="2980" y="2890.3247">auth service), but ideally we would open up a config option that would allow a</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="481" x="2980" y="2905.4575">DFSP to specify whether or not the DFSP Backend should receive a callback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="366" x="2980" y="2920.5903">asking them to validate the credential before proceeding.</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="313" x="2976" y="2937.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="305" x="2980" y="2953.7231">Something went wrong in checking the consent.</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="2976" y="2970.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2980" y="2986.856">state: errored</text><polygon fill="#A80036" points="2055.5,3016.0547,2045.5,3020.0547,2055.5,3024.0547,2051.5,3020.0547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2049.5" x2="2960.5" y1="3020.0547" y2="3020.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2061.5" y="3014.9888">AUTHENTICATION-37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="2213.5" y="3014.9888">PUT /consents/1a2b3c4d/error</text><rect fill="#F08080" filter="url(#fb3rrkwf3cfs0)" height="204" style="stroke:#A80036;stroke-width:1.0;" width="471" x="2485" y="3033.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="2489" y="3049.1216">PUT /consents/1a2b3c4d/error</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="2489" y="3064.2544">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="2489" y="3079.3872">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2489" y="3094.52">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2497" y="3109.6528">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2505" y="3124.7856">errorCode: '7200',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="368" x="2505" y="3139.9185">errorDescription: 'Generic Thirdparty account linking error'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2497" y="3155.0513">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2497" y="3170.1841">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2505" y="3185.3169">errorCode: '7212',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="447" x="2505" y="3200.4497">errorDescription: 'Signed challenge does not match derived challenge'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2497" y="3215.5825">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2489" y="3230.7153">}</text><polygon fill="#A80036" points="2954.5,3259.9141,2964.5,3263.9141,2954.5,3267.9141,2958.5,3263.9141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2044.5" x2="2960.5" y1="3263.9141" y2="3263.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2051.5" y="3258.8481">AUTHENTICATION-38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2203.5" y="3258.8481">200 OK</text><polygon fill="#A80036" points="1570.5,3289.0469,1560.5,3293.0469,1570.5,3297.0469,1566.5,3293.0469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1564.5" x2="2033.5" y1="3293.0469" y2="3293.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1576.5" y="3287.981">AUTHENTICATION-39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="1728.5" y="3287.981">PUT /consents/1a2b3c4d/error</text><polygon fill="#A80036" points="2027.5,3318.1797,2037.5,3322.1797,2027.5,3326.1797,2031.5,3322.1797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1559.5" x2="2033.5" y1="3322.1797" y2="3322.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1566.5" y="3317.1138">AUTHENTICATION-40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1718.5" y="3317.1138">200 OK</text><polygon fill="#A80036" points="1060.5,3347.3125,1050.5,3351.3125,1060.5,3355.3125,1056.5,3351.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1054.5" x2="1553.5" y1="3351.3125" y2="3351.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1066.5" y="3346.2466">AUTHENTICATION-41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="1218.5" y="3346.2466">MojaloopFSPIOPError response received</text><rect fill="#FBFB77" filter="url(#fb3rrkwf3cfs0)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="1054" y="3364.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1058" y="3380.3794">state: errored</text><polygon fill="#A80036" points="575.5,3409.5781,565.5,3413.5781,575.5,3417.5781,571.5,3413.5781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="569.5" x2="1043.5" y1="3413.5781" y2="3413.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="581.5" y="3408.5122">AUTHENTICATION-42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="733.5" y="3408.5122">return MojaloopFSPIOPError</text><polygon fill="#A80036" points="72.5,3438.7109,62.5,3442.7109,72.5,3446.7109,68.5,3442.7109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="66.5" x2="558.5" y1="3442.7109" y2="3442.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="78.5" y="3437.645">AUTHENTICATION-43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="258" x="230.5" y="3437.645">400 Bad Request ErrorInformationObject</text><!--MD5=[1bcb95ba2dceaf980bff314df01fb84d]
@startuml

title PISP Linking Error Scenarios Grant Consent Phase - 1

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
    participant "Auth Service" as AUTH
    participant "Account Lookup Service" as ALS
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box
participant DFSPAuthorizeSimulator

== Authentication+Grant Consent ==
autonumber 1 "<b>AUTHENTICATION-#</b>"
rnote right of PISP
PISP has obtained authToken from end-user(OTP) or through a callback(Web).
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent/6789/authenticate
rnote right of PISP #LightBlue
POST /linking/request-consent/6789/authenticate
{
  authToken: '123456'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS({key: 6789})
rnote right of PISP_TP_OUT: state: webAuthenticationChannelResponseReceived or OTPAuthenticationChannelResponseReceived
PISP_TP_OUT -> PISP_LM: model.authenticate()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.patchConsentRequests()
PISP_LM -> Switch: PATCH /consentRequests/6789
rnote right of PISP_LM #LightBlue
PATCH /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  authToken: '124356'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PATCH /consentRequests/6789
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 6789})
rnote right of DFSP_TP_IN: state: consentRequestValidatedAndStored
DFSP_TP_IN -> DFSP_LM: model.validateAuthToken()
deactivate DFSP_TP_IN
activate DFSP_LM

DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateAuthToken()
rnote right of DFSP_LM #LightBlue
Do we need two backend endpoints for validating
web authTokens and OTP authTokens? Or is a DFSP expected to
validate both cases with one endpoint?

POST /validateAuthToken
{
  consentRequestId: '6789'
  authChannel: model.data.authChannel,
  authToken: '124356'
}
end note
rnote right of DFSP_LM: state: authTokenValidated

DFSP_LM -> DFSP_LM: const consentId = uuid()
DFSP_LM -> DFSP_LM: model.grantConsent()
DFSP_LM -> DFSP_LM: ThirdpartyRequests.postConsents()
rnote right of DFSP_LM: state: consentGranted
rnote right of DFSP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
DFSP_LM -> DFSP_LM: this.saveToKVS({key: '1a2b3c4d'})

DFSP_LM -> Switch: POST /consents
activate Switch

rnote left of DFSP_LM #LightBlue
POST /consents
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  consentId: 1a2b3c4d
  consentRequestId: 6789
  scopes: model.data.scopes
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
Switch ->  PISP_TP_IN: POST /consents
activate PISP_TP_IN
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 6789})
PISP_TP_IN -> PISP_LM: model.consentReceivedAwaitCredential()
activate PISP_LM
PISP_LM - -> PISP_LM: const challenge = deriveChallenge(consentRequest)
PISP_TP_IN - -> Switch: 202 Accepted
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: consentReceivedAwaitingCredential
PISP_LM -> PISP_TP_OUT: return Model state and challenge
deactivate PISP_LM
PISP_TP_OUT -> PISP: 200 OK Model State and challenge
rnote left of PISP_TP_OUT #LightBlue
{
  currentState: "consentReceivedAwaitingCredential"
  challenge: challenge
}
end note

rnote right of PISP
PISP has obtained credential from the end-user
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent/6789/authenticate
rnote right of PISP #LightBlue
POST /linking/request-consent/6789/pass-credential
{
  credential: {
    payload: PublicKeyCredential
  }
}
end note
PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS({key: 6789})
PISP_TP_OUT -> PISP_LM: model.registerCredential()
activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.putConsents()
rnote right of PISP_LM: state: signedConsentSent
rnote right of PISP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
PISP_LM - -> PISP_LM: this.saveToKVS({key: '1a2b3c4d'})
PISP_LM -> Switch: PUT /consents/1a2b3c4d
activate Switch

rnote right of PISP_LM #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  scopes: [{
    address: 'dfspa.username.1234',
    actions: ['ACCOUNTS_GET_BALANCE', 'ACCOUNTS_TRANSFER'],
    address: 'dfspa.username.5678',
    actions: ['ACCOUNTS_GET_BALANCE', 'ACCOUNTS_TRANSFER'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
activate DFSP_TP_IN

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
rnote right of DFSP_TP_IN: state: signedConsentReceived
DFSP_TP_IN -> DFSP_LM: model.validateSignedConsent()
activate DFSP_LM
rnote right of DFSP_TP_IN: state: pendingRegistrationAndValidation
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: Check signed consent.
rnote right of DFSP_LM #LightBlue
Does this need a backend request or can the SDK check the consent.

Yes and No. We're keeping it as this for now (default to just talking to the
auth service), but ideally we would open up a config option that would allow a
DFSP to specify whether or not the DFSP Backend should receive a callback
asking them to validate the credential before proceeding.
end note

rnote right of DFSP_LM: Something went wrong in checking the consent.
rnote right of DFSP_LM: state: errored
DFSP_LM -> Switch: PUT /consents/1a2b3c4d/error
activate Switch

rnote left of DFSP_LM #LightCoral
PUT /consents/1a2b3c4d/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '7200',
    errorDescription: 'Generic Thirdparty account linking error'
  } OR
  errorInformation: {
    errorCode: '7212',
    errorDescription: 'Signed challenge does not match derived challenge'
  }
}
end note
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consents/1a2b3c4d/error
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
PISP_TP_IN - -> PISP_LM: MojaloopFSPIOPError response received
deactivate PISP_TP_IN
activate PISP_LM
rnote right of PISP_LM: state: errored
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 400 Bad Request ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP
@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
