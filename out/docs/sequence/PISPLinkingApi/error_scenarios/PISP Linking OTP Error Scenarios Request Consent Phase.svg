<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1858px" preserveAspectRatio="none" style="width:3117px;height:1858px;" version="1.1" viewBox="0 0 3117 1858" width="3117px" zoomAndPan="magnify"><defs><filter height="300%" id="f1ocngoyft4dsx" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="506" x="1302.25" y="28.708">PISP Linking OTP Error Scenarios Request Consent Phase</text><rect fill="#DDDDDD" height="1811.2188" style="stroke:#A80036;stroke-width:1.0;" width="972.5" x="497.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="893.75" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="1811.2188" style="stroke:#A80036;stroke-width:1.0;" width="379" x="1779" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="1935" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="1811.2188" style="stroke:#A80036;stroke-width:1.0;" width="519" x="2160" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="2326.5" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="1593.0938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="56.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="1593.0938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="563.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="402.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="940.5" y="461.375"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="940.5" y="1704.4766"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1399.5" y="1646.2109"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="347.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1809.5" y="574.7734"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="544.25" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1809.5" y="1131.0938"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2220.5" y="893.1641"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="590.3828" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2597.5" y="1026.6953"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="61" x2="61" y1="95.3828" y2="1813.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="568.5" x2="568.5" y1="95.3828" y2="1813.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="945.5" x2="945.5" y1="95.3828" y2="1813.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1404" x2="1404" y1="95.3828" y2="1813.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1814" x2="1814" y1="95.3828" y2="1813.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1908" x2="1908" y1="95.3828" y2="1813.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2062" x2="2062" y1="95.3828" y2="1813.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2225" x2="2225" y1="95.3828" y2="1813.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2602" x2="2602" y1="95.3828" y2="1813.875"/><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="12" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="5" y="1812.875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="12" y="1832.8701">PISP Backend</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="501.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="508.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="501.5" y="1812.875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="508.5" y="1832.8701">outbound-server</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="876.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="883.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="876.5" y="1812.875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="883.5" y="1832.8701">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1343" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1350" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1343" y="1812.875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1350" y="1832.8701">inbound-server</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="1783" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="1790" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="1783" y="1812.875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="1790" y="1832.8701">Switch</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="1856" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="1863" y="80.0811">Auth Service</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="1856" y="1812.875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="1863" y="1832.8701">Auth Service</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="1970" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="1977" y="80.0811">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="1970" y="1812.875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="1977" y="1832.8701">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="2164" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2171" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="2164" y="1812.875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2171" y="1832.8701">inbound-server</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="2530" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="2537" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1ocngoyft4dsx)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="2530" y="1812.875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="2537" y="1832.8701">DFSPLinkingModel</text><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="1593.0938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="56.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="1593.0938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="563.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="402.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="940.5" y="461.375"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="940.5" y="1704.4766"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1399.5" y="1646.2109"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="347.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1809.5" y="574.7734"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="544.25" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1809.5" y="1131.0938"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2220.5" y="893.1641"/><rect fill="#FFFFFF" filter="url(#f1ocngoyft4dsx)" height="590.3828" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2597.5" y="1026.6953"/><rect fill="#EEEEEE" filter="url(#f1ocngoyft4dsx)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="3110.5" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3110.5" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3110.5" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#f1ocngoyft4dsx)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="189" x="1460.75" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="170" x="1466.75" y="131.4497">Request Consent - OTP</text><rect fill="#FBFB77" filter="url(#f1ocngoyft4dsx)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="485" x="66" y="153.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="70" y="169.5825">PISP presents accounts to user. User selects one or more accounts to link.</text><polygon fill="#A80036" points="551.5,198.7813,561.5,202.7813,551.5,206.7813,555.5,202.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="66.5" x2="557.5" y1="202.7813" y2="202.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="73.5" y="197.7153">REQUEST-CONSENT-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="231.5" y="197.7153">POST /linking/request-consent</text><rect fill="#ADD8E6" filter="url(#f1ocngoyft4dsx)" height="144" style="stroke:#A80036;stroke-width:1.0;" width="570" x="71" y="215.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="75" y="231.8481">POST /linking/request-consent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="246.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="83" y="262.1138">accounts: [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="91" y="277.2466">{ accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="546" x="91" y="292.3794">{ accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="83" y="307.5122">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="541" x="83" y="322.645">userId: "username1234", // so the dfsp can associate this request with GET /accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="83" y="337.7778">callbackURI: 'pisp-app://callback'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="352.9106">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="573.5" x2="615.5" y1="386.1094" y2="386.1094"/><line style="stroke:#A80036;stroke-width:1.0;" x1="615.5" x2="615.5" y1="386.1094" y2="399.1094"/><line style="stroke:#A80036;stroke-width:1.0;" x1="574.5" x2="615.5" y1="399.1094" y2="399.1094"/><polygon fill="#A80036" points="584.5,395.1094,574.5,399.1094,584.5,403.1094,580.5,399.1094" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="580.5" y="381.0435">REQUEST-CONSENT-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="738.5" y="381.0435">const model = await create()</text><rect fill="#FBFB77" filter="url(#f1ocngoyft4dsx)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="578" y="412.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="582" y="428.1763">state: start</text><polygon fill="#A80036" points="928.5,457.375,938.5,461.375,928.5,465.375,932.5,461.375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="573.5" x2="934.5" y1="461.375" y2="461.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="580.5" y="456.3091">REQUEST-CONSENT-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="738.5" y="456.3091">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="950.5" x2="992.5" y1="490.5078" y2="490.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="992.5" y1="490.5078" y2="503.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="951.5" x2="992.5" y1="503.5078" y2="503.5078"/><polygon fill="#A80036" points="961.5,499.5078,951.5,503.5078,961.5,507.5078,957.5,503.5078" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="957.5" y="485.4419">REQUEST-CONSENT-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1115.5" y="485.4419">ThirdpartyRequests.postConsentRequests()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="950.5" x2="992.5" y1="532.6406" y2="532.6406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="992.5" y1="532.6406" y2="545.6406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="951.5" x2="992.5" y1="545.6406" y2="545.6406"/><polygon fill="#A80036" points="961.5,541.6406,951.5,545.6406,961.5,549.6406,957.5,545.6406" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="957.5" y="527.5747">REQUEST-CONSENT-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="1115.5" y="527.5747">const consentRequestId = uuid()</text><polygon fill="#A80036" points="1797.5,570.7734,1807.5,574.7734,1797.5,578.7734,1801.5,574.7734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="950.5" x2="1803.5" y1="574.7734" y2="574.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="957.5" y="569.7075">REQUEST-CONSENT-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1115.5" y="569.7075">POST /consentRequests</text><rect fill="#ADD8E6" filter="url(#f1ocngoyft4dsx)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="955" y="587.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="959" y="603.8403">POST /consentRequests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="959" y="618.9731">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="959" y="634.106">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="959" y="649.2388">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="967" y="664.3716">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="967" y="679.5044">userId: "username1234",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="967" y="694.6372">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="975" y="709.77">address: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="975" y="724.9028">actions: ['ACCOUNTS_GET_BALANCE', 'ACCOUNTS_TRANSFER'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="975" y="740.0356">address: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="975" y="755.1685">actions: ['ACCOUNTS_GET_BALANCE', 'ACCOUNTS_TRANSFER'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="967" y="770.3013">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="967" y="785.4341">// model will add `authChannels`</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="967" y="800.5669">authChannels: ["WEB", "OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216" x="967" y="815.6997">callbackURI: 'pisp-app://callback...'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="959" y="830.8325">}</text><polygon fill="#A80036" points="956.5,860.0313,946.5,864.0313,956.5,868.0313,952.5,864.0313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="950.5" x2="1808.5" y1="864.0313" y2="864.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="962.5" y="858.9653">REQUEST-CONSENT-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1120.5" y="858.9653">202 Accepted</text><polygon fill="#A80036" points="2208.5,889.1641,2218.5,893.1641,2208.5,897.1641,2212.5,893.1641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1819.5" x2="2214.5" y1="893.1641" y2="893.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1826.5" y="888.0981">REQUEST-CONSENT-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1984.5" y="888.0981">POST /consentRequests</text><polygon fill="#A80036" points="1825.5,918.2969,1815.5,922.2969,1825.5,926.2969,1821.5,922.2969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1819.5" x2="2219.5" y1="922.2969" y2="922.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1831.5" y="917.231">REQUEST-CONSENT-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1989.5" y="917.231">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2230.5" x2="2272.5" y1="951.4297" y2="951.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2272.5" x2="2272.5" y1="951.4297" y2="964.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2231.5" x2="2272.5" y1="964.4297" y2="964.4297"/><polygon fill="#A80036" points="2241.5,960.4297,2231.5,964.4297,2241.5,968.4297,2237.5,964.4297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2237.5" y="946.3638">REQUEST-CONSENT-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="2404.5" y="946.3638">const model = await create()</text><rect fill="#FBFB77" filter="url(#f1ocngoyft4dsx)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="2235" y="977.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="2239" y="993.4966">state: start</text><polygon fill="#A80036" points="2585.5,1022.6953,2595.5,1026.6953,2585.5,1030.6953,2589.5,1026.6953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2225.5" x2="2591.5" y1="1026.6953" y2="1026.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2232.5" y="1021.6294">REQUEST-CONSENT-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="2399.5" y="1021.6294">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2607.5" x2="2649.5" y1="1055.8281" y2="1055.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2649.5" x2="2649.5" y1="1055.8281" y2="1068.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2608.5" x2="2649.5" y1="1068.8281" y2="1068.8281"/><polygon fill="#A80036" points="2618.5,1064.8281,2608.5,1068.8281,2618.5,1072.8281,2614.5,1068.8281" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2614.5" y="1050.7622">REQUEST-CONSENT-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="2781.5" y="1050.7622">DFSPBackendRequests.validateConsentRequest()</text><rect fill="#FBFB77" filter="url(#f1ocngoyft4dsx)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="2612" y="1081.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2616" y="1097.895">state: errored</text><polygon fill="#A80036" points="1830.5,1127.0938,1820.5,1131.0938,1830.5,1135.0938,1826.5,1131.0938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1824.5" x2="2596.5" y1="1131.0938" y2="1131.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1836.5" y="1126.0278">REQUEST-CONSENT-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="2003.5" y="1126.0278">PUT /consentRequests/6789/error</text><rect fill="#F08080" filter="url(#f1ocngoyft4dsx)" height="446" style="stroke:#A80036;stroke-width:1.0;" width="531" x="2061" y="1144.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="2065" y="1160.1606">PUT /consentRequests/6789/error</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="2065" y="1175.2935">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="2065" y="1190.4263">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2065" y="1205.5591">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2073" y="1220.6919">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2081" y="1235.8247">errorCode: '7200',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="368" x="2081" y="1250.9575">errorDescription: 'Generic Thirdparty account linking error'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2073" y="1266.0903">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2073" y="1281.2231">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2081" y="1296.356">errorCode: '7203',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="2081" y="1311.4888">errorDescription: 'FSP does not support any requested authentication channels'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2073" y="1326.6216">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2073" y="1341.7544">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2081" y="1356.8872">errorCode: '7204',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="442" x="2081" y="1372.02">errorDescription: 'FSP does not support any requested scope actions'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2073" y="1387.1528">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2073" y="1402.2856">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2081" y="1417.4185">errorCode: '7209',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="331" x="2081" y="1432.5513">errorDescription: 'FSP does not find scopes suitable'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2073" y="1447.6841">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2073" y="1462.8169">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2081" y="1477.9497">errorCode: '7210',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="347" x="2081" y="1493.0825">errorDescription: 'FSP does not trust PISP callback URI'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2073" y="1508.2153">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2073" y="1523.3481">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2081" y="1538.481">errorCode: '7211',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="501" x="2081" y="1553.6138">errorDescription: 'FSP does not allow consent requests for specified username'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2073" y="1568.7466">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2065" y="1583.8794">}</text><polygon fill="#A80036" points="2590.5,1613.0781,2600.5,1617.0781,2590.5,1621.0781,2594.5,1617.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1819.5" x2="2596.5" y1="1617.0781" y2="1617.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1826.5" y="1612.0122">REQUEST-CONSENT-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1993.5" y="1612.0122">200 OK</text><polygon fill="#A80036" points="1420.5,1642.2109,1410.5,1646.2109,1420.5,1650.2109,1416.5,1646.2109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1414.5" x2="1808.5" y1="1646.2109" y2="1646.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1426.5" y="1641.145">REQUEST-CONSENT-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="1593.5" y="1641.145">PUT /consentRequests/6789/error</text><polygon fill="#A80036" points="1802.5,1671.3438,1812.5,1675.3438,1802.5,1679.3438,1806.5,1675.3438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1409.5" x2="1808.5" y1="1675.3438" y2="1675.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1416.5" y="1670.2778">REQUEST-CONSENT-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1583.5" y="1670.2778">200 OK</text><polygon fill="#A80036" points="961.5,1700.4766,951.5,1704.4766,961.5,1708.4766,957.5,1704.4766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="955.5" x2="1403.5" y1="1704.4766" y2="1704.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="967.5" y="1699.4106">REQUEST-CONSENT-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="1134.5" y="1699.4106">MojaloopFSPIOPError response received</text><rect fill="#FBFB77" filter="url(#f1ocngoyft4dsx)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="955" y="1717.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="959" y="1733.5435">state: errored</text><polygon fill="#A80036" points="584.5,1762.7422,574.5,1766.7422,584.5,1770.7422,580.5,1766.7422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="944.5" y1="1766.7422" y2="1766.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="590.5" y="1761.6763">REQUEST-CONSENT-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="757.5" y="1761.6763">return MojaloopFSPIOPError</text><polygon fill="#A80036" points="72.5,1791.875,62.5,1795.875,72.5,1799.875,68.5,1795.875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="66.5" x2="567.5" y1="1795.875" y2="1795.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="78.5" y="1790.8091">REQUEST-CONSENT-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="245.5" y="1790.8091">500 Internal Server Error ErrorInformationObject</text><!--MD5=[33576c7b0a2e126774dd552b013a49cb]
@startuml

title PISP Linking OTP Error Scenarios Request Consent Phase

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
    participant "Auth Service" as AUTH
    participant "Account Lookup Service" as ALS
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box

== Request Consent - OTP ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  accounts: [
    { accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },
    { accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }
  ],
  userId: "username1234", // so the dfsp can associate this request with GET /accounts
  callbackURI: 'pisp-app://callback'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
rnote right of PISP_TP_OUT: state: start
PISP_TP_OUT -> PISP_LM: model.requestConsent()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> PISP_LM: const consentRequestId = uuid()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  userId: "username1234",
  scopes: [{
    address: 'dfspa.username.1234',
    actions: ['ACCOUNTS_GET_BALANCE', 'ACCOUNTS_TRANSFER'],
    address: 'dfspa.username.5678',
    actions: ['ACCOUNTS_GET_BALANCE', 'ACCOUNTS_TRANSFER'],
  }],
  // model will add `authChannels`
  authChannels: ["WEB", "OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
DFSP_TP_IN -> DFSP_TP_IN: const model = await create()
rnote right of DFSP_TP_IN: state: start
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
deactivate DFSP_TP_IN
activate DFSP_LM
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()
rnote right of DFSP_LM: state: errored
DFSP_LM -> Switch: PUT /consentRequests/6789/error
activate Switch

rnote left of DFSP_LM #LightCoral
PUT /consentRequests/6789/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '7200',
    errorDescription: 'Generic Thirdparty account linking error'
  } OR
  errorInformation: {
    errorCode: '7203',
    errorDescription: 'FSP does not support any requested authentication channels'
  } OR
  errorInformation: {
    errorCode: '7204',
    errorDescription: 'FSP does not support any requested scope actions'
  } OR
  errorInformation: {
    errorCode: '7209',
    errorDescription: 'FSP does not find scopes suitable'
  } OR
  errorInformation: {
    errorCode: '7210',
    errorDescription: 'FSP does not trust PISP callback URI'
  } OR
  errorInformation: {
    errorCode: '7211',
    errorDescription: 'FSP does not allow consent requests for specified username'
  }
}
end note
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consentRequests/6789/error
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
PISP_TP_IN - -> PISP_LM: MojaloopFSPIOPError response received
deactivate PISP_TP_IN
activate PISP_LM
rnote right of PISP_LM: state: errored
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP

@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
